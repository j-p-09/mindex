<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MINDEX - Evidenčni sistem odsotnosti</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--accent:#2b6cb0;--danger:#d9534f}
    body{font-family:Inter,Segoe UI,Arial;margin:0;background:var(--bg);color:#111}
    .container{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 4px 14px rgba(15,15,20,0.06)}
    .row{display:flex;gap:12px}
    .col{flex:1}
    input,select,textarea,button{font-size:14px;padding:8px;border-radius:6px;border:1px solid #ddd}
    nav{display:flex;gap:10px}
    nav button{background:transparent;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    nav button.active{background:var(--accent);color:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px solid #eee;text-align:left}
    .small{font-size:13px;color:#666}
    .list{max-height:320px;overflow:auto}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    .btn.secondary{background:#6c757d}
    .btn.danger{background:var(--danger)}
    .inline{display:inline-block}
    .grid9{display:grid;grid-template-columns:repeat(9,1fr);gap:6px}
    .hour-label{font-size:12px;text-align:center;padding:6px}
    .hour-cell{height:64px;display:flex;align-items:center;justify-content:center;border-radius:6px;border:1px dashed #ddd;cursor:pointer}
    .crossed{text-decoration:line-through;color:#999}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center}
    .modal .panel{width:720px;background:white;padding:14px;border-radius:10px}
    .tag-red{color:crimson;font-weight:700}
    .tag-black{font-weight:700}
    .tiny{font-size:12px}
    textarea{min-height:80px}
    .mb{margin-bottom:10px}
  </style>
</head>
<body>
  <div class="container">
    <div id="app"></div>
  </div>

  <template id="login-tpl">
    <div class="card">
      <header style="display:flex;justify-content:space-between;align-items:center">
        <h1>MINDEX — Evidenčni sistem odsotnosti</h1>
        <div class="small">Za test: up.ime: <b>ADMIN</b> geslo: <b>ADMIN</b></div>
      </header>
      <hr>
      <div style="max-width:420px;margin:0 auto">
        <div class="mb">
          <label>Uporabniško ime</label>
          <input id="loginUser" />
        </div>
        <div class="mb">
          <label>Geslo</label>
          <input id="loginPass" type="password" />
        </div>
        <div style="text-align:right">
          <button id="btnLogin" class="btn">Prijava</button>
        </div>
      </div>
    </div>
  </template>

  <template id="admin-tpl">
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2>ADMIN</h2>
        <div>
          <span class="small">Prijavljen kot: <b id="whoadmin"></b></span>
          <button id="logout" style="margin-left:8px" class="btn secondary">Odjava</button>
        </div>
      </div>

      <div class="card mb">
        <nav id="adminNav"></nav>
      </div>

      <div id="adminMain"></div>
    </div>
  </template>

  <template id="teachers-tpl">
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>UČITELJI</h3>
        <div>
          <button id="btnAddTeacher" class="btn">Dodaj učitelja</button>
        </div>
      </div>
      <div class="card">
        <div class="list" id="teachersList"></div>
      </div>
    </div>
  </template>

  <template id="students-tpl">
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>UČENCI</h3>
        <div>
          <button id="btnAddStudent" class="btn">Dodaj učenca</button>
        </div>
      </div>
      <div class="card">
        <div class="list" id="studentsList"></div>
      </div>
    </div>
  </template>

  <template id="classes-tpl">
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>RAZREDI</h3>
        <div>
          <button id="btnAddClass" class="btn">Dodaj razred</button>
        </div>
      </div>
      <div class="card">
        <div id="classesList"></div>
      </div>
    </div>
  </template>

  <template id="schedules-tpl">
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>URNIKI</h3>
      </div>
      <div class="card mb">
        <div class="row">
          <div class="col">
            <label>Izberi učitelja</label>
            <select id="selTeacherForSchedule"></select>
          </div>
          <div class="col">
            <label>Datum</label>
            <input id="scheduleDate" type="date" />
          </div>
          <div style="display:flex;align-items:flex-end;gap:8px">
            <button id="btnLoadSchedule" class="btn">Ustvari/Prikaži</button>
            <button id="btnSaveSchedule" class="btn secondary">Shrani urnik</button>
          </div>
        </div>
      </div>
      <div id="scheduleEditor" class="card"></div>
    </div>
  </template>

  <!-- modal placeholder -->
  <div id="modalRoot"></div>

  <script>
  // ---------- LocalStorage helpers ----------
  const LS = {
    get(k, fallback){try{return JSON.parse(localStorage.getItem(k))||fallback}catch(e){return fallback}},
    set(k,v){localStorage.setItem(k,JSON.stringify(v))}
  }

  // Initialize default DB
  function initDB(){
    if(!localStorage.getItem('m_users')){
      LS.set('m_users',[{username:'ADMIN',password:'ADMIN',role:'admin',display:'ADMIN'}]);
    }
    if(!localStorage.getItem('m_teachers')) LS.set('m_teachers',[]);
    if(!localStorage.getItem('m_students')) LS.set('m_students',[]);
    if(!localStorage.getItem('m_classes')) LS.set('m_classes',[]);
    if(!localStorage.getItem('m_schedules')) LS.set('m_schedules',{}); // key: teacherId|date -> array 1..9
    if(!localStorage.getItem('m_attendance')) LS.set('m_attendance',{}); // key teacher|date -> {hour: [{studentId,excused:boolean,addedAt}]}
    if(!localStorage.getItem('m_lessons')) LS.set('m_lessons',{}); // key teacher|date -> {hour: text}
  }

  initDB();

  // Utils
  function uid(prefix='id'){return prefix+Math.random().toString(36).slice(2,9)}

  // Application state
  let STATE = {user:null}

  // Render app
  const app = document.getElementById('app');

  function showLogin(){
    app.innerHTML = document.getElementById('login-tpl').innerHTML;
    document.getElementById('btnLogin').onclick = doLogin;
  }

  function doLogin(){
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value;
    const users = LS.get('m_users',[]);
    const found = users.find(x=>x.username===u && x.password===p);
    if(found){ STATE.user = found; renderApp(); } else alert('Napačno uporabniško ime ali geslo');
  }

  function logout(){ STATE.user=null; showLogin(); }

  // ---------- ADMIN UI ----------
  function renderApp(){
    if(!STATE.user) return showLogin();
    if(STATE.user.role==='admin') renderAdmin();
    else if(STATE.user.role==='teacher') renderTeacherHome();
  }

  function renderAdmin(){
    app.innerHTML = document.getElementById('admin-tpl').innerHTML;
    document.getElementById('whoadmin').textContent = STATE.user.display || STATE.user.username;
    document.getElementById('logout').onclick = logout;
    const nav = document.getElementById('adminNav');
    const pages = ['DOMOV','UČITELJI','UČENCI','RAZRED','URNIKI'];
    pages.forEach((p,i)=>{
      const btn = document.createElement('button'); btn.textContent=p; if(i===0) btn.classList.add('active');
      btn.onclick = ()=>{Array.from(nav.children).forEach(n=>n.classList.remove('active')); btn.classList.add('active'); renderAdminPage(p)};
      nav.appendChild(btn);
    });
    renderAdminPage('DOMOV');
  }

  function renderAdminPage(page){
    const main = document.getElementById('adminMain'); main.innerHTML='';
    if(page==='DOMOV'){
      const card = document.createElement('div'); card.className='card'; card.innerHTML = '<h3>Dobrodošli, ADMIN</h3><p class="small">Uporabite meni zgoraj za upravljanje sistema.</p>';
      main.appendChild(card);
    }
    if(page==='UČITELJI'){
      main.innerHTML = document.getElementById('teachers-tpl').innerHTML;
      renderTeachersList();
      document.getElementById('btnAddTeacher').onclick = ()=>openTeacherEditor();
    }
    if(page==='UČENCI'){
      main.innerHTML = document.getElementById('students-tpl').innerHTML;
      renderStudentsList();
      document.getElementById('btnAddStudent').onclick = ()=>openStudentEditor();
    }
    if(page==='RAZRED'){
      main.innerHTML = document.getElementById('classes-tpl').innerHTML;
      renderClassesList();
      document.getElementById('btnAddClass').onclick = ()=>openClassEditor();
    }
    if(page==='URNIKI'){
      main.innerHTML = document.getElementById('schedules-tpl').innerHTML;
      populateTeacherSelectForSchedule();
      document.getElementById('btnLoadSchedule').onclick = loadScheduleEditor;
      document.getElementById('btnSaveSchedule').onclick = saveScheduleFromEditor;
    }
  }

  // Teachers CRUD
  function renderTeachersList(){
    const container = document.getElementById('teachersList');
    const teachers = LS.get('m_teachers',[]);
    container.innerHTML = '';
    const table = document.createElement('table');
    table.innerHTML = '<tr><th>Ime</th><th>Uporabnik</th><th>Akcije</th></tr>';
    teachers.forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.display}</td><td>${t.username||''}</td><td></td>`;
      const td = tr.querySelector('td:last-child');
      const btnEdit = document.createElement('button'); btnEdit.className='btn secondary inline'; btnEdit.textContent='Uredi'; btnEdit.onclick=()=>openTeacherEditor(t);
      const btnDel = document.createElement('button'); btnDel.className='btn danger inline'; btnDel.textContent='Briši'; btnDel.onclick=()=>{ if(confirm('Izbrišem učitelja?')){deleteTeacher(t.id); renderTeachersList();} };
      td.appendChild(btnEdit); td.appendChild(document.createTextNode(' ')); td.appendChild(btnDel);
      table.appendChild(tr);
    });
    container.appendChild(table);
  }
  function openTeacherEditor(t=null){
    openModal(`<h3>${t? 'Uredi učitelja':'Dodaj učitelja'}</h3>
      <div class="mb"><label>Polno ime</label><input id="te_name" value="${t?escapeHtml(t.display):''}"/></div>
      <div class="mb"><label>Uporabniško ime</label><input id="te_user" value="${t?escapeHtml(t.username):''}"/></div>
      <div class="mb"><label>Geslo</label><input id="te_pass" value="${t?escapeHtml(t.password):''}"/></div>
      <div style="text-align:right"><button id="saveTeacher" class="btn">Shrani</button></div>`);
    document.getElementById('saveTeacher').onclick = ()=>{
      const name=document.getElementById('te_name').value.trim(); const username=document.getElementById('te_user').value.trim(); const pass=document.getElementById('te_pass').value;
      if(!name||!username||!pass){alert('Izpolnite vsa polja');return}
      const teachers=LS.get('m_teachers',[]);
      if(t){ // edit
        const idx=teachers.findIndex(x=>x.id===t.id); teachers[idx].display=name; teachers[idx].username=username; teachers[idx].password=pass;
      }else{
        const id=uid('t'); teachers.push({id,display:name,username,password:pass});
        // also create user credential
        const users=LS.get('m_users',[]); users.push({username,password:pass,role:'teacher',display:name,teacherId:id}); LS.set('m_users',users);
      }
      LS.set('m_teachers',teachers); closeModal(); renderTeachersList();
    }
  }
  function deleteTeacher(id){
    let t=LS.get('m_teachers',[]).filter(x=>x.id!==id); LS.set('m_teachers',t);
    // remove linked user
    let users=LS.get('m_users',[]).filter(u=>u.teacherId!==id); LS.set('m_users',users);
  }

  // Students CRUD
  function renderStudentsList(){
    const container = document.getElementById('studentsList');
    const students = LS.get('m_students',[]);
    container.innerHTML = '';
    const table = document.createElement('table');
    table.innerHTML = '<tr><th>Ime in priimek</th><th>Razred</th><th>Akcije</th></tr>';
    students.forEach(s=>{
      const tr = document.createElement('tr');
      const className = s.classId ? (LS.get('m_classes',[]).find(c=>c.id===s.classId)||{}).name : '';
      tr.innerHTML = `<td>${s.name}</td><td>${className}</td><td></td>`;
      const td = tr.querySelector('td:last-child');
      const btnEdit = document.createElement('button'); btnEdit.className='btn secondary inline'; btnEdit.textContent='Uredi'; btnEdit.onclick=()=>openStudentEditor(s);
      const btnDel = document.createElement('button'); btnDel.className='btn danger inline'; btnDel.textContent='Briši'; btnDel.onclick=()=>{ if(confirm('Izbrišem učenca?')){deleteStudent(s.id); renderStudentsList();} };
      td.appendChild(btnEdit); td.appendChild(document.createTextNode(' ')); td.appendChild(btnDel);
      table.appendChild(tr);
    });
    container.appendChild(table);
  }
  function openStudentEditor(s=null){
    openModal(`<h3>${s? 'Uredi učenca':'Dodaj učenca'}</h3>
      <div class="mb"><label>Ime in priimek</label><input id="st_name" value="${s?escapeHtml(s.name):''}"/></div>
      <div class="mb"><label>Razred (lahko pusti prazno)</label>
        <select id="st_class"><option value="">-- brez --</option>${LS.get('m_classes',[]).map(c=>`<option value="${c.id}" ${s&&s.classId===c.id?'selected':''}>${escapeHtml(c.name)}</option>`).join('')}</select>
      </div>
      <div style="text-align:right"><button id="saveStudent" class="btn">Shrani</button></div>`);
    document.getElementById('saveStudent').onclick = ()=>{
      const name=document.getElementById('st_name').value.trim(); const classId=document.getElementById('st_class').value||null;
      if(!name){alert('Vpišite ime in priimek');return}
      const students=LS.get('m_students',[]);
      if(s){ const idx=students.findIndex(x=>x.id===s.id); students[idx].name=name; students[idx].classId=classId; }
      else{ students.push({id:uid('s'),name, classId}); }
      LS.set('m_students',students); closeModal(); renderStudentsList();
    }
  }
  function deleteStudent(id){ LS.set('m_students', LS.get('m_students',[]).filter(s=>s.id!==id)); }

  // Classes (RAZRED)
  function renderClassesList(){
    const container=document.getElementById('classesList'); container.innerHTML='';
    const classes = LS.get('m_classes',[]);
    const table=document.createElement('table'); table.innerHTML = '<tr><th>Naziv</th><th>Št. dijakov</th><th>Akcije</th></tr>';
    classes.forEach(c=>{
      const students = LS.get('m_students',[]).filter(s=>s.classId===c.id);
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.name}</td><td>${students.length}</td><td></td>`;
      const td=tr.querySelector('td:last-child');
      const btnEdit=document.createElement('button'); btnEdit.className='btn secondary'; btnEdit.textContent='Uredi'; btnEdit.onclick=()=>openClassEditor(c);
      const btnDel=document.createElement('button'); btnDel.className='btn danger'; btnDel.textContent='Briši'; btnDel.onclick=()=>{ if(confirm('Izbrišem razred?')){ deleteClass(c.id); renderClassesList(); } };
      td.appendChild(btnEdit); td.appendChild(document.createTextNode(' ')); td.appendChild(btnDel);
      table.appendChild(tr);
    });
    container.appendChild(table);
  }
  function openClassEditor(c=null){
    const studentsAll=LS.get('m_students',[]);
    openModal(`<h3>${c? 'Uredi razred':'Dodaj razred'}</h3>
      <div class="mb"><label>Ime razreda (npr. 1A)</label><input id="cl_name" value="${c?escapeHtml(c.name):''}"/></div>
      <div class="mb"><label>Seznam dijakov (vsak v svojo vrstico, ime priimek)</label>
        <textarea id="cl_students">${c? (studentsAll.filter(s=>s.classId===c.id).map(s=>escapeHtml(s.name)).join('\n')):''}</textarea>
      </div>
      <div style="text-align:right"><button id="saveClass" class="btn">Shrani</button></div>`);
    document.getElementById('saveClass').onclick = ()=>{
      const name=document.getElementById('cl_name').value.trim(); const txt=document.getElementById('cl_students').value.trim();
      if(!name){alert('Vnesite ime razreda');return}
      const classes=LS.get('m_classes',[]);
      if(c){ const idx=classes.findIndex(x=>x.id===c.id); classes[idx].name=name; }
      else{ classes.push({id:uid('c'),name}); }
      LS.set('m_classes',classes);
      // ensure students exist and assigned
      const lines = txt.split('\n').map(s=>s.trim()).filter(Boolean);
      const students = LS.get('m_students',[]);
      const classId = c? c.id : classes[classes.length-1].id;
      lines.forEach(line=>{
        // find or create
        let found = students.find(s=>s.name.toLowerCase()===line.toLowerCase());
        if(found){ found.classId = classId; }
        else { students.push({id:uid('s'),name:line,classId}); }
      });
      LS.set('m_students',students);
      closeModal(); renderClassesList();
    }
  }
  function deleteClass(id){
    // remove class and unassign students
    const classes=LS.get('m_classes',[]).filter(c=>c.id!==id); LS.set('m_classes',classes);
    const students=LS.get('m_students',[]).map(s=> s.classId===id? {...s,classId:null}:s); LS.set('m_students',students);
  }

  // Schedules (URNIKI)
  function populateTeacherSelectForSchedule(){
    const sel = document.getElementById('selTeacherForSchedule'); sel.innerHTML='';
    const teachers = LS.get('m_teachers',[]);
    teachers.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.display; sel.appendChild(opt); });
  }
  function loadScheduleEditor(){
    const teacherId = document.getElementById('selTeacherForSchedule').value; const date=document.getElementById('scheduleDate').value;
    if(!teacherId||!date){alert('Izberite učitelja in datum');return}
    const key = `${teacherId}|${date}`;
    const schedules = LS.get('m_schedules',{});
    const arr = schedules[key] || Array.from({length:9}).map(()=>null);
    renderScheduleEditor(teacherId,date,arr);
  }
  function renderScheduleEditor(teacherId,date,arr){
    const container=document.getElementById('scheduleEditor'); container.innerHTML='';
    const classes = LS.get('m_classes',[]);
    const selOptions = [{id:'P',name:'P (prosto)'}].concat(classes.map(c=>({id:c.id,name:c.name})));
    const grid = document.createElement('div');
    grid.innerHTML = '<h4>Urnik za '+ (LS.get('m_teachers',[]).find(t=>t.id===teacherId)||{}).display +' — '+date+'</h4>';
    const tbl = document.createElement('table'); tbl.innerHTML = '<tr>'+Array.from({length:9}).map((_,i)=>`<th class="hour-label">${i+1}</th>`).join('')+'</tr>';
    const row = document.createElement('tr');
    for(let i=0;i<9;i++){
      const td=document.createElement('td'); td.style.width='11%'; td.style.verticalAlign='top';
      const select = document.createElement('select'); select.dataset.hour = i+1;
      selOptions.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=o.name; select.appendChild(opt); });
      select.value = arr[i] ? arr[i] : 'P';
      td.appendChild(select);
      row.appendChild(td);
    }
    tbl.appendChild(row); grid.appendChild(tbl);
    const btnSave = document.createElement('button'); btnSave.className='btn'; btnSave.textContent='Shrani urnik'; btnSave.onclick = ()=>{
      const newArr = Array.from(tbl.querySelectorAll('select')).map(s=> s.value==='P'? null : s.value);
      const schedules = LS.get('m_schedules',{}); schedules[`${teacherId}|${date}`]=newArr; LS.set('m_schedules',schedules); alert('Urnik shranjen');
    };
    grid.appendChild(btnSave);
    container.appendChild(grid);
  }
  function saveScheduleFromEditor(){ loadScheduleEditor(); } // alias

  // ---------- Modal helpers ----------
  function openModal(html){
    const root = document.getElementById('modalRoot'); root.innerHTML = `<div class="modal" id="modalBox"><div class="panel">${html}<div style="text-align:right;margin-top:8px"><button id="closeModal" class="btn secondary">Zapri</button></div></div></div>`;
    document.getElementById('closeModal').onclick = closeModal;
  }
  function closeModal(){ document.getElementById('modalRoot').innerHTML=''; }

  function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

  // ---------- TEACHER UI ----------
  function renderTeacherHome(){
    // Show teacher dashboard with schedule selector and 9 columns
    app.innerHTML = `<div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2>Učitelj: ${STATE.user.display || STATE.user.username}</h2>
        <div>
          <button id="logoutt" class="btn secondary">Odjava</button>
        </div>
      </div>
      <div class="card mb">
        <div style="display:flex;gap:12px;align-items:flex-end">
          <div><label>Izberi datum</label><input id="teacherDate" type="date" /></div>
          <div><label>Izberi razred</label><select id="teacherClass"></select></div>
          <div><button id="loadTeacherSchedule" class="btn">Prikaži urnik</button></div>
          <div style="margin-left:auto"><button id="pastLessons" class="btn secondary">Pretekle ure</button></div>
          <div style="margin-left:8px"><button id="opraviči" class="btn">OPRAVIČI</button></div>
        </div>
      </div>
      <div class="card">
        <div id="teacherScheduleWrap"></div>
      </div>
    </div>`;
    document.getElementById('logoutt').onclick = ()=>{ STATE.user=null; showLogin(); };
    // populate classes select with classes that teacher has in any schedule or all classes
    const classes = LS.get('m_classes',[]);
    const sel = document.getElementById('teacherClass'); sel.innerHTML=''; classes.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.name; sel.appendChild(opt); });
    document.getElementById('loadTeacherSchedule').onclick = ()=>renderTeacherSchedule();
    document.getElementById('pastLessons').onclick = ()=>openPastLessons();
    document.getElementById('opraviči').onclick = ()=>openOpraviciPage();
  }

  function renderTeacherSchedule(){
    const teacher = LS.get('m_teachers',[]).find(t=>t.username===STATE.user.username) || LS.get('m_teachers',[]).find(t=>t.id===STATE.user.teacherId);
    if(!teacher){ alert('Ta uporabnik nima vezanega učitelja.'); return }
    const date = document.getElementById('teacherDate').value; const classId = document.getElementById('teacherClass').value;
    const key = `${teacher.id}|${date}`;
    const schedules = LS.get('m_schedules',{});
    const arr = schedules[key] || Array.from({length:9}).map(()=>null);
    const wrap = document.getElementById('teacherScheduleWrap'); wrap.innerHTML='';
    // header hours
    const header = document.createElement('div'); header.className='grid9'; header.style.marginBottom='8px';
    for(let i=0;i<9;i++){ const h=document.createElement('div'); h.className='hour-label card'; h.style.textAlign='center'; h.textContent = i+1; header.appendChild(h); }
    wrap.appendChild(header);
    // content row
    const content = document.createElement('div'); content.className='grid9';
    for(let i=0;i<9;i++){
      const cell = document.createElement('div'); cell.className='hour-cell card';
      const classVal = arr[i];
      const className = classVal ? (LS.get('m_classes',[]).find(c=>c.id===classVal)||{}).name : 'P';
      if(className==='P'){ cell.innerHTML = '<span class="crossed">P</span>' }
      else cell.textContent = className;
      cell.dataset.hour = i+1; cell.dataset.classid = classVal || '';
      cell.onclick = ()=>{ if(!classVal) return; openHourModal(teacher.id,date,i+1,classVal); };
      content.appendChild(cell);
    }
    wrap.appendChild(content);
  }

  // Modal for hour details and marking missing students
  function openHourModal(teacherId,date,hour,classId){
    const classObj = LS.get('m_classes',[]).find(c=>c.id===classId) || {name:'-'};
    const attendance = LS.get('m_attendance',{});
    const key = `${teacherId}|${date}`;
    if(!attendance[key]) attendance[key]={};
    if(!attendance[key][hour]) attendance[key][hour]=[]; // array of {studentId,excused,addedAt}
    const studentsInClass = LS.get('m_students',[]).filter(s=>s.classId===classId);
    // Build list of already recorded misses in any hour that day
    const allRecForDay = attendance[key];
    const statusLines = [];
    Object.keys(allRecForDay).forEach(h=>{
      allRecForDay[h].forEach(rec=>{
        statusLines.push({studentId:rec.studentId, hour:h, excused:rec.excused});
      });
    });
    // unique map
    const studentMap = {};
    statusLines.forEach(s=>{ if(!studentMap[s.studentId]) studentMap[s.studentId]=[]; studentMap[s.studentId].push(s.hour); });

    const modalHtml = `
      <h3>Datum: ${date} — Razred: ${classObj.name} — Ura: ${hour}</h3>
      <div class="mb"><strong>MANKAJOČI DIJAKI</strong></div>
      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <div class="small">Seznam dijakov razreda (klik za označitev)</div>
          <div class="list" style="max-height:220px;overflow:auto;margin-top:6px">${studentsInClass.map(s=>`<div style="padding:6px;border-bottom:1px solid #eee"><button data-stid="${s.id}" class="btn smallbtn" style="margin-right:8px">+</button>${escapeHtml(s.name)} <span class="tiny" style="margin-left:8px;color:#666">${studentMap[s.id]?(' (že prijavljen:'+studentMap[s.id].join(',' )+')') : ''}</span></div>`).join('')}</div>
        </div>
        <div style="width:40%">
          <div class="small">Izbrani (manjkajoči) dijaki</div>
          <div id="selectedMissing" style="min-height:140px;border:1px solid #eee;padding:8px;margin-top:6px"></div>
          <div class="mb" style="margin-top:8px"><label>Vsebina ure</label><textarea id="lessonContent"></textarea></div>
          <div style="text-align:right"><button id="saveHour" class="btn">Shrani uro</button></div>
        </div>
      </div>
    `;
    openModal(modalHtml);
    // attach events for selecting students
    document.querySelectorAll('[data-stid]').forEach(btn=>{
      btn.onclick = ()=>{
        const sid = btn.dataset.stid; const student = LS.get('m_students',[]).find(s=>s.id===sid);
        addMissingStudentToBox(sid, student.name, hour);
      }
    });
    // populate already missing for this hour
    const att = LS.get('m_attendance',{});
    const curList = att[key] && att[key][hour] ? att[key][hour] : [];
    curList.forEach(rec=> addMissingStudentToBox(rec.studentId, (LS.get('m_students',[]).find(s=>s.id===rec.studentId)||{}).name, hour, rec.excused) );
    // load lesson content
    const lessons = LS.get('m_lessons',{}); const lkey = `${teacherId}|${date}`; document.getElementById('lessonContent').value = (lessons[lkey] && lessons[lkey][hour]) ? lessons[lkey][hour] : '';
    document.getElementById('saveHour').onclick = ()=>{
      // gather selected missing students from box
      const box = document.getElementById('selectedMissing'); const rows = Array.from(box.querySelectorAll('.missing-row'));
      const newRecs = rows.map(r=>({studentId:r.dataset.sid, excused: r.dataset.excused==='true', addedAt: new Date().toISOString()}));
      const att2 = LS.get('m_attendance',{}); if(!att2[key]) att2[key]={}; att2[key][hour]=newRecs; LS.set('m_attendance',att2);
      // save lesson text
      const lessons2 = LS.get('m_lessons',{}); if(!lessons2[lkey]) lessons2[lkey] = {}; lessons2[lkey][hour] = document.getElementById('lessonContent').value; LS.set('m_lessons',lessons2);
      alert('Ura shranjena'); closeModal(); renderTeacherSchedule();
    }
  }
  function addMissingStudentToBox(sid,name,hour,excused=false){
    const box = document.getElementById('selectedMissing');
    // prevent duplicates in box
    if(box.querySelector(`[data-sid="${sid}"]`)){
      // toggle to red if exists
      const node = box.querySelector(`[data-sid="${sid}"]`); node.dataset.excused = (!JSON.parse(node.dataset.excused)); node.querySelector('.name').className = node.dataset.excused==='true'? 'tag-red name':'tag-black name';
      return;
    }
    const div = document.createElement('div'); div.className='missing-row'; div.dataset.sid=sid; div.dataset.excused = excused? 'true':'false';
    div.style.padding='6px;border-bottom:1px solid #eee';
    div.innerHTML = `<span class="name ${excused? 'tag-black':'tag-red'}">${escapeHtml(name)}</span> <span class="tiny" style="margin-left:6px;color:#666">(${hour})</span> <button class="btn secondary" style="float:right">Odstrani</button>`;
    div.querySelector('button').onclick = ()=>div.remove();
    box.appendChild(div);
  }

  function openPastLessons(){
    const teacher = LS.get('m_teachers',[]).find(t=>t.username===STATE.user.username) || LS.get('m_teachers',[]).find(t=>t.id===STATE.user.teacherId);
    const lessons = LS.get('m_lessons',{});
    const keys = Object.keys(lessons).filter(k=>k.startsWith(teacher.id+'|'));
    let html = '<h3>Pretekle ure</h3>';
    if(keys.length===0) html += '<p class="small">Ni vpisanih ur.</p>';
    keys.forEach(k=>{
      const date=k.split('|')[1]; html += `<div style="margin-bottom:8px"><strong>${date}</strong><div>`;
      const data = lessons[k]; Object.keys(data).forEach(h=>{ html += `<div style="padding:6px;border-bottom:1px solid #eee">Ura ${h}: ${escapeHtml(data[h].slice(0,120))} <button data-key="${k}" data-hour="${h}" class="btn danger" style="float:right">Izbriši</button></div>` });
      html += '</div></div>';
    });
    openModal(html);
    document.querySelectorAll('[data-key]').forEach(b=> b.onclick = ()=>{
      const k=b.dataset.key; const h=b.dataset.hour; const lessons2 = LS.get('m_lessons',{}); if(lessons2[k]) delete lessons2[k][h]; LS.set('m_lessons',lessons2); alert('Izbrisano'); closeModal();
    });
  }

  // OPRAVIČI page for teacher
  function openOpraviciPage(){
    // show interface where teacher picks class and sees students with counts and can toggle excused/unexcused per recorded absence
    const classes = LS.get('m_classes',[]);
    const html = `<h3>OPRAVIČI</h3>
      <div class="mb"><label>Izberi razred</label><select id="opClass"><option value="">-- izberi --</option>${classes.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('')}</select></div>
      <div id="opContent"></div>`;
    openModal(html);
    document.getElementById('opClass').onchange = ()=>renderOpraviciContent(document.getElementById('opClass').value);
  }
  function renderOpraviciContent(classId){
    const students = LS.get('m_students',[]).filter(s=>s.classId===classId);
    const attendance = LS.get('m_attendance',{});
    const teacher = LS.get('m_teachers',[]).find(t=>t.username===STATE.user.username) || LS.get('m_teachers',[]).find(t=>t.id===STATE.user.teacherId);
    // collect all records for this teacher across all dates
    const records = {};
    Object.keys(attendance).forEach(k=>{ if(k.startsWith(teacher.id+'|')){
      const date = k.split('|')[1]; Object.keys(attendance[k]).forEach(h=>{ attendance[k][h].forEach(rec=>{
        if(!records[rec.studentId]) records[rec.studentId]=[]; records[rec.studentId].push({date,h,excused:rec.excused});
      })}) }});
    let html = '<div class="card">';
    if(students.length===0) html += '<p class="small">V tem razredu ni učencev.</p>';
    students.forEach(s=>{
      const recs = records[s.id]||[]; const excused = recs.filter(r=>r.excused).length; const total = recs.length;
      html += `<div style="padding:6px;border-bottom:1px solid #eee"><strong>${escapeHtml(s.name)}</strong> — <span class="small">opravičeno: ${excused} / skupno: ${total}</span>
        <div style="margin-top:6px">${recs.map((r,idx)=>`<div style="padding:4px">${r.date} ura ${r.h} — <select data-student="${s.id}" data-idx="${idx}"><option value="false" ${r.excused? '':'selected'}>neopravičen</option><option value="true" ${r.excused? 'selected':''}>opravičen</option></select></div>`).join('')}</div>
      </div>`;
    });
    html += '</div><div style="text-align:right;margin-top:8px"><button id="opSave" class="btn">Shrani spremembe</button></div>';
    document.getElementById('opContent').innerHTML = html;
    document.getElementById('opSave').onclick = ()=>{ // apply changes
      // naive approach: iterate attendance and update excused flags where class student
      const att = LS.get('m_attendance',{});
      Object.keys(att).forEach(k=>{ if(k.startsWith(teacher.id+'|')){
        Object.keys(att[k]).forEach(h=>{ att[k][h].forEach((rec,i)=>{
          const sel = document.querySelector(`[data-student="${rec.studentId}"][data-idx="${i}"]`);
          if(sel) rec.excused = sel.value==='true';
        })}) }});
      LS.set('m_attendance',att); alert('Shranjeno'); closeModal();
    }
  }

  // ---------- Boot ----------
  showLogin();
  </script>
</body>
</html>
