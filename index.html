<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINDEX - Šolski Informacijski Sistem</title>
    <style>
        /* --- GLOBALNI RETRO STIL (Windows 95/98) --- */
        :root {
            --win-teal: #008080;
            --win-gray: #c0c0c0;
            --win-blue: #000080;
            --win-white: #ffffff;
            --win-dark: #808080;
            --win-black: #000000;
        }

        body {
            font-family: 'Tahoma', 'MS Sans Serif', sans-serif;
            background-color: var(--win-teal);
            margin: 0;
            padding: 20px;
            user-select: none;
            overflow-x: hidden;
        }

        /* OKNO APLIKACIJE */
        .app-window {
            background-color: var(--win-gray);
            border: 2px solid var(--win-white);
            border-right-color: var(--win-black);
            border-bottom-color: var(--win-black);
            max-width: 1200px;
            margin: 0 auto;
            min-height: 700px;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .title-bar {
            background: linear-gradient(90deg, var(--win-blue), #1084d0);
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 25px;
        }

        /* GLAVNA POSTAVITEV */
        .main-container {
            display: flex;
            flex: 1;
            height: 100%;
        }

        /* STRANSKI MENI (LEVO) - Viden samo ko si prijavljen in ne na home */
        .sidebar {
            width: 180px;
            background: var(--win-gray);
            border-right: 2px solid var(--win-dark);
            padding: 10px;
            display: none; /* Privzeto skrit */
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }

        .sidebar-timer {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 5px;
            border: 2px inset var(--win-white);
            margin-bottom: 10px;
        }

        /* VSEBINA */
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--win-gray);
        }

        /* NAVIGACIJSKI GUMBI (slike) */
        .nav-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .nav-btn img {
            width: 100%; /* Prilagodi glede na container */
            max-width: 150px;
            border: 2px outset var(--win-white);
        }
        .nav-btn:active img { border: 2px inset var(--win-white); }

        /* GUMBI & ELEMENTI */
        button.retro-btn {
            background: var(--win-gray);
            border: 2px solid var(--win-white);
            border-right-color: var(--win-black);
            border-bottom-color: var(--win-black);
            padding: 4px 12px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Tahoma', sans-serif;
        }
        button.retro-btn:active {
            border: 2px solid var(--win-black);
            border-right-color: var(--win-white);
            border-bottom-color: var(--win-white);
            transform: translate(1px, 1px);
        }

        input, select, textarea {
            border: 2px inset var(--win-white);
            background: var(--win-white);
            padding: 3px;
            font-family: 'Tahoma', sans-serif;
        }

        /* TRAK ZA DATUM (Priloga 1) */
        .date-tape {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #808080;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            border: 2px solid #404040;
            color: white;
            font-weight: bold;
            user-select: none;
        }
        .tape-arrow {
            font-size: 24px;
            cursor: pointer;
            padding: 0 15px;
            color: white;
        }
        .tape-arrow:hover { color: #ffffcc; }
        .tape-display {
            font-size: 18px;
            padding: 0 20px;
            cursor: pointer;
            text-align: center;
            min-width: 200px;
        }

        /* LOGIN STRAN (Priloga 2) */
        .login-grid {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 20px;
            max-width: 800px;
            margin: 50px auto;
        }
        .login-sidebar { border-right: 2px solid var(--win-dark); padding-right: 10px; }
        .login-sidebar img { width: 50px; margin-bottom: 15px; display: block; }
        .login-form-box {
            background: #d0d0d0;
            border: 2px inset var(--win-white);
            padding: 20px;
        }
        .auto-text { font-weight: bold; color: black; }
        .login-info-row { margin-bottom: 5px; color: #404040; }

        /* DASHBOARD (Prijavljen) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .dash-tile {
            text-align: center;
            cursor: pointer;
        }
        .dash-tile img { width: 80px; height: 80px; margin-bottom: 5px; }
        .dash-tile:hover { background-color: #d0d0d0; border-radius: 5px; }

        /* TABELE */
        table.retro-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 2px solid var(--win-dark);
        }
        table.retro-table th { background: #e0e0e0; border: 1px solid var(--win-dark); padding: 5px; }
        table.retro-table td { border: 1px solid var(--win-gray); padding: 5px; }
        table.retro-table tr:hover td { background: #ffffcc; }

        /* URNIK TABELA */
        .schedule-grid td {
            height: 80px; vertical-align: middle; text-align: center;
            border: 2px outset white; background: #c0c0c0; cursor: pointer;
            font-weight: bold; width: 11%;
        }
        .schedule-grid .crossed { 
            background: repeating-linear-gradient(45deg, #c0c0c0, #c0c0c0 10px, #a0a0a0 10px, #a0a0a0 20px);
            color: #666; cursor: default;
        }

        /* MODALS */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-win {
            background: var(--win-gray); border: 2px outset var(--win-white);
            padding: 5px; box-shadow: 5px 5px 15px black; width: 500px;
        }
        .modal-body { padding: 15px; border: 2px inset var(--win-white); background: #eee; }

        /* ABSENCE MATRIX STYLES */
        .abs-cell { text-align: center; }
        .abs-btn { 
            font-size: 10px; padding: 1px 3px; margin: 0 1px; border: 1px solid gray; cursor: pointer; 
        }
        .abs-btn:hover { border-color: black; }
        .status-O { background-color: #ccffcc !important; } /* Pastel Green */
        .status-N { background-color: #ffcccc !important; } /* Pastel Red */
        .status-P { background-color: #ffffcc !important; } /* Pending Yellow */
        .has-note { border: 2px solid orange !important; background-color: #ffff99; } /* Yellow highlight */

        /* UTILS */
        .hidden { display: none !important; }
        .text-bold { font-weight: bold; }
        .text-red { color: red; }
    </style>
</head>
<body>

<div class="app-window">
    <div class="title-bar">
        <span>MINDEX v3.0</span>
        <div id="top-bar-info"></div>
    </div>

    <div class="main-container">
        
        <div id="sidebar" class="sidebar">
            <div class="sidebar-timer" id="session-timer">00:00:00</div>
            
            <div id="sidebar-buttons"></div>
        </div>

        <div class="content-area" id="content-area">
            
            <div id="page-login" class="active-page">
                <div style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 20px; font-family: 'Times New Roman', serif;">MINDEX</div>
                <div class="login-grid">
                    <div class="login-sidebar">
                        <img src="dnevnik_ikona_barvno.png" alt="Dnevnik" class="grayscale">
                        <img src="mrezni_plan_ikona_barvno.png" alt="Plan" class="grayscale">
                        <img src="redovalnica_ikona_barvno.png" alt="Redovalnica" class="grayscale">
                        <img src="odsotnost_ikona_barvno.png" alt="Odsotnost" class="grayscale">
                        <img src="profil_ikona_barvno.png" alt="Profil" class="grayscale">
                    </div>
                    <div>
                        <div style="margin-bottom: 20px;">
                            <h3 style="border-bottom: 1px solid gray;">Podatki:</h3>
                            <div class="login-info-row">Številka licence: <span class="auto-text" id="login-license">...</span></div>
                            <div class="login-info-row">IP naslov naprave: <span class="auto-text" id="login-ip">...</span></div>
                        </div>

                        <div class="login-form-box">
                            <h3>Prijava v sistem:</h3>
                            <input type="text" id="inp-user" placeholder="Uporabniško ime" style="width: 200px;"><br><br>
                            <input type="password" id="inp-pass" placeholder="Geslo" style="width: 200px;"><br><br>
                            <button class="retro-btn" onclick="app.login()">POTRDI</button>
                            <p id="login-error" class="text-red"></p>
                        </div>

                        <div style="margin-top: 20px; background: #e0e0e0; padding: 10px; border: 1px solid white;">
                            <strong>Zadnja prijava kot:</strong><br>
                            Uporabnik: <span class="auto-text" id="last-login-user">/</span><br>
                            Datum in čas: <span class="auto-text" id="last-login-time">/</span>
                            <button class="retro-btn" style="float: right;" onclick="app.useLastLogin()">Uporabi</button>
                            <div style="clear:both;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-dashboard" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h2>Pozdravljeni, <span id="dash-username"></span></h2>
                        <div style="border: 2px groove white; padding: 10px; margin: 10px 0; background: #e0e0e0;">
                            <strong>POMOČ PRI ORIENTACIJI:</strong><br>
                            Seja poteče čez: <span id="dash-timer" style="font-family: monospace;">00:00:00</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                         <img src="odjava_ikona_barvno.png" onclick="app.logout()" style="width: 60px; height: 60px; cursor: pointer; border: 2px outset white;" title="Odjava">
                    </div>
                </div>

                <div class="dashboard-grid" id="dash-tiles">
                    </div>
                
                <div style="margin-top: 30px; border-top: 2px solid gray; padding-top: 10px; color: #404040;">
                    <p><i>Vse dobro</i></p>
                </div>
            </div>

            <div id="page-dnevnik" class="hidden">
                <h3>DNEVNIK</h3>
                <div class="date-tape">
                    <span class="tape-arrow" onclick="app.changeDate(-1)">&#8592;</span>
                    <span class="tape-display" id="tape-display" onclick="document.getElementById('date-picker-hidden').showPicker()">
                        Četrtek, 1. 1. 2025
                    </span>
                    <input type="date" id="date-picker-hidden" style="width: 0; height: 0; opacity: 0;" onchange="app.setDate(this.value)">
                    <span class="tape-arrow" onclick="app.changeDate(1)">&#8594;</span>
                </div>
                <div class="login-info-row" style="text-align:center; font-size: 0.8em; margin-top: -15px; margin-bottom: 20px;">
                    (Kliknite na datum za koledar, puščice za +/- 1 dan)
                </div>

                <div id="schedule-container"></div>
            </div>

            <div id="page-redovalnica" class="hidden">
                <h3>REDOVALNICA</h3>
                <div id="grades-controls" style="margin-bottom: 10px;"></div>
                <div id="grades-table-area"></div>
            </div>

            <div id="page-odsotnost" class="hidden">
                <h3>EVIDENCA ODSOTNOSTI</h3>
                <div id="absence-controls" style="margin-bottom: 10px;">
                    Razred: <select id="abs-class-select" onchange="app.loadAbsenceView()"></select>
                    Pogled: <select id="abs-view-select" onchange="app.loadAbsenceView()">
                        <option value="summary">Splošno</option>
                        <option value="detail">Podrobno (Urejanje)</option>
                    </select>
                </div>
                
                <div id="abs-tape-container" class="hidden">
                    <div class="date-tape">
                        <span class="tape-arrow" onclick="app.changeAbsDate(-1)">&#8592;</span>
                        <span class="tape-display" id="abs-tape-display">Datum</span>
                        <span class="tape-arrow" onclick="app.changeAbsDate(1)">&#8594;</span>
                    </div>
                </div>

                <div id="absence-content"></div>
            </div>

            <div id="page-profil" class="hidden">
                <h3>MOJ PROFIL</h3>
                <div style="background: white; border: 2px inset gray; padding: 20px; max-width: 500px;">
                    <p><strong>Ime in priimek:</strong> <span id="prof-name"></span></p>
                    <p><strong>Uporabniško ime:</strong> <span id="prof-user"></span></p>
                    <p><strong>Vloga:</strong> <span id="prof-role"></span></p>
                    <hr>
                    <div id="admin-controls" class="hidden">
                        <h4>ADMINISTRACIJA</h4>
                        <button class="retro-btn" onclick="app.adminTeachers()">Upravljanje učiteljev</button>
                        <button class="retro-btn" onclick="app.adminClasses()">Upravljanje razredov</button>
                        <button class="retro-btn" onclick="app.adminSubjects()">Predmeti</button>
                    </div>
                    <div id="teacher-controls" class="hidden">
                        <p>Čas seje: <span id="prof-session"></span> min</p>
                        <label>Novo geslo:</label> <input type="password" id="new-pass">
                        <button class="retro-btn" onclick="app.changePassword()">Shrani</button>
                    </div>
                </div>
                <div id="admin-workspace" style="margin-top: 20px;"></div>
            </div>

            <div id="page-plan" class="hidden">
                <h3>MREŽNI PLAN</h3>
                <div id="plan-container"></div>
            </div>

        </div> </div>
</div>

<div id="modal-hour" class="modal-overlay">
    <div class="modal-win">
        <div class="title-bar">VPIS URE <button onclick="app.closeModal('modal-hour')">X</button></div>
        <div class="modal-body">
            <h4 id="mh-title" style="margin: 0 0 10px 0; border-bottom: 1px solid black;"></h4>
            
            <div style="display:flex; gap: 10px;">
                <div style="flex:1;">
                    <label class="text-bold">MANJKAJOČI:</label>
                    <div id="mh-missing-list" style="background: white; border: 2px inset white; height: 100px; overflow-y: scroll; padding: 5px;"></div>
                    <button class="retro-btn" style="width:100%; margin-top:5px;" onclick="app.openStudentPicker()">+ Dodaj odsotnega</button>
                </div>
                <div style="flex:1;">
                    <label class="text-bold">VSEBINA URE:</label>
                    <textarea id="mh-content" rows="6" style="width: 95%;"></textarea>
                </div>
            </div>
            <br>
            <div style="text-align: right;">
                <button class="retro-btn" onclick="app.saveHour()">SHRANI</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-picker" class="modal-overlay">
    <div class="modal-win" style="width: 300px;">
        <div class="title-bar">Izberi <button onclick="app.closeModal('modal-picker')">X</button></div>
        <div class="modal-body">
            <ul id="picker-list" style="list-style: none; padding: 0; max-height: 300px; overflow-y: auto;"></ul>
        </div>
    </div>
</div>

<div id="modal-note" class="modal-overlay">
    <div class="modal-win" style="width: 300px;">
        <div class="title-bar">Opomba odsotnosti <button onclick="app.closeModal('modal-note')">X</button></div>
        <div class="modal-body">
            <p id="mn-student"></p>
            <textarea id="mn-text" rows="4" style="width: 95%;"></textarea>
            <button class="retro-btn" onclick="app.saveAbsenceNote()">Shrani opombo</button>
        </div>
    </div>
</div>

<div id="modal-general" class="modal-overlay">
    <div class="modal-win">
        <div class="title-bar"><span id="mg-title">Info</span> <button onclick="app.closeModal('modal-general')">X</button></div>
        <div class="modal-body" id="mg-body"></div>
    </div>
</div>

<script>
/**
 * MINDEX v3.0 Logic
 * Združuje urnik, redovalnico, opravičevanje v enoten sistem.
 */

const DB_KEY = "MINDEX_DB_v3";

// GENERIRANJE ID-jev
const uid = () => '_' + Math.random().toString(36).substr(2, 9);

// PRIVZETI PODATKI
const defaultData = {
    users: [
        { id: 'admin', username: 'ADMIN', password: 'ADMIN', role: 'admin', name: 'Administrator', sessionTimeout: 30 }
    ],
    classes: [],     // { id, name }
    subjects: [],    // { id, name, classIds[] }
    schedules: {},   // Key: "YYYY-MM-DD_teacherId" -> { 1: classId, ... }
    hourLogs: [],    // { id, date, hour, classId, teacherId, content }
    absences: [],    // { id, date, hour, studentId, status: 'pending'|'excused'|'unexcused', note: '' }
    grades: [],      // { id, studentId, subject, period, type, value, correctedValue }
    notes: [],       // { studentId, subject, period, value: 'X'|'CHECK' }
    plan: []         // { id, classId, subject, month, day }
};

// --- GLOBAL APP OBJECT ---
const app = {
    db: null,
    currentUser: null,
    sessionTimer: null,
    sessionSeconds: 0,
    currentDate: new Date(), // Za dnevnik
    currentAbsDate: new Date(), // Za opravičevanje
    tempState: {}, // Za prenašanje podatkov med modali

    init: function() {
        // Load DB
        const stored = localStorage.getItem(DB_KEY);
        this.db = stored ? JSON.parse(stored) : defaultData;
        
        // Ensure migration/compatibility
        if(!this.db.schedules) this.db.schedules = {};

        // Mock System Info
        document.getElementById('login-license').innerText = "LIC-" + Math.floor(Math.random()*100000);
        document.getElementById('login-ip').innerText = "192.168.1." + Math.floor(Math.random()*255);
        
        // Last Login Display
        const lastUser = localStorage.getItem('mindex_last_user');
        const lastTime = localStorage.getItem('mindex_last_time');
        if(lastUser) {
            document.getElementById('last-login-user').innerText = lastUser;
            document.getElementById('last-login-time').innerText = lastTime || "?";
        }
    },

    saveDB: function() {
        localStorage.setItem(DB_KEY, JSON.stringify(this.db));
    },

    // --- NAVIGATION ---
    showPage: function(pageId) {
        document.querySelectorAll('.content-area > div').forEach(div => div.classList.add('hidden'));
        document.querySelectorAll('.content-area > div').forEach(div => div.classList.remove('active-page'));
        
        const target = document.getElementById('page-' + pageId);
        target.classList.remove('hidden');
        target.classList.add('active-page');

        // Sidebar logic
        const sidebar = document.getElementById('sidebar');
        const homeIcon = document.getElementById('home-icon-container'); // Če bi ga imeli v headerju
        
        if (pageId === 'login') {
            sidebar.style.display = 'none';
        } else if (pageId === 'dashboard') {
            sidebar.style.display = 'none';
        } else {
            // V notranjih straneh pokaži sidebar z navigacijo
            sidebar.style.display = 'flex';
            this.renderSidebarButtons(pageId);
        }

        // Page Init Triggers
        if (pageId === 'dnevnik') this.loadSchedule();
        if (pageId === 'odsotnost') this.loadAbsenceInit();
        if (pageId === 'redovalnica') this.loadGradesInit();
        if (pageId === 'plan') this.loadPlanInit();
        if (pageId === 'profil') this.loadProfile();
    },

    renderSidebarButtons: function(activePage) {
        const container = document.getElementById('sidebar-buttons');
        // Dodamo gumb domov na vrh sidebara ali v header? Po navodilih:
        // "na desni strani pa pojavi ikona hišice, kar pomeni, da gre na domačo stran" -> To damo v top-bar-info
        
        // Sidebar ima menije:
        const menus = [
            { id: 'dnevnik', img: 'dnevnik_gumb_barvno.png', label: 'Dnevnik' },
            { id: 'plan', img: 'mrezni_plan_gumb_barvno.png', label: 'Mrežni plan' },
            { id: 'redovalnica', img: 'redovalnica_gumb_barvno.png', label: 'Redovalnica' },
            { id: 'odsotnost', img: 'odsotnost_gumb_barvno.png', label: 'Odsotnost' },
            { id: 'profil', img: 'profil_gumb_barvno.png', label: 'Profil' }
        ];

        let html = '';
        menus.forEach(m => {
            // Če smo učence, so nekatere stvari omejene? Ne, dostopajo do vsega, le vsebina je drugačna.
            // Razen 'Odsotnost' za učence je samo pregled.
            html += `<button class="nav-btn" onclick="app.showPage('${m.id}')">
                <img src="${m.img}" alt="${m.label}">
            </button>`;
        });
        container.innerHTML = html;

        // HIŠICA (HOME) V HEADERJU
        const topInfo = document.getElementById('top-bar-info');
        topInfo.innerHTML = `<img src="domov_ikona_barvno.png" onclick="app.showPage('dashboard')" style="height:20px; cursor:pointer; margin-left:10px; border: 1px solid white;" title="Domov">`;
    },

    // --- LOGIN / SESSION ---
    login: function() {
        const u = document.getElementById('inp-user').value;
        const p = document.getElementById('inp-pass').value;
        
        // Find user
        const user = this.db.users.find(x => x.username === u && x.password === p);
        if (user) {
            this.currentUser = user;
            
            // Save info for next time
            localStorage.setItem('mindex_last_user', u);
            localStorage.setItem('mindex_last_time', new Date().toLocaleString());
            
            // Start Session
            const timeoutMin = user.sessionTimeout || 30; // Default 30 min
            this.sessionSeconds = timeoutMin * 60;
            this.startSessionTimer();

            // Render Dashboard
            document.getElementById('dash-username').innerText = user.name;
            this.renderDashboardTiles();
            this.showPage('dashboard');
        } else {
            document.getElementById('login-error').innerText = "Napačni podatki!";
        }
    },

    useLastLogin: function() {
        const last = localStorage.getItem('mindex_last_user');
        if(last) document.getElementById('inp-user').value = last;
        document.getElementById('inp-pass').focus();
    },

    logout: function() {
        clearInterval(this.sessionTimer);
        this.currentUser = null;
        document.getElementById('inp-user').value = "";
        document.getElementById('inp-pass').value = "";
        document.getElementById('login-error').innerText = "";
        this.showPage('login');
    },

    startSessionTimer: function() {
        if(this.sessionTimer) clearInterval(this.sessionTimer);
        
        const format = (s) => {
            const h = Math.floor(s / 3600).toString().padStart(2,'0');
            const m = Math.floor((s % 3600) / 60).toString().padStart(2,'0');
            const sec = (s % 60).toString().padStart(2,'0');
            return `${h}:${m}:${sec}`;
        };

        const updateDisplay = () => {
            const txt = format(this.sessionSeconds);
            document.getElementById('dash-timer').innerText = txt;
            document.getElementById('session-timer').innerText = txt;
        };

        updateDisplay();
        this.sessionTimer = setInterval(() => {
            this.sessionSeconds--;
            updateDisplay();
            if (this.sessionSeconds <= 0) {
                alert("Seja je potekla!");
                this.logout();
            }
        }, 1000);

        // Reset on interaction? Prompt says "od trenutka, ko je prijavljen začne odštevati". 
        // Usually strict countdown means NO reset. I will follow strict countdown based on description.
    },

    renderDashboardTiles: function() {
        const container = document.getElementById('dash-tiles');
        const role = this.currentUser.role;
        
        const tiles = [
            { id: 'dnevnik', img: 'dnevnik_ikona_barvno.png', label: 'DNEVNIK', desc: 'Urnik in vpisi ur' },
            { id: 'plan', img: 'mrezni_plan_ikona_barvno.png', label: 'MREŽNI PLAN', desc: 'Pregled ocenjevanj' },
            { id: 'redovalnica', img: 'redovalnica_ikona_barvno.png', label: 'REDOVALNICA', desc: 'Ocene in graje' },
            { id: 'odsotnost', img: 'odsotnost_ikona_barvno.png', label: 'ODSOTNOST', desc: 'Urejanje izostankov' },
            { id: 'profil', img: 'profil_ikona_barvno.png', label: 'PROFIL', desc: 'Moji podatki' }
        ];

        let html = '';
        tiles.forEach(t => {
            html += `
            <div class="dash-tile" onclick="app.showPage('${t.id}')">
                <img src="${t.img}" alt="${t.label}">
                <div style="font-weight:bold;">${t.label}</div>
                <div style="font-size:0.8em; color:#404040;">${t.desc}</div>
            </div>`;
        });
        container.innerHTML = html;
        
        // Pomoč text (Source 26) se dinamično prikaže glede na hover? 
        // Ali pa samo statično pod ploščicami. V kodi HTML sem dal splošen opis, 
        // tu lahko dodamo specifična navodila, če je treba.
    },

    // --- DNEVNIK / URNIK ---
    formatDateSI: function(dateObj) {
        const options = { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' };
        let s = dateObj.toLocaleDateString('sl-SI', options);
        // Capitalize first letter
        return s.charAt(0).toUpperCase() + s.slice(1);
    },
    
    getISODate: function(dateObj) {
        return dateObj.toISOString().split('T')[0];
    },

    changeDate: function(delta) {
        this.currentDate.setDate(this.currentDate.getDate() + delta);
        this.loadSchedule();
    },

    setDate: function(val) {
        if(val) {
            this.currentDate = new Date(val);
            this.loadSchedule();
        }
    },

    loadSchedule: function() {
        // Update Tape
        document.getElementById('tape-display').innerText = this.formatDateSI(this.currentDate);
        const isoDate = this.getISODate(this.currentDate);
        const container = document.getElementById('schedule-container');
        
        if (this.currentUser.role === 'admin') {
            container.innerHTML = "<p>Administrator ureja urnike na Profilu.</p>";
            return;
        }

        // Tabela urnika
        let html = `<table class="schedule-grid"><thead><tr>`;
        for(let i=1; i<=9; i++) html += `<th>${i}.</th>`;
        html += `</tr></thead><tbody><tr>`;

        // Logic for Teacher vs Student
        // Teacher sees classes they teach. Student sees their class schedule.
        // For simplicity: We look at the stored Schedule object.
        // Schedule Key: DATE_TEACHERID. 
        // If Student: find which teacher teaches their class at that hour? Too complex for this simple DB.
        // Assumption: We only fully support Teacher view for editing. Student view is read-only.

        const mySched = (this.currentUser.role === 'teacher') 
            ? (this.db.schedules[`${isoDate}_${this.currentUser.id}`] || {})
            : {}; // Student logic would require reverse lookup
        
        // If student, we try to find matches in all teacher schedules
        if (this.currentUser.role === 'student') {
             let studentRow = "";
             for(let h=1; h<=9; h++) {
                 let foundClass = null;
                 let foundTeacher = null;
                 // Brute force search
                 this.db.users.filter(u => u.role === 'teacher').forEach(t => {
                     const s = this.db.schedules[`${isoDate}_${t.id}`];
                     if (s && s[h] === this.currentUser.classId) {
                         foundClass = this.db.classes.find(c => c.id === this.currentUser.classId);
                         foundTeacher = t;
                     }
                 });
                 if (foundClass) {
                     studentRow += `<td>${foundClass.name}<br><small>${foundTeacher.name}</small></td>`;
                 } else {
                     studentRow += `<td class="crossed">P</td>`;
                 }
             }
             html += studentRow;
        } else {
            // Teacher
            for(let h=1; h<=9; h++) {
                const clsId = mySched[h];
                if (clsId && clsId !== 'P') {
                    const cls = this.db.classes.find(c => c.id === clsId);
                    html += `<td onclick="app.openHourModal('${isoDate}', ${h}, '${clsId}')">${cls ? cls.name : '?'}</td>`;
                } else {
                    html += `<td class="crossed">P</td>`;
                }
            }
        }
        
        html += `</tr></tbody></table>`;
        container.innerHTML = html;
    },

    openHourModal: function(date, hour, classId) {
        const cls = this.db.classes.find(c => c.id === classId);
        this.tempState = { date, hour, classId };
        
        document.getElementById('mh-title').innerText = `${date} | ${hour}. ura | ${cls.name}`;
        document.getElementById('modal-hour').style.display = 'flex'; // Flex za center

        // Load Content
        const log = this.db.hourLogs.find(l => l.date === date && l.hour === hour && l.classId === classId);
        document.getElementById('mh-content').value = log ? log.content : "";

        this.renderMissingList();
    },

    renderMissingList: function() {
        const { date, hour, classId } = this.tempState;
        const container = document.getElementById('mh-missing-list');
        container.innerHTML = "";

        const absences = this.db.absences.filter(a => a.date === date && a.hour === hour); // Za vse dijake te ure
        // Filter samo za ta razred
        const classStudents = this.db.users.filter(u => u.classId === classId && u.role === 'student');
        
        const absentHere = absences.filter(a => classStudents.find(s => s.id === a.studentId));

        if (absentHere.length === 0) {
            container.innerHTML = "<i>Ni odsotnih.</i>";
        } else {
            absentHere.forEach(a => {
                const s = classStudents.find(u => u.id === a.studentId);
                const div = document.createElement('div');
                div.style.borderBottom = "1px solid #ddd";
                div.style.padding = "2px";
                div.style.display = "flex";
                div.style.justifyContent = "space-between";
                
                div.innerHTML = `
                    <span style="font-weight:bold; color:red;">${s.name}</span>
                    <span>
                        <button style="font-size:10px; cursor:pointer;" onclick="app.openNoteModal('${a.id}', '${s.name}')">✏️</button>
                        <button style="font-size:10px; cursor:pointer;" onclick="app.removeAbsence('${a.id}')">X</button>
                    </span>
                `;
                container.appendChild(div);
            });
        }
    },

    openStudentPicker: function() {
        const list = document.getElementById('picker-list');
        list.innerHTML = "";
        const students = this.db.users.filter(u => u.classId === this.tempState.classId && u.role === 'student');
        students.forEach(s => {
            list.innerHTML += `<li><button style="width:100%; text-align:left;" onclick="app.addAbsence('${s.id}')">${s.name}</button></li>`;
        });
        document.getElementById('modal-picker').style.display = 'flex';
    },

    addAbsence: function(sid) {
        const { date, hour } = this.tempState;
        // Check duplicate
        if (!this.db.absences.find(a => a.date === date && a.hour === hour && a.studentId === sid)) {
            this.db.absences.push({
                id: uid(), date, hour, studentId: sid, status: 'pending', note: ''
            });
            this.saveDB();
        }
        this.closeModal('modal-picker');
        this.renderMissingList();
    },

    removeAbsence: function(aid) {
        this.db.absences = this.db.absences.filter(a => a.id !== aid);
        this.saveDB();
        this.renderMissingList();
    },

    openNoteModal: function(aid, sname) {
        this.tempState.currentAbsenceId = aid;
        const abs = this.db.absences.find(a => a.id === aid);
        document.getElementById('mn-student').innerText = "Opomba za: " + sname;
        document.getElementById('mn-text').value = abs.note || "";
        document.getElementById('modal-note').style.display = 'flex';
    },

    saveAbsenceNote: function() {
        const aid = this.tempState.currentAbsenceId;
        const txt = document.getElementById('mn-text').value;
        const abs = this.db.absences.find(a => a.id === aid);
        if(abs) {
            abs.note = txt;
            this.saveDB();
        }
        this.closeModal('modal-note');
        // Če smo v urniku, render missing list, če smo v odsotnosti, refresh view
        if(document.getElementById('modal-hour').style.display !== 'none') {
            this.renderMissingList();
        }
        if(document.getElementById('page-odsotnost').classList.contains('active-page')) {
            this.loadAbsenceView();
        }
    },

    saveHour: function() {
        const { date, hour, classId } = this.tempState;
        const content = document.getElementById('mh-content').value;
        
        // Remove old log
        this.db.hourLogs = this.db.hourLogs.filter(l => !(l.date === date && l.hour === hour && l.classId === classId));
        // Add new
        this.db.hourLogs.push({
            id: uid(), date, hour, classId, teacherId: this.currentUser.id, content
        });
        this.saveDB();
        this.closeModal('modal-hour');
        alert("Shranjeno.");
    },

    closeModal: function(id) {
        document.getElementById(id).style.display = 'none';
    },

    // --- ODSOTNOST (LOGIKA IZ PRILOG) ---
    loadAbsenceInit: function() {
        const sel = document.getElementById('abs-class-select');
        sel.innerHTML = "";
        if (this.currentUser.role === 'teacher' || this.currentUser.role === 'admin') {
            this.db.classes.forEach(c => {
                sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        } else {
            // Student sees only summary
            const c = this.db.classes.find(x => x.id === this.currentUser.classId);
            if(c) sel.innerHTML = `<option value="${c.id}">${c.name}</option>`;
            document.getElementById('abs-view-select').value = "summary";
            document.getElementById('abs-view-select').disabled = true;
        }
        this.loadAbsenceView();
    },

    changeAbsDate: function(d) {
        this.currentAbsDate.setDate(this.currentAbsDate.getDate() + d);
        this.loadAbsenceView();
    },

    loadAbsenceView: function() {
        const cid = document.getElementById('abs-class-select').value;
        const view = document.getElementById('abs-view-select').value;
        const container = document.getElementById('absence-content');
        const students = this.db.users.filter(u => u.classId === cid && u.role === 'student');

        if (view === 'summary') {
            document.getElementById('abs-tape-container').classList.add('hidden');
            let h = `<table class="retro-table"><thead><tr><th>Učenec</th><th>Opravičeno</th><th>Neopravičeno</th><th>Čaka</th></tr></thead><tbody>`;
            students.forEach(s => {
                const myAbs = this.db.absences.filter(a => a.studentId === s.id);
                const exc = myAbs.filter(a => a.status === 'excused').length;
                const unexc = myAbs.filter(a => a.status === 'unexcused').length;
                const pend = myAbs.filter(a => a.status === 'pending').length;
                h += `<tr><td>${s.name}</td><td>${exc}</td><td>${unexc}</td><td>${pend}</td></tr>`;
            });
            h += `</tbody></table>`;
            // Priloga 3 tabela spodaj (Total)
            container.innerHTML = h;
        } else {
            // DETAILED VIEW (Priloga 3 Zgornja tabela)
            document.getElementById('abs-tape-container').classList.remove('hidden');
            document.getElementById('abs-tape-display').innerText = this.formatDateSI(this.currentAbsDate);
            const isoDate = this.getISODate(this.currentAbsDate);

            let h = `<table class="retro-table"><thead><tr><th>Ime in priimek</th>`;
            for(let i=1; i<=9; i++) h += `<th>${i}.</th>`;
            h += `</tr></thead><tbody>`;

            students.forEach(s => {
                h += `<tr><td><b>${s.name}</b></td>`;
                for(let i=1; i<=9; i++) {
                    // Find absence
                    const abs = this.db.absences.find(a => a.studentId === s.id && a.date === isoDate && a.hour === i);
                    
                    if (abs) {
                        const noteClass = abs.note ? "has-note" : "";
                        const statusClass = abs.status === 'excused' ? 'status-O' : (abs.status === 'unexcused' ? 'status-N' : 'status-P');
                        
                        // Logic for buttons
                        h += `<td class="abs-cell ${statusClass} ${noteClass}" 
                                ondblclick="app.massUpdateAbsence('${isoDate}', '${s.id}', '${abs.status}')">
                                <span class="abs-btn" onclick="app.updateAbsStatus('${abs.id}','excused')">O</span>
                                <span class="abs-btn" onclick="app.updateAbsStatus('${abs.id}','unexcused')">N</span>
                                <span class="abs-btn" onclick="app.deleteAbsence('${abs.id}')">X</span>
                                ${abs.note ? `<br><small onclick="app.openNoteModal('${abs.id}', '${s.name}')" style="cursor:help;">(Opomba)</small>` : ''}
                              </td>`;
                    } else {
                        h += `<td></td>`;
                    }
                }
                h += `</tr>`;
            });
            h += `</tbody></table><p><small>Dvoklik na celico spremeni vse ure tistega dne za tistega dijaka na enak status.</small></p>`;
            container.innerHTML = h;
        }
    },

    updateAbsStatus: function(aid, status) {
        const a = this.db.absences.find(x => x.id === aid);
        if(a) { a.status = status; this.saveDB(); this.loadAbsenceView(); }
    },

    deleteAbsence: function(aid) {
        this.db.absences = this.db.absences.filter(x => x.id !== aid);
        this.saveDB(); this.loadAbsenceView();
    },

    massUpdateAbsence: function(date, sid, currentStatus) {
        // Cycle status logic: P -> O -> N -> P
        let newStatus = 'excused';
        if (currentStatus === 'excused') newStatus = 'unexcused';
        if (currentStatus === 'unexcused') newStatus = 'pending';

        const list = this.db.absences.filter(a => a.date === date && a.studentId === sid);
        list.forEach(a => a.status = newStatus);
        this.saveDB();
        this.loadAbsenceView();
    },

    // --- REDOVALNICA (Based on provided code) ---
    loadGradesInit: function() {
        const area = document.getElementById('grades-table-area');
        const ctrl = document.getElementById('grades-controls');
        
        if(this.currentUser.role === 'student') {
            ctrl.innerHTML = "";
            this.renderStudentGrades(area);
        } else {
            // Teacher
            let h = `Razred: <select id="gr-class" onchange="app.renderTeacherGrades()">`;
            this.db.classes.forEach(c => h += `<option value="${c.id}">${c.name}</option>`);
            h += `</select> Predmet: <select id="gr-subj" onchange="app.renderTeacherGrades()">`;
            // V realnosti bi filtriral predmete glede na učitelja, tu damo vse
            this.db.subjects.forEach(s => h += `<option value="${s.name}">${s.name}</option>`);
            h += `</select>`;
            ctrl.innerHTML = h;
            this.renderTeacherGrades();
        }
    },

    renderStudentGrades: function(container) {
        const s = this.currentUser;
        const myClass = this.db.classes.find(c => c.id === s.classId);
        const subjects = this.db.subjects.filter(sub => sub.classIds.includes(s.classId));
        
        let h = `<table class="retro-table"><tr><th>Predmet</th><th>1. Obd.</th><th>2. Obd.</th><th>Končna</th></tr>`;
        subjects.forEach(sub => {
            h += `<tr>
                <td>${sub.name}</td>
                <td>${this.getGradesHTML(s.id, sub.name, 1)} ${this.getNoteHTML(s.id, sub.name, 1)}</td>
                <td>${this.getGradesHTML(s.id, sub.name, 2)} ${this.getNoteHTML(s.id, sub.name, 2)}</td>
                <td>${this.getGradesHTML(s.id, sub.name, 0)}</td>
            </tr>`;
        });
        h += `</table>`;
        container.innerHTML = h;
    },

    renderTeacherGrades: function() {
        const cid = document.getElementById('gr-class').value;
        const sub = document.getElementById('gr-subj').value;
        const container = document.getElementById('grades-table-area');
        if(!cid || !sub) return;

        const students = this.db.users.filter(u => u.classId === cid && u.role === 'student');
        let h = `<table class="retro-table"><tr><th>Učenec</th><th>1. Ocenjevalno</th><th>2. Ocenjevalno</th><th>Končna</th></tr>`;
        
        students.forEach(s => {
            h += `<tr>
                <td>${s.name}</td>
                <td onclick="app.promptGrade('${s.id}', '${sub}', 1)">${this.getGradesHTML(s.id, sub, 1)} ${this.getNoteHTML(s.id, sub, 1)}</td>
                <td onclick="app.promptGrade('${s.id}', '${sub}', 2)">${this.getGradesHTML(s.id, sub, 2)} ${this.getNoteHTML(s.id, sub, 2)}</td>
                <td onclick="app.promptFinal('${s.id}', '${sub}')">${this.getGradesHTML(s.id, sub, 0)}</td>
            </tr>`;
        });
        h += `</table>`;
        h += `<p><small>Klikni na celico za vpis ocene/graje.</small></p>`;
        container.innerHTML = h;
    },

    getGradesHTML: function(sid, sub, p) {
        return this.db.grades.filter(g => g.studentId === sid && g.subject === sub && g.period === p)
            .map(g => `<span style="font-weight:bold; color:${this.getColorByType(g.type)}; margin-right:3px;">${g.value}</span>`)
            .join(' ');
    },
    
    getNoteHTML: function(sid, sub, p) {
        const n = this.db.notes.find(x => x.studentId === sid && x.subject === sub && x.period === p);
        if(!n) return '';
        return n.value === 'X' ? '<span style="color:red; font-weight:bold;">X</span>' : '<span style="color:green;">✔</span>';
    },

    getColorByType: function(t) {
        if(t === 'PISNO') return 'red';
        if(t === 'USTNO') return 'black';
        if(t === 'IZDELEK') return 'blue';
        return 'black';
    },

    promptGrade: function(sid, sub, p) {
        // Simplificiran vnos za demo
        const val = prompt("Vpiši oceno (npr. 5) ali X za grajo:");
        if(!val) return;
        
        if (val.toUpperCase() === 'X') {
            // Logic for note
            const exist = this.db.notes.find(x => x.studentId === sid && x.subject === sub && x.period === p);
            if(exist) exist.value = (exist.value === 'X' ? 'CHECK' : 'X'); 
            else this.db.notes.push({ studentId: sid, subject: sub, period: p, value: 'X' });
        } else {
            // Logic for grade
            this.db.grades.push({
                id: uid(), studentId: sid, subject: sub, period: p, type: 'USTNO', value: val, correctedValue: ''
            });
        }
        this.saveDB();
        this.renderTeacherGrades();
    },
    
    promptFinal: function(sid, sub) {
        const val = prompt("Končna ocena:");
        if(val) {
            this.db.grades.push({ id: uid(), studentId: sid, subject: sub, period: 0, type: 'FINAL', value: val });
            this.saveDB();
            this.renderTeacherGrades();
        }
    },

    // --- MREŽNI PLAN ---
    loadPlanInit: function() {
        const container = document.getElementById('plan-container');
        const months = ["Jan", "Feb", "Mar", "Apr", "Maj", "Jun", "Jul", "Avg", "Sep", "Okt", "Nov", "Dec"];
        
        // Prikaz
        let h = `<table class="retro-table"><tr><th>Predmet/Mesec</th>${months.map(m=>`<th>${m}</th>`).join('')}</tr>`;
        
        // Predmeti
        const myClassId = (this.currentUser.role === 'student') ? this.currentUser.classId : (this.db.classes[0] ? this.db.classes[0].id : null);
        
        if(!myClassId) { container.innerHTML = "Ni razredov."; return; }
        
        if(this.currentUser.role === 'teacher') {
             h = `<p>Urejanje za razred: ${this.db.classes.find(c=>c.id===myClassId).name}</p>` + h;
             // V praksi bi tu dodal dropdown za izbor razreda
        }

        const subjects = this.db.subjects.filter(s => s.classIds.includes(myClassId));
        subjects.forEach(s => {
            h += `<tr><td>${s.name}</td>`;
            for(let m=0; m<12; m++) {
                const exams = this.db.plan.filter(p => p.classId === myClassId && p.subject === s.name && p.month === m);
                const txt = exams.map(e => e.day).join(', ');
                h += `<td onclick="app.editPlan('${myClassId}','${s.name}',${m})">${txt}</td>`;
            }
            h += `</tr>`;
        });
        h += `</table>`;
        container.innerHTML = h;
    },

    editPlan: function(cid, sub, m) {
        if(this.currentUser.role === 'student') return;
        const d = prompt("Vpiši dan v mesecu (1-31) za ocenjevanje:");
        if(d) {
            this.db.plan.push({ id: uid(), classId: cid, subject: sub, month: m, day: d });
            this.saveDB();
            this.loadPlanInit();
        }
    },

    // --- PROFIL & ADMIN ---
    loadProfile: function() {
        const u = this.currentUser;
        document.getElementById('prof-name').innerText = u.name;
        document.getElementById('prof-user').innerText = u.username;
        document.getElementById('prof-role').innerText = u.role;

        if (u.role === 'admin') {
            document.getElementById('admin-controls').classList.remove('hidden');
        } else if (u.role === 'teacher') {
            document.getElementById('teacher-controls').classList.remove('hidden');
            document.getElementById('prof-session').innerText = u.sessionTimeout || 30;
        }
    },

    changePassword: function() {
        const np = document.getElementById('new-pass').value;
        if(np) {
            this.currentUser.password = np;
            // Update in DB array
            const idx = this.db.users.findIndex(x => x.id === this.currentUser.id);
            if(idx !== -1) this.db.users[idx] = this.currentUser;
            this.saveDB();
            alert("Geslo spremenjeno.");
        }
    },

    // --- ADMIN FUNKCIJE ---
    adminTeachers: function() {
        const ws = document.getElementById('admin-workspace');
        const teachers = this.db.users.filter(u => u.role === 'teacher');
        let h = `<h4>Učitelji</h4>
        <input id="nt-name" placeholder="Ime Priimek">
        <input id="nt-user" placeholder="Uporabniško ime">
        <input id="nt-pass" placeholder="Geslo">
        <input id="nt-sess" type="number" placeholder="Seja (min)" value="30" style="width:50px;">
        <button onclick="app.addTeacher()">Dodaj</button>
        <hr><ul>`;
        teachers.forEach(t => {
            h += `<li>${t.name} (Seja: ${t.sessionTimeout} min) <button onclick="app.delUser('${t.id}')">X</button></li>`;
        });
        h += `</ul>`;
        ws.innerHTML = h;
    },

    addTeacher: function() {
        const name = document.getElementById('nt-name').value;
        const user = document.getElementById('nt-user').value;
        const pass = document.getElementById('nt-pass').value;
        const sess = document.getElementById('nt-sess').value;
        if(name && user) {
            this.db.users.push({
                id: uid(), role: 'teacher', name, username: user, password: pass, sessionTimeout: sess
            });
            this.saveDB(); this.adminTeachers();
        }
    },

    delUser: function(id) {
        if(confirm("Brišem?")) {
            this.db.users = this.db.users.filter(u => u.id !== id);
            this.saveDB(); this.adminTeachers();
        }
    },

    adminClasses: function() {
        const ws = document.getElementById('admin-workspace');
        let h = `<h4>Razredi</h4>
        <input id="nc-name" placeholder="Ime razreda (npr. 4.A)">
        <textarea id="nc-students" placeholder="Dijaki (vsak v novo vrstico)"></textarea>
        <button onclick="app.addClass()">Ustvari</button><hr>`;
        this.db.classes.forEach(c => h += `<b>${c.name}</b> `);
        ws.innerHTML = h;
    },

    addClass: function() {
        const name = document.getElementById('nc-name').value;
        const rawS = document.getElementById('nc-students').value;
        if(name) {
            const cid = uid();
            this.db.classes.push({ id: cid, name });
            // Parse students
            const lines = rawS.split('\n');
            lines.forEach(line => {
                if(line.trim()) {
                    const sName = line.trim();
                    // Generate user/pass: lowercase, no spaces, no special chars
                    const clean = sName.toLowerCase()
                        .replace(/č/g,'c').replace(/š/g,'s').replace(/ž/g,'z')
                        .replace(/\s/g, '');
                    
                    this.db.users.push({
                        id: uid(), role: 'student', name: sName, username: clean, password: clean, classId: cid
                    });
                }
            });
            this.saveDB(); this.adminClasses();
        }
    },
    
    adminSubjects: function() {
        const ws = document.getElementById('admin-workspace');
        let h = `<h4>Predmeti</h4>
        <input id="ns-name" placeholder="Predmet">
        <button onclick="app.addSubject()">Dodaj</button><br>
        <ul>`;
        this.db.subjects.forEach(s => {
            h += `<li>${s.name} <small>(${s.classIds.length} razredov)</small> <button onclick="app.assignSubject('${s.id}')">Dodeli razred</button></li>`;
        });
        h += `</ul>`;
        ws.innerHTML = h;
    },

    addSubject: function() {
        const n = document.getElementById('ns-name').value;
        if(n) { this.db.subjects.push({ id: uid(), name: n, classIds: [] }); this.saveDB(); this.adminSubjects(); }
    },

    assignSubject: function(sid) {
        const sub = this.db.subjects.find(s => s.id === sid);
        const cname = prompt("Vpiši ime razreda za dodelitev:");
        const cls = this.db.classes.find(c => c.name === cname);
        if(cls) {
            sub.classIds.push(cls.id);
            this.saveDB(); this.adminSubjects();
        } else {
            alert("Razred ne obstaja.");
        }
    }
};

// Start
app.init();
</script>
</body>
</html>
