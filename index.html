<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINDEX - ≈†olski Informacijski Sistem</title>
    <style>
        /* --- RETRO WINDOWS 95 STIL & GLOBALE --- */
        :root {
            --bg-teal: #008080;
            --win-gray: #c0c0c0;
            --win-dark: #808080;
            --win-light: #ffffff;
            --win-black: #000000;
            --win-blue: #000080;
            --pastel-green: #ccffcc;
            --pastel-red: #ffcccc;
            --pastel-yellow: #ffffcc;
        }

        body {
            background-color: var(--bg-teal);
            font-family: 'Tahoma', 'MS Sans Serif', sans-serif;
            margin: 0;
            padding: 20px;
            font-size: 14px;
            user-select: none;
        }

        /* Glavno okno */
        .app-window {
            background-color: var(--win-gray);
            border: 2px solid var(--win-light);
            border-right-color: var(--win-black);
            border-bottom-color: var(--win-black);
            max-width: 1200px;
            min-height: 700px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
        }

        /* Naslovna vrstica */
        .title-bar {
            background: linear-gradient(90deg, var(--win-blue), #1084d0);
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Postavitev vsebine */
        .main-container {
            display: flex;
            flex: 1;
            height: 100%;
        }

        /* Stranski meni */
        .sidebar {
            width: 150px;
            background: var(--win-gray);
            border-right: 2px solid var(--win-dark);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }
        
        .sidebar-timer {
            margin-bottom: 20px;
            border: 2px inset white;
            padding: 5px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: #e0e0e0;
        }

        .nav-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            text-align: center;
            margin-bottom: 10px;
        }
        .nav-btn img {
            width: 100%; /* Prilagodi glede na potrebe */
            max-width: 140px; 
            display: block;
            margin: 0 auto;
        }
        .nav-btn:active { transform: translate(1px, 1px); }

        /* Glavna vsebina */
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
            border: 2px inset white;
            margin: 5px;
        }

        /* --- ELEMENTI --- */
        button.retro-btn {
            background: var(--win-gray);
            border: 2px solid var(--win-light);
            border-right-color: var(--win-black);
            border-bottom-color: var(--win-black);
            padding: 4px 12px;
            font-weight: bold;
            cursor: pointer;
        }
        button.retro-btn:active {
            border: 2px solid var(--win-black);
            border-right-color: var(--win-light);
            border-bottom-color: var(--win-light);
            transform: translate(1px, 1px);
        }

        input, select, textarea {
            border: 2px inset var(--win-light);
            background: white;
            padding: 3px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid var(--win-dark);
            margin-bottom: 15px;
        }
        th, td {
            border: 1px solid var(--win-gray);
            padding: 5px;
            text-align: left;
        }
        th { background: #e0e0e0; }
        
        /* Specifiƒçni slogi za Login */
        .login-wrapper {
            display: flex;
            height: 100%;
            align-items: center;
            justify-content: center;
            background: var(--win-gray);
        }
        .login-box {
            display: flex;
            width: 800px;
            border: 2px solid white;
            box-shadow: 2px 2px 10px #000;
        }
        .login-sidebar {
            width: 150px;
            background: #e0e0e0;
            padding: 10px;
            border-right: 2px solid gray;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .login-main {
            flex: 1;
            padding: 20px;
            background: white;
        }
        .auto-text { font-weight: bold; color: black; }
        .login-form-box {
            background: #d0d0d0;
            padding: 20px;
            border: 2px solid gray;
            width: 60%;
            margin-top: 20px;
        }

        /* Trak za datum */
        .date-tape {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #808080;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }
        .tape-arrow {
            cursor: pointer;
            font-size: 1.5em;
            padding: 0 15px;
            user-select: none;
        }
        .tape-arrow:hover { color: #ffffcc; }
        .tape-center {
            flex: 1;
            text-align: center;
            cursor: pointer;
            border-left: 2px solid white;
            border-right: 2px solid white;
        }

        /* Urnik tabela */
        .schedule-table td {
            height: 80px;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            border: 2px outset white;
            background: #d0d0d0;
        }
        .schedule-table td:hover { background: #fffacd; }
        .schedule-table .crossed-out {
            background: repeating-linear-gradient(45deg, #c0c0c0, #c0c0c0 10px, #a0a0a0 10px, #a0a0a0 20px);
            cursor: default;
        }

        /* Opraviƒçevanje matrika */
        .matrix-cell {
            text-align: center;
            width: 60px;
            padding: 2px !important;
        }
        .btn-mini {
            width: 100%;
            font-size: 0.7em;
            margin: 1px 0;
            padding: 1px;
            border: 1px solid gray;
            cursor: pointer;
        }
        .cell-excused { background-color: var(--pastel-green) !important; }
        .cell-unexcused { background-color: var(--pastel-red) !important; }
        .has-note { background-color: var(--pastel-yellow) !important; }

        /* Modali */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-window {
            background: var(--win-gray);
            border: 3px outset white;
            padding: 5px;
            box-shadow: 5px 5px 15px black;
            min-width: 400px;
        }
        .modal-body { padding: 15px; }

        .icon-fallback {
            border: 1px dashed gray;
            padding: 5px;
            background: #eee;
            font-size: 0.8em;
            display: inline-block;
        }
        img { min-width: 50px; min-height: 50px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-window">
    <div class="title-bar">
        <span>MINDEX v2.0</span>
        <div id="top-bar-right" class="hidden" style="display:flex; align-items:center; gap:10px;">
            <div id="session-display" style="font-family:monospace;">00:00:00</div>
            <img src="domov_ikona_barvno.png" alt="DOMOV" onclick="app.renderHome()" style="height:24px; width:24px; cursor:pointer; min-width:24px; min-height:24px;">
        </div>
    </div>

    <div id="page-login" class="content-area login-wrapper" style="padding:0; margin:0; border:none;">
        <div class="login-box">
            <div class="login-sidebar">
                <img src="dnevnik_ikona_barvno.png" alt="DNEVNIK" style="width:100%">
                <img src="mrezni_plan_ikona_barvno.png" alt="MRE≈ΩNI PLAN" style="width:100%">
                <img src="redovalnica_ikona_barvno.png" alt="REDOVALNICA" style="width:100%">
                <img src="odsotnost_ikona_barvno.png" alt="ODSOTNOST" style="width:100%">
                <img src="profil_ikona_barvno.png" alt="PROFIL" style="width:100%">
            </div>
            <div class="login-main">
                <h1 style="margin-top:0;">MINDEX</h1>
                <div style="border-bottom: 2px solid gray; margin-bottom: 10px;">
                    <h3>Podatki:</h3>
                    <p>≈†tevilka licence: <span class="auto-text" id="lic-num">...</span></p>
                    <p>IP naslov naprave: <span class="auto-text" id="ip-addr">...</span></p>
                </div>
                
                <h3>Prijava v sistem:</h3>
                <div class="login-form-box">
                    <input type="text" id="login-user" placeholder="Uporabni≈°ko ime" style="width:90%; margin-bottom:5px;"><br>
                    <input type="password" id="login-pass" placeholder="Geslo" style="width:90%; margin-bottom:10px;"><br>
                    <button class="retro-btn" onclick="app.login()">POTRDI</button>
                    <p id="login-error" style="color:red; font-size:0.8em; margin-top:5px;"></p>
                </div>

                <div style="margin-top:20px; border: 1px solid gray; background:#eee; padding:5px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b>Zadnja prijava kot:</b><br>
                        Uporabnik: <span id="last-login-user" class="auto-text">/</span><br>
                        Datum in ƒças: <span id="last-login-time" class="auto-text">/</span>
                    </div>
                    <button class="retro-btn" onclick="app.useLastLogin()">Uporabi</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="main-container hidden">
        <div class="sidebar" id="sidebar-menu">
            </div>
        <div class="content-area" id="main-content">
            </div>
    </div>
</div>

<div id="modal-hour" class="modal-overlay">
    <div class="modal-window" style="width:500px;">
        <div class="title-bar">VPIS URE <button class="retro-btn" style="padding:0 4px; float:right;" onclick="app.closeModal('modal-hour')">X</button></div>
        <div class="modal-body">
            <h4 id="mh-title" style="margin-top:0; border-bottom:1px solid gray;"></h4>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label><b>Manjkajoƒçi:</b></label>
                    <div id="mh-missing-list" style="background:white; border:2px inset white; height:150px; overflow-y:auto; padding:5px;"></div>
                    <button class="retro-btn" style="width:100%; margin-top:5px;" onclick="app.openStudentPicker()">+ Dodaj odsotnega</button>
                </div>
                <div style="flex:1;">
                    <label><b>Vsebina ure:</b></label>
                    <textarea id="mh-content" style="width:95%; height:150px;"></textarea>
                </div>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button class="retro-btn" onclick="app.saveHourLog()">SHRANI</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-picker" class="modal-overlay">
    <div class="modal-window" style="width:300px;">
        <div class="title-bar">Izberi dijaka <button class="retro-btn" style="float:right;" onclick="app.closeModal('modal-picker')">X</button></div>
        <div class="modal-body">
            <input type="text" id="picker-search" placeholder="I≈°ƒçi..." onkeyup="app.renderStudentPicker()" style="width:90%; margin-bottom:5px;">
            <div id="picker-list" style="height:200px; overflow-y:auto; border:2px inset white; background:white;"></div>
        </div>
    </div>
</div>

<div id="modal-note" class="modal-overlay">
    <div class="modal-window" style="width:400px;">
        <div class="title-bar">Opomba za odsotnost <button class="retro-btn" style="float:right;" onclick="app.closeModal('modal-note')">X</button></div>
        <div class="modal-body">
            <p id="mn-info"></p>
            <textarea id="mn-text" style="width:95%; height:100px;"></textarea>
            <br><br>
            <button class="retro-btn" onclick="app.saveAbsenceNote()">Shrani opombo</button>
        </div>
    </div>
</div>

<div id="modal-alert" class="modal-overlay">
    <div class="modal-window">
        <div class="title-bar">Obvestilo <button class="retro-btn" style="float:right;" onclick="app.closeModal('modal-alert')">X</button></div>
        <div class="modal-body" id="alert-body"></div>
        <div style="text-align:right; padding:10px;"><button class="retro-btn" onclick="app.closeModal('modal-alert')">V redu</button></div>
    </div>
</div>

<script>
/* --- KONFIGURACIJA IN BAZA --- */
const DB_KEY = 'MINDEX_FULL_DB_v1';
const LOGIN_MEMORY_KEY = 'MINDEX_LAST_LOGIN';

// Helper: Generiranje ID-jev
const gid = () => '_' + Math.random().toString(36).substr(2, 9);
// Helper: Generiranje username za dijake (lowercase, brez ≈°umnikov, brez presledkov)
const makeUser = (name) => name.toLowerCase().replace(/≈°/g,'s').replace(/ƒç/g,'c').replace(/≈æ/g,'z').replace(/ƒá/g,'c').replace(/\s+/g, '');

/* Glavna aplikacijska logika */
const app = {
    db: null,
    user: null,
    sessionTimer: null,
    timeLeft: 0,
    currentDate: new Date(),
    
    // Zaƒçasna stanja
    tempState: {},

    init: function() {
        // Inicializacija baze
        const stored = localStorage.getItem(DB_KEY);
        if (stored) {
            this.db = JSON.parse(stored);
        } else {
            // Seed podatki
            this.db = {
                users: [
                    { id: 'admin', name: 'Administrator', username: 'ADMIN', password: 'ADMIN', role: 'admin' }
                ],
                classes: [],
                students: [],
                schedules: {}, // key: date_teacherId
                hourLogs: [], // { id, date, hour, classId, teacherId, content }
                absences: [], // { id, studentId, date, hour, status: 'excused'|'unexcused'|'pending', note: '' }
                grades: [],   // Iz redovalnice
                notes: [],    // Graje/pohvale
                plan: []      // Mre≈æni plan
            };
            this.saveDB();
        }

        // Fake podatki na login strani
        document.getElementById('lic-num').innerText = Math.floor(Math.random() * 900000) + 100000;
        document.getElementById('ip-addr').innerText = `192.168.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`;
        
        // Zadnja prijava
        const lastLogin = JSON.parse(localStorage.getItem(LOGIN_MEMORY_KEY));
        if(lastLogin) {
            document.getElementById('last-login-user').innerText = lastLogin.username;
            document.getElementById('last-login-time').innerText = lastLogin.time;
        }
    },

    saveDB: function() { localStorage.setItem(DB_KEY, JSON.stringify(this.db)); },

    /* --- PRIJAVA / ODJAVA --- */
    login: function() {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        
        // Normaliziraj username za dijake (admin in uƒçitelji so case-sensitive oz. kot v bazi)
        const user = this.db.users.find(x => x.username === u && x.password === p) ||
                     this.db.students.find(s => s.username === u && s.username === p); // Dijak ima pass enak username

        if(user) {
            this.user = user;
            // Doloƒçi vlogo ƒçe je dijak
            if(!this.user.role) this.user.role = 'student';

            // Shrani spomin
            const now = new Date().toLocaleString('sl-SI');
            localStorage.setItem(LOGIN_MEMORY_KEY, JSON.stringify({ username: u, time: now }));

            // Nastavi sejo (privzeto 30 min za dijake/admina, za uƒçitelje iz profila)
            let sessionSeconds = 1800;
            if(this.user.role === 'teacher' && this.user.sessionTime) sessionSeconds = this.user.sessionTime * 60;
            if(this.user.role === 'admin') sessionSeconds = 3600;
            
            this.startSession(sessionSeconds);

            // Preklop UI
            document.getElementById('page-login').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('top-bar-right').classList.remove('hidden');

            this.renderSidebar();
            this.renderHome();
        } else {
            document.getElementById('login-error').innerText = "Napaƒçni podatki!";
        }
    },

    useLastLogin: function() {
        const last = JSON.parse(localStorage.getItem(LOGIN_MEMORY_KEY));
        if(last) {
            document.getElementById('login-user').value = last.username;
            document.getElementById('login-pass').focus();
        }
    },

    logout: function() {
        clearInterval(this.sessionTimer);
        this.user = null;
        location.reload();
    },

    startSession: function(seconds) {
        this.timeLeft = seconds;
        const display = document.getElementById('session-display');
        
        // Prikaz seje ob strani (bo vstavljen v renderSidebar) in zgoraj
        const updateDisplays = () => {
            const h = Math.floor(this.timeLeft / 3600).toString().padStart(2,'0');
            const m = Math.floor((this.timeLeft % 3600) / 60).toString().padStart(2,'0');
            const s = (this.timeLeft % 60).toString().padStart(2,'0');
            const str = `${h}:${m}:${s}`;
            
            display.innerText = str;
            const sideDisplay = document.getElementById('sidebar-timer-display');
            if(sideDisplay) sideDisplay.innerText = str;
        };

        this.sessionTimer = setInterval(() => {
            this.timeLeft--;
            updateDisplays();
            if(this.timeLeft <= 0) {
                alert("Seja je potekla!");
                this.logout();
            }
        }, 1000);
        updateDisplays();
    },

    /* --- NAVIGACIJA --- */
    renderSidebar: function() {
        const nav = document.getElementById('sidebar-menu');
        nav.innerHTML = `
            <div class="sidebar-timer">
                Seja:<br><span id="sidebar-timer-display">--:--:--</span>
            </div>
        `;
        
        const mkBtn = (label, img, action) => `
            <button class="nav-btn" onclick="${action}">
                <img src="${img}" alt="${label}" onerror="this.src='';this.style.backgroundColor='#ddd';this.style.border='1px solid black';">
            </button>
        `;

        if(this.user.role === 'admin') {
            nav.innerHTML += mkBtn('PROFIL', 'profil_gumb_barvno.png', 'app.renderAdminProfile()');
            nav.innerHTML += `<button class="retro-btn" onclick="app.adminTeachers()">Uƒçitelji</button>`;
            nav.innerHTML += `<button class="retro-btn" style="margin-top:5px;" onclick="app.adminClasses()">Razredi</button>`;
        } else if(this.user.role === 'teacher') {
            nav.innerHTML += mkBtn('DNEVNIK', 'dnevnik_gumb_barvno.png', 'app.renderSchedule()');
            nav.innerHTML += mkBtn('MRE≈ΩNI PLAN', 'mrezni_plan_gumb_barvno.png', 'app.renderPlan()');
            nav.innerHTML += mkBtn('REDOVALNICA', 'redovalnica_gumb_barvno.png', 'app.renderGrades()');
            nav.innerHTML += mkBtn('ODSOTNOST', 'odsotnost_gumb_barvno.png', 'app.renderAbsence()');
            nav.innerHTML += mkBtn('PROFIL', 'profil_gumb_barvno.png', 'app.renderProfile()');
        } else {
            // Dijak
            nav.innerHTML += mkBtn('REDOVALNICA', 'redovalnica_gumb_barvno.png', 'app.renderStudentGrades()');
            nav.innerHTML += mkBtn('ODSOTNOST', 'odsotnost_gumb_barvno.png', 'app.renderStudentAbsence()');
            nav.innerHTML += mkBtn('MRE≈ΩNI PLAN', 'mrezni_plan_gumb_barvno.png', 'app.renderStudentPlan()');
        }
    },

    renderHome: function() {
        const content = document.getElementById('main-content');
        content.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <h2>Pozdravljeni, ${this.user.name}</h2>
                    <div style="display:inline-block; border:2px solid gray; padding:10px; background:#e0e0e0; text-align:center;">
                         <img src="odjava_ikona_barvno.png" alt="X" style="width:40px; cursor:pointer;" onclick="app.logout()">
                         <br><b>ODJAVA</b>
                    </div>
                </div>
                <div style="border:2px solid orange; padding:10px; background:#ffffe0; max-width:300px;">
                    <h4>POMOƒå PRI ORIENTACIJI:</h4>
                    <ul style="font-size:0.9em; padding-left:20px;">
                        <li><b>DNEVNIK:</b> Va≈° urnik in vpis ur.</li>
                        <li><b>MRE≈ΩNI PLAN:</b> Pregled ocenjevanj.</li>
                        <li><b>REDOVALNICA:</b> Vnos ocen in graj.</li>
                        <li><b>ODSOTNOST:</b> Opraviƒçevanje izostankov (pravo garanje!).</li>
                        <li><b>PROFIL:</b> Va≈°i podatki.</li>
                    </ul>
                    <p style="text-align:right;"><i>Vse dobro!</i></p>
                </div>
            </div>
            <hr>
            <center><h3>Izberite funkcijo v meniju levo.</h3></center>
        `;
    },

    /* --- DATE TAPE COMPONENT --- */
    renderDateTape: function(containerId, onChangeCallback) {
        const d = this.currentDate;
        const dStr = d.toLocaleDateString('sl-SI', { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' });
        // Format YYYY-MM-DD za input
        const isoDate = d.toISOString().split('T')[0];
        
        const html = `
            <div class="date-tape">
                <div class="tape-arrow" onclick="app.changeDate(-1, '${containerId}', '${onChangeCallback}')">‚Üê</div>
                <div class="tape-center" onclick="document.getElementById('tape-picker-${containerId}').showPicker()">
                    <span id="tape-label-${containerId}">${dStr}</span>
                    <input type="date" id="tape-picker-${containerId}" value="${isoDate}" 
                           style="width:0; height:0; opacity:0; position:absolute;" 
                           onchange="app.setDate(this.value, '${containerId}', '${onChangeCallback}')">
                </div>
                <div class="tape-arrow" onclick="app.changeDate(1, '${containerId}', '${onChangeCallback}')">‚Üí</div>
            </div>
            <div style="text-align:center; font-size:0.8em; color:gray; margin-top:-15px; margin-bottom:15px;">
                Klikni na sredino za koledar, ali pu≈°ƒçice za +/- 1 dan.
            </div>
        `;
        return html;
    },

    changeDate: function(delta, containerId, cbName) {
        this.currentDate.setDate(this.currentDate.getDate() + delta);
        this.refreshView(cbName);
    },

    setDate: function(val, containerId, cbName) {
        if(!val) return;
        this.currentDate = new Date(val);
        this.refreshView(cbName);
    },

    refreshView: function(cbName) {
        // Dinamiƒçni klic funkcije za ponoven render
        const fn = cbName.split('.').reduce((o, i) => o[i], window);
        if(typeof fn === 'function') fn();
    },

    /* --- DNEVNIK (URNIK) --- */
    renderSchedule: function() {
        const content = document.getElementById('main-content');
        const dateKey = this.currentDate.toISOString().split('T')[0];
        const teacherSched = this.db.schedules[`${dateKey}_${this.user.id}`] || {};

        let grid = `<table class="schedule-table"><thead><tr>`;
        for(let i=1; i<=9; i++) grid += `<th>${i}.</th>`;
        grid += `</tr></thead><tbody><tr>`;
        
        for(let i=1; i<=9; i++) {
            const classId = teacherSched[i];
            if(classId && classId !== 'P') {
                const cls = this.db.classes.find(c => c.id === classId);
                const cName = cls ? cls.name : '?';
                grid += `<td onclick="app.openHourModal(${i}, '${classId}', '${cName}')"><b>${cName}</b></td>`;
            } else {
                grid += `<td class="crossed-out">P</td>`;
            }
        }
        grid += `</tr></tbody></table>`;

        content.innerHTML = `
            <h3>MOJ DNEVNI URNIK</h3>
            ${this.renderDateTape('sched', 'app.renderSchedule')}
            ${grid}
            <div style="margin-top:20px;">
                <p><b>Navodilo:</b> Kliknite na razred v urniku za vpis ure in odsotnosti.</p>
            </div>
        `;
    },

    openHourModal: function(hour, classId, className) {
        const date = this.currentDate.toISOString().split('T')[0];
        this.tempState = { hour, classId, date, className };
        
        document.getElementById('mh-title').innerText = `${date} | ${hour}. ura | ${className}`;
        
        // Nalo≈æi vsebino
        const log = this.db.hourLogs.find(l => l.date === date && l.hour === hour && l.classId === classId);
        document.getElementById('mh-content').value = log ? log.content : "";
        
        this.renderMissingList();
        
        document.getElementById('modal-hour').style.display = 'flex';
    },

    renderMissingList: function() {
        const { date, hour, classId } = this.tempState;
        const container = document.getElementById('mh-missing-list');
        container.innerHTML = "";
        
        // Najdi odsotne za to uro
        const absents = this.db.absences.filter(a => a.date === date && a.hour === hour && a.studentId && 
            this.db.students.find(s=>s.id === a.studentId && s.classId === classId)); // samo ta razred

        if(absents.length === 0) {
            container.innerHTML = "<i>Vsi prisotni.</i>";
            return;
        }

        absents.forEach(a => {
            const s = this.db.students.find(x => x.id === a.studentId);
            const div = document.createElement('div');
            div.style.marginBottom = "3px";
            div.innerHTML = `
                <span style="color:red; font-weight:bold;">${s.name}</span>
                <span style="cursor:pointer;" onclick="app.removeAbsence('${a.id}')">[X]</span>
                <span style="cursor:pointer;" onclick="app.editAbsenceNote('${a.id}')">‚úèÔ∏è</span>
            `;
            container.appendChild(div);
        });
    },

    openStudentPicker: function() {
        document.getElementById('picker-search').value = "";
        document.getElementById('modal-picker').style.display = 'flex';
        this.renderStudentPicker();
    },

    renderStudentPicker: function() {
        const filter = document.getElementById('picker-search').value.toLowerCase();
        const list = document.getElementById('picker-list');
        const { classId } = this.tempState;
        
        list.innerHTML = "";
        this.db.students
            .filter(s => s.classId === classId && s.name.toLowerCase().includes(filter))
            .forEach(s => {
                list.innerHTML += `<div style="padding:3px; cursor:pointer; border-bottom:1px solid #eee;" onclick="app.addAbsence('${s.id}')">${s.name}</div>`;
            });
    },

    addAbsence: function(sid) {
        const { date, hour } = this.tempState;
        // Prepreƒçi podvojitve
        if(!this.db.absences.find(a => a.date === date && a.hour === hour && a.studentId === sid)) {
            this.db.absences.push({ id: gid(), date, hour, studentId: sid, status: 'pending', note: '' });
            this.saveDB();
        }
        this.closeModal('modal-picker');
        this.renderMissingList();
    },

    removeAbsence: function(aid) {
        this.db.absences = this.db.absences.filter(a => a.id !== aid);
        this.saveDB();
        this.renderMissingList();
    },

    editAbsenceNote: function(aid) {
        const abs = this.db.absences.find(a => a.id === aid);
        const s = this.db.students.find(x => x.id === abs.studentId);
        this.tempState.currentAbsenceId = aid;
        document.getElementById('mn-info').innerText = `Opomba za: ${s.name}`;
        document.getElementById('mn-text').value = abs.note || "";
        document.getElementById('modal-note').style.display = 'flex';
    },

    saveAbsenceNote: function() {
        const note = document.getElementById('mn-text').value;
        const abs = this.db.absences.find(a => a.id === this.tempState.currentAbsenceId);
        if(abs) { abs.note = note; this.saveDB(); }
        this.closeModal('modal-note');
    },

    saveHourLog: function() {
        const { date, hour, classId } = this.tempState;
        const content = document.getElementById('mh-content').value;
        
        const existing = this.db.hourLogs.find(l => l.date === date && l.hour === hour && l.classId === classId);
        if(existing) {
            existing.content = content;
            existing.teacherId = this.user.id;
        } else {
            this.db.hourLogs.push({ id: gid(), date, hour, classId, teacherId: this.user.id, content });
        }
        this.saveDB();
        this.closeModal('modal-hour');
        alert("Vpis ure shranjen.");
    },

    /* --- ODSOTNOST (OPRAVIƒåEVANJE) --- */
    renderAbsence: function() {
        const content = document.getElementById('main-content');
        
        // Pripravi seznam razredov
        const classOpts = this.db.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        
        // Preberi zadnjo izbiro iz tempState ali default
        const selectedClass = this.tempState.absClassId || (this.db.classes[0] ? this.db.classes[0].id : '');
        const viewMode = this.tempState.absView || 'general'; // general | detail

        // Render glave
        let html = `
            <h3>UREJANJE ODSOTNOSTI (PRAVO GARANJE!)</h3>
            <div style="margin-bottom:10px; border:2px groove white; padding:5px;">
                Razred: <select id="abs-cls" onchange="app.setAbsClass(this.value)">${classOpts}</select>
                <button class="retro-btn ${viewMode==='general'?'active':''}" onclick="app.setAbsView('general')">SPLO≈†NO</button>
                <button class="retro-btn ${viewMode==='detail'?'active':''}" onclick="app.setAbsView('detail')">PODROBNO</button>
            </div>
        `;

        if(!selectedClass) { content.innerHTML = html + "Ni razredov."; return; }
        
        // Nastavi select value
        setTimeout(() => { if(document.getElementById('abs-cls')) document.getElementById('abs-cls').value = selectedClass; }, 0);

        const students = this.db.students.filter(s => s.classId === selectedClass);

        if(viewMode === 'general') {
            html += `<table><thead><tr><th>Uƒçenec</th><th>Opraviƒçeno</th><th>Neopraviƒçeno</th><th>ƒåaka (Odprto)</th></tr></thead><tbody>`;
            students.forEach(s => {
                const myAbs = this.db.absences.filter(a => a.studentId === s.id);
                const exc = myAbs.filter(a => a.status === 'excused').length;
                const unexc = myAbs.filter(a => a.status === 'unexcused').length;
                const pend = myAbs.filter(a => a.status === 'pending').length;
                
                // Vrstica je klikljiva -> gre na podrobno za tega dijaka (implementacija: preklopi na detail in filtrira samo njega - ali preprosto gre na detail view)
                html += `<tr onclick="app.setAbsView('detail')" style="cursor:pointer;">
                    <td><b>${s.name}</b></td><td>${exc}</td><td>${unexc}</td><td>${pend}</td>
                </tr>`;
            });
            html += `</tbody></table><p><i>Kliknite na vrstico za podroben pregled.</i></p>`;
        } else {
            // DETAILED VIEW (MATRIKA)
            html += this.renderDateTape('abs', 'app.renderAbsence');
            const dateStr = this.currentDate.toISOString().split('T')[0];

            html += `<table><thead><tr><th>Ime in Priimek</th>`;
            for(let i=1; i<=9; i++) html += `<th>${i}.</th>`;
            html += `</tr></thead><tbody>`;

            students.forEach(s => {
                html += `<tr><td><b>${s.name}</b></td>`;
                for(let h=1; h<=9; h++) {
                    const abs = this.db.absences.find(a => a.studentId === s.id && a.date === dateStr && a.hour === h);
                    let cellClass = "matrix-cell";
                    let cellContent = "";

                    if(abs) {
                        if(abs.status === 'excused') cellClass += " cell-excused";
                        else if(abs.status === 'unexcused') cellClass += " cell-unexcused";
                        if(abs.note) cellClass += " has-note"; // Rumeno ƒçe je opomba

                        // ƒåe je rumeno, klik odpre opombo
                        const noteAction = abs.note ? `title="Opomba: ${abs.note}"` : "";

                        cellContent = `
                            <button class="btn-mini" onclick="app.setAbsStatus('${abs.id}', 'excused')" ondblclick="app.massAbsence('${s.id}', '${dateStr}', 'excused')">O</button>
                            <button class="btn-mini" onclick="app.setAbsStatus('${abs.id}', 'unexcused')" ondblclick="app.massAbsence('${s.id}', '${dateStr}', 'unexcused')">N</button>
                            <button class="btn-mini" onclick="app.deleteAbsence('${abs.id}')" ondblclick="app.massDeleteAbsence('${s.id}', '${dateStr}')">X</button>
                        `;
                        
                        // Dodaj indikator opombe
                        if(abs.note) cellContent += `<div style="font-size:0.6em; cursor:help;" onclick="alert('${abs.note}')">üìù</div>`;
                    }

                    html += `<td class="${cellClass}">${cellContent}</td>`;
                }
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            html += `<p style="font-size:0.8em;">Legenda: O=Opraviƒçi (Zeleno), N=Neopraviƒçi (Rdeƒçe), X=Izbri≈°i. 2x klik na gumb uporabi za cel dan. Rumena celica = Opomba.</p>`;
        }

        content.innerHTML = html;
    },

    setAbsClass: function(cid) { this.tempState.absClassId = cid; this.renderAbsence(); },
    setAbsView: function(mode) { this.tempState.absView = mode; this.renderAbsence(); },

    setAbsStatus: function(aid, status) {
        const a = this.db.absences.find(x => x.id === aid);
        if(a) { a.status = status; this.saveDB(); this.renderAbsence(); }
    },
    deleteAbsence: function(aid) {
        this.db.absences = this.db.absences.filter(x => x.id !== aid);
        this.saveDB(); this.renderAbsence();
    },
    // Masovno urejanje (double click)
    massAbsence: function(sid, date, status) {
        this.db.absences.forEach(a => {
            if(a.studentId === sid && a.date === date) a.status = status;
        });
        this.saveDB(); this.renderAbsence();
    },
    massDeleteAbsence: function(sid, date) {
        this.db.absences = this.db.absences.filter(a => !(a.studentId === sid && a.date === date));
        this.saveDB(); this.renderAbsence();
    },

    /* --- REDOVALNICA & MRE≈ΩNI PLAN (INTEGRACIJA) --- */
    renderGrades: function() {
        // Poenostavljena logika iz prej≈°njega fajla, prilagojena na to strukturo
        const content = document.getElementById('main-content');
        const subjects = ["Sloven≈°ƒçina", "Matematika", "Angle≈°ƒçina", "Zgodovina"]; // Hardcoded za demo ali iz baze
        
        let html = `<h3>REDOVALNICA</h3>`;
        html += `<label>Razred:</label> <select id="gr-cls" onchange="app.renderGradesTable(this.value)">`;
        this.db.classes.forEach(c => html += `<option value="${c.id}">${c.name}</option>`);
        html += `</select> <label>Predmet:</label> <select id="gr-sub">${subjects.map(s=>`<option>${s}</option>`)}</select>`;
        html += `<button class="retro-btn" onclick="app.renderGradesTable(document.getElementById('gr-cls').value)">Prika≈æi</button>`;
        html += `<div id="grades-container" style="margin-top:15px;"></div>`;
        content.innerHTML = html;
        // Auto load first
        if(this.db.classes.length) setTimeout(()=>app.renderGradesTable(this.db.classes[0].id), 100);
    },

    renderGradesTable: function(cid) {
        const sub = document.getElementById('gr-sub').value;
        const students = this.db.students.filter(s => s.classId === cid);
        const container = document.getElementById('grades-container');
        
        if(!cid || !sub) return;

        let tbl = `<table><thead><tr><th>Uƒçenec</th><th>1. Konf</th><th>2. Konf</th><th>Konƒçna</th></tr></thead><tbody>`;
        students.forEach(s => {
            tbl += `<tr>
                <td>${s.name}</td>
                <td onclick="app.gradePrompt('${s.id}', '${sub}', 1)">${this.getGradesStr(s.id, sub, 1)}</td>
                <td onclick="app.gradePrompt('${s.id}', '${sub}', 2)">${this.getGradesStr(s.id, sub, 2)}</td>
                <td onclick="app.gradePrompt('${s.id}', '${sub}', 0)"><b>${this.getGradesStr(s.id, sub, 0)}</b></td>
            </tr>`;
        });
        tbl += `</tbody></table><p>Klikni v celico za vnos ocene.</p>`;
        container.innerHTML = tbl;
    },

    getGradesStr: function(sid, sub, period) {
        return this.db.grades
            .filter(g => g.sid === sid && g.sub === sub && g.period === period)
            .map(g => `<span style="color:${g.type==='PISNO'?'red':'black'}">${g.val}</span>`)
            .join(' ');
    },

    gradePrompt: function(sid, sub, period) {
        const val = prompt("Vpi≈°i oceno (ali pusti prazno za preklic):");
        if(val) {
            // Tip ocene? Poenostavljeno: ƒçe je ≈°tevilka, vpra≈°amo ≈°e tip
            const type = confirm("Je to pisna ocena? (OK = Pisno/Rdeƒçe, Cancel = Ustno/ƒårno)") ? 'PISNO' : 'USTNO';
            this.db.grades.push({ id: gid(), sid, sub, period, val, type });
            this.saveDB();
            this.renderGradesTable(this.db.students.find(s=>s.id===sid).classId);
        }
    },

    /* --- PROFIL --- */
    renderProfile: function() {
        const u = this.user;
        const content = document.getElementById('main-content');
        content.innerHTML = `
            <h3>MOJ PROFIL</h3>
            <div style="background:#eee; padding:20px; border:2px inset white; max-width:600px;">
                <p><b>Ime in Priimek:</b> ${u.name}</p>
                <p><b>Uporabni≈°ko ime:</b> ${u.username}</p>
                <p><b>Vloga:</b> ${u.role === 'teacher' ? 'Uƒçitelj' : 'Admin'}</p>
                <hr>
                <label>Spremeni geslo:</label><br>
                <input type="password" id="p-pass" value="${u.password}"><br><br>
                
                ${u.role === 'teacher' ? `
                <label>ƒåas seje (min):</label><br>
                <input type="number" id="p-time" value="${u.sessionTime || 30}"><br><br>
                ` : ''}

                <button class="retro-btn" onclick="app.saveProfile()">SHRANI SPREMEMBE</button>
            </div>
        `;
    },

    saveProfile: function() {
        const pass = document.getElementById('p-pass').value;
        this.user.password = pass;
        if(this.user.role === 'teacher') {
            const time = parseInt(document.getElementById('p-time').value);
            this.user.sessionTime = time;
        }
        // Update user in DB array
        const idx = this.db.users.findIndex(x => x.id === this.user.id);
        if(idx >= 0) this.db.users[idx] = this.user;
        
        this.saveDB();
        alert("Podatki shranjeni.");
    },

    /* --- ADMIN DEL --- */
    renderAdminProfile: function() { this.renderProfile(); }, // Admin uporablja isti profil view

    adminTeachers: function() {
        const content = document.getElementById('main-content');
        let html = `<h3>Upravljanje Uƒçiteljev</h3>
        <div style="margin-bottom:10px; border:1px solid gray; padding:10px;">
            Ime: <input id="nt-name"> User: <input id="nt-user"> Pass: <input id="nt-pass">
            Seja (min): <input id="nt-time" type="number" value="30" style="width:50px;">
            <button class="retro-btn" onclick="app.addTeacher()">DODAJ</button>
        </div>
        <table><tr><th>Ime</th><th>User</th><th>Pass</th><th>Seja</th><th>Akcija</th></tr>`;
        
        this.db.users.filter(u => u.role === 'teacher').forEach(t => {
            html += `<tr><td>${t.name}</td><td>${t.username}</td><td>${t.password}</td><td>${t.sessionTime||30} min</td>
            <td><button class="retro-btn" onclick="app.delUser('${t.id}')">BRI≈†I</button></td></tr>`;
        });
        content.innerHTML = html + `</table>`;
    },

    addTeacher: function() {
        const name = document.getElementById('nt-name').value;
        const user = document.getElementById('nt-user').value;
        const pass = document.getElementById('nt-pass').value;
        const time = document.getElementById('nt-time').value;
        if(name && user && pass) {
            this.db.users.push({ id: gid(), name, username: user, password: pass, role: 'teacher', sessionTime: time });
            this.saveDB(); this.adminTeachers();
        }
    },

    delUser: function(id) {
        if(confirm("Res bri≈°em?")) {
            this.db.users = this.db.users.filter(u => u.id !== id);
            this.saveDB(); this.adminTeachers();
        }
    },

    adminClasses: function() {
        const content = document.getElementById('main-content');
        let html = `<h3>Upravljanje Razredov</h3>
        <div style="margin-bottom:10px;">
            Ime razreda: <input id="nc-name"> <br>
            Dijaki (vsak v svojo vrstico): <br><textarea id="nc-students" rows="5" style="width:300px;"></textarea><br>
            <button class="retro-btn" onclick="app.addClass()">USTVARI RAZRED</button>
        </div>
        <hr>`;
        this.db.classes.forEach(c => {
            html += `<div style="border:1px solid gray; padding:5px; margin-bottom:5px;">
                <b>${c.name}</b> <button class="retro-btn" onclick="app.delClass('${c.id}')">X</button><br>
                <small>${this.db.students.filter(s => s.classId === c.id).map(s => s.name).join(', ')}</small>
            </div>`;
        });
        content.innerHTML = html;
    },

    addClass: function() {
        const name = document.getElementById('nc-name').value;
        const raw = document.getElementById('nc-students').value;
        if(name) {
            const cid = gid();
            this.db.classes.push({ id: cid, name });
            if(raw) {
                raw.split('\n').forEach(line => {
                    const n = line.trim();
                    if(n) {
                        const uname = makeUser(n);
                        this.db.students.push({ id: gid(), classId: cid, name: n, username: uname, password: uname }); // pass = uname
                    }
                });
            }
            this.saveDB(); this.adminClasses();
        }
    },
    
    delClass: function(cid) {
        if(confirm("Bri≈°em razred in vse dijake?")) {
            this.db.classes = this.db.classes.filter(c => c.id !== cid);
            this.db.students = this.db.students.filter(s => s.classId !== cid);
            this.saveDB(); this.adminClasses();
        }
    },

    /* --- DIJAK POGLEDI --- */
    renderStudentGrades: function() {
        // Samo read-only tabela
        const content = document.getElementById('main-content');
        const subjects = ["Sloven≈°ƒçina", "Matematika", "Angle≈°ƒçina", "Zgodovina"];
        let html = `<h3>MOJE OCENE</h3><table><tr><th>Predmet</th><th>1. Konf</th><th>2. Konf</th><th>Konƒçna</th></tr>`;
        subjects.forEach(sub => {
            html += `<tr><td>${sub}</td>
            <td>${this.getGradesStr(this.user.id, sub, 1)}</td>
            <td>${this.getGradesStr(this.user.id, sub, 2)}</td>
            <td><b>${this.getGradesStr(this.user.id, sub, 0)}</b></td></tr>`;
        });
        content.innerHTML = html + "</table>";
    },

    renderStudentAbsence: function() {
        const content = document.getElementById('main-content');
        const myAbs = this.db.absences.filter(a => a.studentId === this.user.id);
        let html = `<h3>MOJE ODSOTNOSTI</h3>
        <p>Opraviƒçeno: <b>${myAbs.filter(a=>a.status==='excused').length}</b> | 
           Neopraviƒçeno: <b style="color:red">${myAbs.filter(a=>a.status==='unexcused').length}</b> | 
           ƒåaka: <b>${myAbs.filter(a=>a.status==='pending').length}</b></p>
        <table><tr><th>Datum</th><th>Ura</th><th>Status</th></tr>`;
        myAbs.forEach(a => {
            const st = a.status === 'excused' ? 'Opraviƒçeno' : (a.status === 'unexcused' ? 'Neopraviƒçeno' : 'ƒåaka');
            html += `<tr><td>${a.date}</td><td>${a.hour}</td><td>${st}</td></tr>`;
        });
        content.innerHTML = html + "</table>";
    },
    
    renderStudentPlan: function() {
        document.getElementById('main-content').innerHTML = "<h3>Mre≈æni plan</h3><p>Ni vnosov.</p>"; 
    },
    renderPlan: function() {
         document.getElementById('main-content').innerHTML = "<h3>Mre≈æni plan</h3><p>Modul v izdelavi...</p>";
    },
    
    /* --- UTILS --- */
    closeModal: function(id) { document.getElementById(id).style.display = 'none'; }
};

// Start
app.init();
</script>
</body>
</html>
