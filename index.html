<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MINDEX - informacijski sistem</title>
<style>
  /* --- Minimal, čista, responsive styles (no heavy design) --- */
  :root{
    --bg:#f4f6f8;
    --card:#fff;
    --accent:#1f6feb;
    --danger:#d9534f;
    --muted:#666;
    --ok:#2e8b57;
    --maxWidth:1100px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, Roboto,Arial, Helvetica, sans-serif;
    background:var(--bg);
    color:#111;
    line-height:1.3;
    padding:12px;
    -webkit-font-smoothing:antialiased;
  }
  .container{max-width:var(--maxWidth);margin:0 auto;}
  header.appbar{
    display:flex;align-items:center;gap:12px;background:var(--card);
    padding:10px;border-radius:8px;margin-bottom:12px;
    box-shadow:0 1px 2px rgba(0,0,0,.05);
  }
  header.appbar h1{font-size:18px;margin:0}
  header.appbar .user{margin-left:auto;font-size:14px;color:var(--muted)}
  nav.tabs{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
  nav.tabs button{padding:8px 10px;border-radius:6px;border:1px solid #e2e6ea;background:white;cursor:pointer}
  nav.tabs button.active{background:var(--accent);color:white;border-color:var(--accent)}
  .card{background:var(--card);padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .col{flex:1;min-width:200px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border:1px solid #e6eaef;text-align:left;font-size:14px}
  th{background:#f8fafc}
  input[type="text"],input[type="password"],input[type="date"],select,textarea{
    width:100%;padding:8px;border:1px solid #d7dae0;border-radius:6px;font-size:14px
  }
  button.btn{padding:8px 10px;border-radius:6px;border:0;cursor:pointer}
  button.primary{background:var(--accent);color:white}
  button.warn{background:var(--danger);color:white}
  small.muted{color:var(--muted);font-size:12px}
  .flex{display:flex;gap:8px;align-items:center}
  .center{text-align:center}
  .slot{border:1px dashed #ddd;padding:6px;border-radius:6px;min-height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .slot.free{background:#fff}
  .slot.open{background:#fff}
  .slot.saved{background:#e6ffec;border:1px solid #b3e6c1}
  .badge{display:inline-block;padding:3px 6px;border-radius:999px;font-size:12px;background:#eee}
  .absent{color:#c0392b;font-weight:bold}
  .present{color:#111}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:9999}
  .modal .dialog{background:white;padding:14px;border-radius:8px;min-width:280px;max-width:720px;box-shadow:0 6px 20px rgba(0,0,0,.2)}
  .modal .dialog h3{margin:0 0 8px 0}
  .modal .row{margin-top:8px}
  /* responsive */
  @media (max-width:720px){
    th,td{font-size:13px}
    header.appbar{flex-direction:column;align-items:flex-start;gap:8px}
    .row{flex-direction:column;align-items:stretch}
  }
  /* small helpers */
  .muted{color:var(--muted)}
  .grid-cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
  .tiny{font-size:12px}
</style>
</head>
<body>
<div class="container">
  <header class="appbar">
    <h1>MINDEX — informacijski sistem</h1>
    <div class="user" id="topInfo">Prijava potrebna</div>
  </header>

  <!-- --- Login screen --- -->
  <div id="loginView" class="card">
    <h2>Prijava</h2>
    <div style="max-width:420px">
      <label>Uporabniško ime</label>
      <input id="loginUser" type="text" placeholder="admin ali profesor..." />
      <label style="margin-top:8px">Geslo</label>
      <input id="loginPass" type="password" placeholder="geslo" />
      <div style="margin-top:8px" class="flex">
        <button class="btn primary" onclick="doLogin()">Prijava</button>
        <button class="btn" onclick="seedDemo()">Naloži demo podatke</button>
        <small class="muted">Ali uporabite podatke admina, ki so navedeni na koncu strani.</small>
      </div>
    </div>
  </div>

  <!-- --- Main app --- -->
  <div id="appView" style="display:none">
    <div class="card" id="adminPanelHeader" style="display:none">
      <div class="row">
        <div><strong id="welcomeTitle">Zdravo</strong></div>
        <div class="muted" id="roleInfo"></div>
        <div class="flex" style="margin-left:auto">
          <div id="currentSelected" class="muted tiny"></div>
          <button class="btn" onclick="logout()">Odjava</button>
        </div>
      </div>
      <nav class="tabs" id="mainTabs"></nav>
    </div>

    <!-- Admin / Professor common containers, content switches by menu -->
    <div id="contentArea">
      <!-- Students -->
      <div id="studentsView" class="card" style="display:none">
        <div class="row">
          <div><h3>Učenci</h3></div>
          <div style="margin-left:auto">
            <button class="btn primary" onclick="openStudentModal()">Dodaj učenca</button>
            <button class="btn" onclick="exportData('students')">Izvozi (JSON)</button>
          </div>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="studentsTable">
            <thead><tr><th>Ime in priimek</th><th>Rojstni datum</th><th>Opombe</th><th>Akcije</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Professors -->
      <div id="teachersView" class="card" style="display:none">
        <div class="row">
          <div><h3>Profesorji</h3></div>
          <div style="margin-left:auto">
            <button class="btn primary" onclick="openTeacherModal()">Dodaj profesorja</button>
            <button class="btn" onclick="exportData('teachers')">Izvozi (JSON)</button>
          </div>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="teachersTable">
            <thead><tr><th>Ime</th><th>Up. ime</th><th>Predmet</th><th>Akcije</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Classes -->
      <div id="classesView" class="card" style="display:none">
        <div class="row">
          <div><h3>Razredi</h3></div>
          <div style="margin-left:auto">
            <button class="btn primary" onclick="openClassModal()">Ustvari/uredi razred</button>
            <button class="btn" onclick="exportData('classes')">Izvozi (JSON)</button>
          </div>
        </div>
        <div style="margin-top:8px">
          <table id="classesTable">
            <thead><tr><th>Ime razreda</th><th>Št. učencev</th><th>Akcije</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Timetables -->
      <div id="schedulesView" class="card" style="display:none">
        <h3>Ureditev urnika</h3>
        <div class="row">
          <div class="col">
            <label>Uredi za:</label>
            <select id="scheduleTargetType">
              <option value="prof">Profesor</option>
              <option value="class">Razred</option>
            </select>
          </div>
          <div class="col" id="profSelectCol">
            <label>Izberi profesorja</label>
            <select id="scheduleProf"></select>
          </div>
          <div class="col" id="classSelectCol" style="display:none">
            <label>Izberi razred</label>
            <select id="scheduleClass"></select>
          </div>
          <div class="col">
            <label>Datum</label>
            <input id="scheduleDate" type="date" />
          </div>
          <div class="col" style="min-width:140px;align-self:end">
            <button class="btn primary" onclick="loadEditorSchedule()">Naloži urnik</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="row">
            <div><strong>Ure (1 - 8)</strong></div>
            <div style="margin-left:auto"><small class="muted">Klikni na posamezno uro za določitev razreda ali P (prosta ura).</small></div>
          </div>
          <div style="margin-top:8px" id="scheduleEditor"></div>
          <div style="margin-top:8px" class="row">
            <button class="btn primary" onclick="saveEditorSchedule()">Shrani urnik</button>
            <button class="btn" onclick="clearEditorSchedule()">Počisti</button>
          </div>
        </div>
      </div>

      <!-- Professor dashboard -->
      <div id="profView" class="card" style="display:none">
        <div class="row">
          <div><h3>Profesor — urnik</h3></div>
          <div style="margin-left:auto">
            <button class="btn" onclick="openGradebook()">Redovalnica</button>
            <button class="btn" onclick="openClassView()">Razred</button>
            <button class="btn" onclick="openHome()">Domov</button>
          </div>
        </div>

        <div style="margin-top:8px" class="row">
          <div class="col">
            <label>Datum</label>
            <input id="profDate" type="date" onchange="renderProfSchedule()" />
          </div>
          <div class="col">
            <label>Izberi razred za prikaz (ali prazno)</label>
            <select id="profClassFilter" onchange="renderProfSchedule()">
              <option value="">-- vsi --</option>
            </select>
          </div>
        </div>

        <div id="profScheduleArea" style="margin-top:12px"></div>
      </div>

      <!-- Redovalnica (poenostavljeno) -->
      <div id="gradebookView" class="card" style="display:none">
        <h3>Redovalnica</h3>
        <div class="muted tiny">Izberi razred, da vidiš učence in dodaš ocene.</div>
        <div style="margin-top:8px" class="row">
          <div class="col">
            <label>Razred</label>
            <select id="gradeClassSelect" onchange="renderGradebook()"></select>
          </div>
        </div>
        <div id="gradebookTableArea" style="margin-top:8px"></div>
      </div>

      <!-- Razred view (attendance summary for teacher) -->
      <div id="classView" class="card" style="display:none">
        <h3>Razred — pregled odsotnosti</h3>
        <div class="row">
          <div class="col">
            <label>Razred</label>
            <select id="classViewSelect" onchange="renderClassAttendance()"></select>
          </div>
        </div>
        <div id="classAttendanceArea" style="margin-top:8px"></div>
      </div>

      <!-- Home simple -->
      <div id="homeView" class="card" style="display:none">
        <h3>Domov</h3>
        <p>Dobrodošli v MINDEX. Izberite meni ali se prijavite kot drug uporabnik.</p>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="modal" class="modal">
  <div class="dialog" id="modalDialog">
    <!-- dynamic content -->
  </div>
</div>

<script>
/* =========================
   Data model (localStorage)
   =========================
   We keep:
   - users: {username, pass, role('admin'|'prof'), displayName, teacherId?}
   - students: array of {id, name, dob, notes}
   - teachers: array of {id, name, username, password, subject}
   - classes: array of {id, name, studentIds:[]}
   - schedules: object keyed by key = type|id|date -> {slots: [ "P" or classId or teacherId? for prof?"] } 
       For editing by professor: if editing professor, slots contain classId or "P"
       For class schedule: slots contain teacherId or "P"
   - attendance: object keyed by date|classId -> {hour -> {teacherId, topic, absences: {studentId: true/false}}}
   - grades: per student per period (simplified)
*/

const STORAGE_KEY = 'mindex_v1';

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    return {
      users: [],
      students: [],
      teachers: [],
      classes: [],
      schedules: {}, // key -> slots array (1..8)
      attendance: {}, // key date|classId -> {hour: {teacherId, topic, absences:{}}}
      grades: {} // studentId -> {period1: [...], period2: [...], final: value}
    };
  }
  try{ return JSON.parse(raw); }
  catch(e){ console.error('parse error', e); return {};}
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

let state = loadState();
let session = {user:null}; // runtime

/* ----- Utilities ----- */
function uid(prefix='id'){ return prefix+'_'+Math.random().toString(36).slice(2,9); }
function byId(arr,id){ return arr.find(x=>x.id===id); }
function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }

/* ----- Initial seeds & demo ------------------------------------------------ */
function ensureAdmin(){
  // if no admin exists, create default admin
  const hasAdmin = state.users.some(u=>u.role==='admin');
  if (!hasAdmin){
    state.users.push({username:'admin',password:'admin123',role:'admin',displayName:'Administrator'});
    saveState();
  }
}
ensureAdmin();

/* Optional demo seed */
function seedDemo(){
  // create demo data if not present
  if (state.students.length || state.teachers.length || state.classes.length){
    if (!confirm('V sistemu so že podatki. Prepišem z demo podatki?')) return;
    state = {users:[], students:[], teachers:[], classes:[], schedules:{}, attendance:{}, grades:{}};
  }
  // admin
  state.users.push({username:'admin',password:'admin123',role:'admin',displayName:'Administrator'});
  // teachers
  const t1 = uid('t'); const t2 = uid('t');
  state.teachers.push({id:t1,name:'Gorazd Novak',username:'gnovak',password:'gpass',subject:'Matematika'});
  state.teachers.push({id:t2,name:'Barbara Kranjc',username:'bkranjc',password:'bpass',subject:'Slovenščina'});
  state.users.push({username:'gnovak',password:'gpass',role:'prof',displayName:'Gorazd Novak',teacherId:t1});
  state.users.push({username:'bkranjc',password:'bpass',role:'prof',displayName:'Barbara Kranjc',teacherId:t2});
  // students
  const s = [];
  ['Novak Simon','Nugovička Pika','Ocepek Matija','Ogorevc Jaka','Kovač Ana','Kralj Žiga','Zupan Tjaša'].forEach((n,i)=>{
    const id=uid('s'); s.push({id,name:n,dob:'2007-01-'+String(i+10).padStart(2,'0'),notes:''});
  });
  state.students = s;
  // class
  const classId = uid('c');
  state.classes.push({id:classId,name:'1A',studentIds: s.slice(0,5).map(x=>x.id)});
  state.classes.push({id:uid('c'),name:'2B',studentIds: s.slice(5).map(x=>x.id)});
  // schedules empty
  saveState();
  alert('Demo podatki naloženi. Prijavite se kot admin (admin / admin123) ali kot prof (gnovak/gpass).');
}

/* ----- Auth ----- */
function doLogin(){
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  if (!user || !pass) { alert('Vnesi uporabniško ime in geslo'); return; }
  const u = state.users.find(x=>x.username===user && x.password===pass);
  if (!u){ alert('Neveljavni podatki'); return; }
  session.user = u;
  initAppAfterLogin();
}

/* Logout */
function logout(){
  session.user = null;
  document.getElementById('appView').style.display='none';
  document.getElementById('loginView').style.display='block';
  document.getElementById('topInfo').textContent = 'Prijava potrebna';
  document.getElementById('loginUser').value=''; document.getElementById('loginPass').value='';
}

/* ----- UI boot after login ----- */
function initAppAfterLogin(){
  document.getElementById('loginView').style.display='none';
  document.getElementById('appView').style.display='block';
  document.getElementById('topInfo').textContent = session.user.displayName + ' (' + session.user.role + ')';
  document.getElementById('adminPanelHeader').style.display = session.user.role === 'admin' ? 'block' : 'flex';
  document.getElementById('welcomeTitle').textContent = 'Pozdravljeni, ' + session.user.displayName;
  document.getElementById('roleInfo').textContent = session.user.role === 'admin' ? 'Administrator' : 'Profesor';
  buildMainTabs();
  // show default view
  if (session.user.role === 'admin'){
    showTab('studentsView');
    renderStudents();
    renderTeachers();
    renderClasses();
    populateScheduleSelectors();
  } else {
    // professor
    showProfessorHome();
    populateProfessorClassFilters();
  }
}

/* ----- Tabs for admin ----- */
function buildMainTabs(){
  const tabs = document.getElementById('mainTabs');
  tabs.innerHTML = '';
  if (session.user.role === 'admin'){
    addTab('Učenci','studentsView'); addTab('Profesorji','teachersView'); addTab('Razredi','classesView'); addTab('Urniki','schedulesView');
  } else {
    addTab('Domov','homeView'); addTab('Redovalnica','gradebookView'); addTab('Razred','classView');
  }
}
function addTab(label,targetId){
  const tabs = document.getElementById('mainTabs');
  const b = document.createElement('button'); b.textContent = label;
  b.onclick = ()=>{ showTab(targetId); };
  tabs.appendChild(b);
}
function showTab(id){
  // hide all main views
  const views = ['studentsView','teachersView','classesView','schedulesView','profView','gradebookView','classView','homeView'];
  views.forEach(v=>document.getElementById(v).style.display='none');
  document.getElementById(id).style.display = 'block';
  // activate tab look
  Array.from(document.querySelectorAll('#mainTabs button')).forEach(btn=>btn.classList.remove('active'));
  const btns = Array.from(document.querySelectorAll('#mainTabs button')).find(b=>b.textContent && b.onclick && b.onclick.toString().includes(id));
  // fallback: if not find, mark by text
  Array.from(document.querySelectorAll('#mainTabs button')).forEach(b=>{
    if (b.textContent && b.textContent.toLowerCase().includes(id.replace('View','').toLowerCase())) b.classList.add('active');
  });
}

/* ----- STUDENTS CRUD ----- */
function renderStudents(){
  const tbody = document.querySelector('#studentsTable tbody'); tbody.innerHTML='';
  state.students.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td>
      <td>${s.dob||''}</td>
      <td>${s.notes||''}</td>
      <td>
        <button class="btn" onclick="editStudent('${s.id}')">Uredi</button>
        <button class="btn warn" onclick="deleteStudent('${s.id}')">Izbriši</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
function openStudentModal(editId){
  const isEdit = !!editId;
  const s = isEdit ? byId(state.students,editId) : {id:uid('s'), name:'', dob:'', notes:''};
  showModal(`
    <h3>${isEdit?'Uredi učenca':'Dodaj učenca'}</h3>
    <label>Ime in priimek</label><input id="m_name" value="${s.name.replace(/"/g,'&quot;')}" />
    <label>Rojstni datum</label><input id="m_dob" type="date" value="${s.dob||''}" />
    <label>Opombe</label><textarea id="m_notes">${s.notes||''}</textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" onclick="saveStudent('${s.id}')">Shrani</button>
      <button class="btn" onclick="closeModal()">Prekliči</button>
      ${isEdit?'<button class="btn warn" onclick="deleteStudent(\\''+s.id+'\\')">Izbriši</button>':''}
    </div>
  `);
}
function saveStudent(id){
  const name = document.getElementById('m_name').value.trim();
  const dob = document.getElementById('m_dob').value;
  const notes = document.getElementById('m_notes').value;
  if (!name){ alert('Vnesi ime'); return; }
  const exists = byId(state.students,id);
  if (exists){
    exists.name = name; exists.dob = dob; exists.notes = notes;
  } else {
    state.students.push({id,name,dob,notes});
  }
  saveState(); renderStudents(); closeModal();
}
function editStudent(id){ openStudentModal(id); }
function deleteStudent(id){
  if (!confirm('Izbrišem učenca?')) return;
  state.students = state.students.filter(s=>s.id!==id);
  // remove from classes
  state.classes.forEach(c=> c.studentIds = c.studentIds.filter(x=>x!==id));
  saveState(); renderStudents(); renderClasses();
}

/* ----- TEACHERS CRUD ----- */
function renderTeachers(){
  const tbody = document.querySelector('#teachersTable tbody'); tbody.innerHTML='';
  state.teachers.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.name}</td>
      <td>${t.username||''}</td>
      <td>${t.subject||''}</td>
      <td>
        <button class="btn" onclick="editTeacher('${t.id}')">Uredi</button>
        <button class="btn warn" onclick="deleteTeacher('${t.id}')">Izbriši</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
function openTeacherModal(editId){
  const isEdit = !!editId;
  const t = isEdit ? byId(state.teachers,editId) : {id:uid('t'),name:'',username:'',password:'',subject:''};
  showModal(`
    <h3>${isEdit?'Uredi profesorja':'Dodaj profesorja'}</h3>
    <label>Ime</label><input id="m_t_name" value="${t.name.replace(/"/g,'&quot;')}" />
    <label>Uporabniško ime</label><input id="m_t_user" value="${t.username||''}" />
    <label>Geslo</label><input id="m_t_pass" type="password" value="${t.password||''}" />
    <label>Predmet</label><input id="m_t_subj" value="${t.subject||''}" />
    <div class="row" style="margin-top:8px">
      <button class="btn primary" onclick="saveTeacher('${t.id}')">Shrani</button>
      <button class="btn" onclick="closeModal()">Prekliči</button>
      ${isEdit?'<button class="btn warn" onclick="deleteTeacher(\\''+t.id+'\\')">Izbriši</button>':''}
    </div>
  `);
}
function saveTeacher(id){
  const name = document.getElementById('m_t_name').value.trim();
  const username = document.getElementById('m_t_user').value.trim();
  const password = document.getElementById('m_t_pass').value;
  const subject = document.getElementById('m_t_subj').value.trim();
  if (!name || !username){ alert('Ime in uporabniško ime obvezno'); return; }
  const exists = byId(state.teachers,id);
  if (exists){
    // update teacher and user mapping
    exists.name = name; exists.username = username; exists.password = password; exists.subject = subject;
    // update users entry if exists
    const user = state.users.find(u=>u.teacherId===id);
    if (user){ user.username = username; user.password = password; user.displayName = name; }
  } else {
    state.teachers.push({id,name,username,password,subject});
    state.users.push({username,password,role:'prof',displayName:name,teacherId:id});
  }
  saveState(); renderTeachers(); populateScheduleSelectors(); closeModal();
}
function editTeacher(id){ openTeacherModal(id); }
function deleteTeacher(id){
  if (!confirm('Izbrišem profesorja?')) return;
  state.teachers = state.teachers.filter(t=>t.id!==id);
  state.users = state.users.filter(u=>u.teacherId!==id);
  saveState(); renderTeachers(); populateScheduleSelectors();
}

/* ----- CLASSES CRUD and QUICK ADD ----- */
function renderClasses(){
  const tbody = document.querySelector('#classesTable tbody'); tbody.innerHTML='';
  state.classes.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.name}</td><td>${c.studentIds ? c.studentIds.length : 0}</td>
      <td>
        <button class="btn" onclick="openClassModal('${c.id}')">Uredi</button>
        <button class="btn warn" onclick="deleteClass('${c.id}')">Izbriši</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
function openClassModal(editId){
  const isEdit = !!editId;
  const c = isEdit ? byId(state.classes,editId) : {id:uid('c'),name:'',studentIds:[]};
  // build student selection list
  const studentOptions = state.students.map(s=>`<label><input type="checkbox" class="m_student_chk" value="${s.id}" ${c.studentIds.includes(s.id)?'checked':''}/> ${s.name}</label>`).join('<br>');
  showModal(`
    <h3>${isEdit?'Uredi razred':'Ustvari razred'}</h3>
    <label>Ime razreda</label><input id="m_c_name" value="${(c.name||'').replace(/"/g,'&quot;')}" />
    <div style="margin-top:8px">
      <strong>Dodaj učence</strong><br>
      <div style="display:flex;margin-top:6px;gap:8px">
        <button class="btn" onclick="showQuickAdd()">QUICK ADD</button>
        <button class="btn" onclick="showPickAdd()">IZBIRO</button>
      </div>
      <div id="quickAddArea" style="display:none;margin-top:8px">
        <small class="muted">V polje spodaj vpišite vsak učenčev IME in PRIIMEK v svojo vrstico. Če učenec še ne obstaja, bo ustvarjen.</small>
        <textarea id="m_quick_txt" rows="6" style="width:100%;margin-top:6px"></textarea>
      </div>
      <div id="pickAddArea" style="display:none;margin-top:8px;max-height:200px;overflow:auto;border:1px solid #eee;padding:8px">
        ${studentOptions}
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn primary" onclick="saveClass('${c.id}')">Shrani</button>
      <button class="btn" onclick="closeModal()">Prekliči</button>
      ${isEdit?'<button class="btn warn" onclick="deleteClass(\\''+c.id+'\\')">Izbriši</button>':''}
    </div>
    <script>
      function showQuickAdd(){ document.getElementById('quickAddArea').style.display='block'; document.getElementById('pickAddArea').style.display='none'; }
      function showPickAdd(){ document.getElementById('quickAddArea').style.display='none'; document.getElementById('pickAddArea').style.display='block'; }
    </script>
  `);
}
function saveClass(id){
  const name = document.getElementById('m_c_name').value.trim();
  if (!name){ alert('Vnesi ime razreda'); return; }
  const quickArea = document.getElementById('m_quick_txt');
  let studentIds = [];
  if (quickArea && quickArea.value.trim()){
    const lines = quickArea.value.split('\n').map(l=>l.trim()).filter(Boolean);
    lines.forEach(line=>{
      // expect "Ime Priimek"
      const existing = state.students.find(s=>s.name.toLowerCase() === line.toLowerCase());
      if (existing) studentIds.push(existing.id);
      else {
        const nid = uid('s');
        state.students.push({id:nid,name:line,dob:'',notes:''});
        studentIds.push(nid);
      }
    });
  } else {
    // read checkboxes
    const chks = Array.from(document.querySelectorAll('.m_student_chk')).filter(c=>c.checked).map(c=>c.value);
    studentIds = chks;
  }

  const exists = byId(state.classes,id);
  if (exists){
    exists.name = name;
    // merge selected students (if none selected keep existing)
    if (studentIds.length) exists.studentIds = studentIds;
  } else {
    state.classes.push({id,name,studentIds});
  }
  saveState(); renderStudents(); renderClasses(); populateScheduleSelectors(); closeModal();
}
function deleteClass(id){
  if (!confirm('Izbrišem razred?')) return;
  state.classes = state.classes.filter(c=>c.id!==id);
  // remove schedules & attendance associated? We'll leave orphan schedules but it's fine
  saveState(); renderClasses(); populateScheduleSelectors();
}

/* ----- Schedule editor ----- */

function populateScheduleSelectors(){
  const profSel = document.getElementById('scheduleProf');
  const classSel = document.getElementById('scheduleClass');
  profSel.innerHTML = '';
  classSel.innerHTML = '';
  state.teachers.forEach(t=> {
    const o = document.createElement('option'); o.value = t.id; o.textContent = t.name + (t.subject?(' — '+t.subject):'');
    profSel.appendChild(o);
  });
  state.classes.forEach(c=> {
    const o = document.createElement('option'); o.value = c.id; o.textContent = c.name + ' (' + (c.studentIds.length||0) + ' uč.)';
    classSel.appendChild(o);
  });
  // also update professor dropdown in other views
  populateProfessorClassFilters();
  populateClassSelects();
}
function populateProfessorClassFilters(){
  // for professor view: populate their classes if needed
  const el = document.getElementById('profClassFilter');
  el.innerHTML = '<option value="">-- vsi --</option>';
  state.classes.forEach(c=>{
    const o = document.createElement('option'); o.value = c.id; o.textContent = c.name;
    el.appendChild(o);
  });
}
function populateClassSelects(){
  const gradeClass = document.getElementById('gradeClassSelect');
  const classView = document.getElementById('classViewSelect');
  if (gradeClass) { gradeClass.innerHTML = '<option value="">-- izberi --</option>'; state.classes.forEach(c=> gradeClass.appendChild(new Option(c.name,c.id))); }
  if (classView) { classView.innerHTML = '<option value="">-- izberi --</option>'; state.classes.forEach(c=> classView.appendChild(new Option(c.name,c.id))); }
}

/* Editor UI */
function loadEditorSchedule(){
  const type = document.getElementById('scheduleTargetType').value;
  const id = type==='prof' ? document.getElementById('scheduleProf').value : document.getElementById('scheduleClass').value;
  const date = document.getElementById('scheduleDate').value;
  if (!id || !date){ alert('Izberi profesorja/razred in datum'); return; }
  const key = `${type}|${id}|${date}`;
  const data = state.schedules[key] || {slots: Array(8).fill('P')};
  // render 8 slots
  const editor = document.getElementById('scheduleEditor'); editor.innerHTML = '';
  const grid = document.createElement('div'); grid.className='grid-cols';
  for(let i=0;i<8;i++){
    const slot = document.createElement('div');
    slot.className='slot';
    slot.dataset.slotIndex = i;
    slot.innerHTML = `<div style="text-align:center"><div style="font-weight:bold">Ura ${i+1}</div><div class="tiny muted">${data.slots[i]||'P'}</div></div>`;
    slot.onclick = ()=> {
      const input = prompt('Vpiši ID razreda ali "P" za prosto uro. (Lahko vpišeš tudi ime razreda - sistem poskuša najti id).', data.slots[i]||'P');
      if (input===null) return;
      const v = input.trim();
      if (!v) return;
      // try to resolve class by name if editing prof and wrote class name
      let newVal = v;
      if (type==='prof'){
        // expect class id or name -> if name given, find class
        const classByName = state.classes.find(c=>c.name.toLowerCase()===v.toLowerCase());
        if (classByName) newVal = classByName.id;
      } else {
        // type === class: expect teacher id or name
        const teacherByName = state.teachers.find(t=>t.name.toLowerCase()===v.toLowerCase() || t.username===v);
        if (teacherByName) newVal = teacherByName.id;
      }
      data.slots[i]= newVal;
      slot.querySelector('.tiny').textContent = newVal;
      slot.style.border='1px dashed #888';
    };
    grid.appendChild(slot);
  }
  editor.appendChild(grid);
  // attach data to editor DOM for later save
  editor.dataset.currentKey = key;
  editor.dataset.type = type;
  editor.dataset.id = id;
  editor.dataset.date = date;
  // fill with saved
  data.slots.forEach((v,i)=>{
    const node = grid.children[i];
    node.querySelector('.tiny').textContent = v;
  });
  // store temporary slots in element
  editor.dataset.slots = JSON.stringify(data.slots);
  // allow save button to call saveEditorSchedule()
}
function saveEditorSchedule(){
  const editor = document.getElementById('scheduleEditor');
  if (!editor.dataset.currentKey){ alert('Naloži urnik najprej'); return; }
  const type = editor.dataset.type;
  const id = editor.dataset.id;
  const date = editor.dataset.date;
  const key = `${type}|${id}|${date}`;
  // read grid values
  const slots = Array.from(editor.querySelectorAll('.slot')).map(n=>{
    return n.querySelector('.tiny').textContent || 'P';
  });
  state.schedules[key] = {slots};
  saveState();
  alert('Urnik shranjen.');
}
function clearEditorSchedule(){
  const editor = document.getElementById('scheduleEditor');
  if (!editor.dataset.currentKey){ editor.innerHTML=''; return; }
  Array.from(editor.querySelectorAll('.slot')).forEach(n=>{
    n.querySelector('.tiny').textContent = 'P';
  });
}

/* ----- PROFESSOR view & attendance ----- */

function showProfessorHome(){
  // prepare prof view
  document.getElementById('profView').style.display='block';
  // hide admin views
  ['studentsView','teachersView','classesView','schedulesView','gradebookView','classView','homeView'].forEach(id=>document.getElementById(id).style.display='none');
  // set date default
  const pd = document.getElementById('profDate'); pd.value = todayISO();
  populateProfessorClassFilters();
  renderProfSchedule();
}

function renderProfSchedule(){
  const prof = state.teachers.find(t=>t.id===session.user.teacherId);
  if (!prof) { alert('Napaka: ni povezanega profesorja.'); return; }
  const date = document.getElementById('profDate').value || todayISO();
  const chosenClass = document.getElementById('profClassFilter').value;
  // schedule key for professor
  const key = `prof|${prof.id}|${date}`;
  const ps = state.schedules[key] ? state.schedules[key].slots : Array(8).fill('P');
  const area = document.getElementById('profScheduleArea'); area.innerHTML='';
  const heading = document.createElement('div'); heading.innerHTML = `<strong>Urnik za ${prof.name} — ${date}</strong>`; area.appendChild(heading);
  const grid = document.createElement('div'); grid.className='grid-cols'; grid.style.marginTop='8px';
  for(let i=0;i<8;i++){
    const slotDiv = document.createElement('div');
    const slotVal = ps[i] || 'P';
    // if slotVal refers to class id, get class name
    let display = slotVal;
    if (slotVal !== 'P') {
      const c = byId(state.classes, slotVal);
      if (c) display = c.name;
    } else display = 'P (prosta)';
    // if professor chose a class filter and this slot's class not matching, show muted
    const isVisible = !chosenClass || chosenClass === (ps[i] || '');
    slotDiv.innerHTML = `<div style="padding:8px;border-radius:6px;background:white;min-height:70px;display:flex;flex-direction:column;justify-content:space-between">
      <div><strong>Ura ${i+1}</strong></div>
      <div style="font-size:14px">${display}</div>
      <div style="text-align:right"><button class="btn" onclick="openAttendanceDialog('${date}','${ps[i]||'P'}','${i+1}')">Odpri</button></div>
    </div>`;
    slotDiv.style.display = isVisible ? 'block' : 'none';
    grid.appendChild(slotDiv);
  }
  area.appendChild(grid);
}

/* Attendance dialog: when teacher clicks a slot */
function openAttendanceDialog(date, classOrP, hour){
  // classOrP may be 'P' or classId
  if (classOrP === 'P' || !classOrP){ alert('Prosta ura. Ni razreda.'); return; }
  const classObj = byId(state.classes, classOrP);
  if (!classObj){ alert('Razred ni najden'); return; }
  const hourIdx = Number(hour)-1;
  const attendanceKey = `${date}|${classObj.id}`;
  const record = state.attendance[attendanceKey] || {};
  const hourRecord = record[hourIdx] || {teacherId: session.user.teacherId, topic:'', absences:{}};
  // build student list
  const studentListHtml = classObj.studentIds.map(sid=>{
    const s = byId(state.students, sid);
    const absent = hourRecord.absences && hourRecord.absences[sid];
    return `<div style="display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid #f0f0f0">
      <div><span class="${absent?'absent':'present'}" id="sa_${sid}">${s? s.name : ('(neznan) '+sid)}</span></div>
      <div><button class="btn" onclick="toggleAbs('${attendanceKey}','${hourIdx}','${sid')}>Toggle</button></div>
    </div>`;
  }).join('');
  // But above we used single quotes with injection; rewrite safely by constructing DOM instead of raw HTML. We'll build DOM below.
  showModal('', false);
  const dialog = document.getElementById('modalDialog'); dialog.innerHTML = '';
  const h = document.createElement('h3'); h.textContent = `Razred: ${classObj.name} — ura ${hour}`;
  dialog.appendChild(h);
  const topicLabel = document.createElement('label'); topicLabel.textContent = 'Snov (tema)'; dialog.appendChild(topicLabel);
  const topicInput = document.createElement('input'); topicInput.type='text'; topicInput.id='att_topic'; topicInput.value = hourRecord.topic||''; dialog.appendChild(topicInput);
  const listWrap = document.createElement('div'); listWrap.style.maxHeight='280px'; listWrap.style.overflow='auto'; listWrap.style.marginTop='8px'; listWrap.style.border='1px solid #eee'; listWrap.style.padding='6px';
  classObj.studentIds.forEach(sid=>{
    const s = byId(state.students,sid) || {name:'(neznan)', id:sid};
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px'; row.style.borderBottom='1px solid #f7f7f7';
    const nameSpan = document.createElement('span'); nameSpan.textContent = s.name; nameSpan.id = 'sa_' + sid;
    if (hourRecord.absences && hourRecord.absences[sid]) nameSpan.className='absent'; else nameSpan.className='present';
    nameSpan.style.cursor='pointer';
    nameSpan.onclick = ()=> {
      // toggle absence locally in UI
      const cur = nameSpan.className === 'absent';
      nameSpan.className = cur ? 'present' : 'absent';
      // update hourRecord
      hourRecord.absences = hourRecord.absences || {};
      if (cur) { delete hourRecord.absences[sid]; } else { hourRecord.absences[sid] = true; }
      // reflect to state but only when saved
    };
    const hoursNote = document.createElement('small'); hoursNote.className='muted tiny';
    // compute student's absence summary for this date across hours if needed
    row.appendChild(nameSpan);
    row.appendChild(hoursNote);
    listWrap.appendChild(row);
  });
  dialog.appendChild(listWrap);
  const btnRow = document.createElement('div'); btnRow.className='row'; btnRow.style.marginTop='8px';
  const btnSave = document.createElement('button'); btnSave.className='btn primary'; btnSave.textContent='Shrani'; btnSave.onclick = ()=>{
    // persist hourRecord into state.attendance
    const attKey = attendanceKey;
    const sKey = `${date}|${classObj.id}`;
    const rec = state.attendance[sKey] || {};
    const hr = Number(hourIdx);
    // read topic
    const tval = document.getElementById('att_topic').value;
    hourRecord.topic = tval;
    hourRecord.teacherId = session.user.teacherId;
    rec[hr] = hourRecord;
    state.attendance[sKey] = rec;
    saveState();
    closeModal();
    // optionally re-render schedule to mark saved
    renderProfSchedule();
    alert('Ura shranjena.');
  };
  const btnHistory = document.createElement('button'); btnHistory.className='btn'; btnHistory.textContent='ZGODOVINA UR'; btnHistory.onclick = ()=>{
    openHourHistoryDialog(date, classObj.id);
  };
  const btnClose = document.createElement('button'); btnClose.className='btn'; btnClose.textContent='Zapri'; btnClose.onclick = ()=> closeModal();
  btnRow.appendChild(btnSave); btnRow.appendChild(btnHistory); btnRow.appendChild(btnClose);
  dialog.appendChild(btnRow);
}

function openHourHistoryDialog(date, classId){
  const sKey = `${date}|${classId}`;
  const rec = state.attendance[sKey] || {};
  showModal('', false);
  const dialog = document.getElementById('modalDialog'); dialog.innerHTML = '';
  const h = document.createElement('h3'); h.textContent = 'Zgodovina ur za ' + date; dialog.appendChild(h);
  const table = document.createElement('table'); table.style.width='100%';
  const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Ura</th><th>Učitelj</th><th>Snov</th><th>Št odsotnih</th></tr>'; table.appendChild(thead);
  const tbody = document.createElement('tbody');
  for(let i=0;i<8;i++){
    const hr = rec[i];
    const tr = document.createElement('tr');
    const teacherName = hr && hr.teacherId ? (byId(state.teachers,hr.teacherId)?.name || '') : '';
    const absentCount = hr && hr.absences ? Object.keys(hr.absences).length : 0;
    tr.innerHTML = `<td>${i+1}</td><td>${teacherName}</td><td>${hr?.topic||''}</td><td>${absentCount}</td>`;
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  dialog.appendChild(table);
  const btn = document.createElement('div'); btn.style.marginTop='8px';
  btn.innerHTML = `<button class="btn" onclick="closeModal()">Zapri</button>`;
  dialog.appendChild(btn);
}

/* ----- Gradebook (simplified) ----- */
function openGradebook(){
  showTab('gradebookView');
  document.getElementById('gradebookView').style.display='block';
  populateClassSelects();
}
function renderGradebook(){
  const classId = document.getElementById('gradeClassSelect').value;
  const area = document.getElementById('gradebookTableArea'); area.innerHTML='';
  if (!classId){ area.innerHTML='<small class="muted">Izberi razred</small>'; return; }
  const c = byId(state.classes, classId);
  if (!c){ area.innerHTML='Nepoznani razred'; return; }
  const tbl = document.createElement('table');
  tbl.innerHTML = `<thead><tr><th>Učenec</th><th>1. obdobje</th><th>2. obdobje</th><th>Konec</th></tr></thead>`;
  const tbody = document.createElement('tbody');
  c.studentIds.forEach(sid=>{
    const s = byId(state.students, sid);
    const g = state.grades[sid] || {};
    const row = document.createElement('tr');
    row.innerHTML = `<td>${s? s.name : '(neznan)'}</td>
      <td><div id="g1_${sid}">${renderGradeSpan(g.period1||[])}</div></td>
      <td><div id="g2_${sid}">${renderGradeSpan(g.period2||[])}</div></td>
      <td><div id="gfin_${sid}">${g.final?('<strong>'+g.final+'</strong>'):'<button class="btn" onclick="openFinalModal(\\''+sid+'\\')">Določi</button>'}</div></td>`;
    tbody.appendChild(row);
  });
  tbl.appendChild(tbody); area.appendChild(tbl);
  // add click handlers to add grades
  c.studentIds.forEach(sid=>{
    const el1 = document.getElementById('g1_'+sid);
    el1.insertAdjacentHTML('beforeend', `<div style="margin-top:6px"><button class="btn" onclick="openAddGrade('${sid}',1)">Dodaj oceno</button></div>`);
    const el2 = document.getElementById('g2_'+sid);
    el2.insertAdjacentHTML('beforeend', `<div style="margin-top:6px"><button class="btn" onclick="openAddGrade('${sid}',2)">Dodaj oceno</button></div>`);
  });
}
function renderGradeSpan(arr){
  if (!arr || !arr.length) return '';
  return arr.map(g=>`<span class="badge">${g.value}${g.type?(' - '+g.type):''}</span>`).join(' ');
}
function openAddGrade(studentId, period){
  showModal(`
    <h3>Dodaj oceno</h3>
    <div><strong>Učenec:</strong> ${byId(state.students,studentId)?.name||studentId}</div>
    <label>Tip (pisna/ustna/izdelek)</label>
    <select id="g_type"><option value="pisna">pisna</option><option value="ustna">ustna</option><option value="izdelek">izdelek</option></select>
    <label>Vrednost (1-5 ali NPS)</label>
    <input id="g_val" type="text" placeholder="npr. 4 ali NPS" />
    <label>Komentar</label>
    <textarea id="g_comm"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" onclick="saveAddGrade('${studentId}',${period})">Shrani</button>
      <button class="btn" onclick="closeModal()">Prekliči</button>
    </div>
  `);
}
function saveAddGrade(studentId, period){
  const type = document.getElementById('g_type').value;
  const val = document.getElementById('g_val').value.trim();
  const comm = document.getElementById('g_comm').value;
  if (!val){ alert('Vnesi vrednost'); return; }
  state.grades[studentId] = state.grades[studentId] || {};
  const key = 'period'+period;
  state.grades[studentId][key] = state.grades[studentId][key] || [];
  state.grades[studentId][key].push({value:val,type,comment:comm,date:todayISO()});
  saveState();
  closeModal(); renderGradebook();
}
function openFinalModal(studentId){
  showModal(`
    <h3>Zaključna ocena</h3>
    <div><strong>Učenec:</strong> ${byId(state.students,studentId)?.name||studentId}</div>
    <label>Zaključna ocena</label>
    <select id="final_sel"><option value="">-- izberi --</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" onclick="saveFinal('${studentId}')">Shrani</button>
      <button class="btn" onclick="closeModal()">Prekliči</button>
    </div>
  `);
}
function saveFinal(studentId){
  const v = document.getElementById('final_sel').value;
  if (!v){ alert('Izberi oceno'); return; }
  state.grades[studentId] = state.grades[studentId] || {};
  state.grades[studentId].final = v;
  saveState();
  closeModal(); renderGradebook();
}

/* ----- Class attendance summary (teacher 'Razred' view) ----- */
function openClassView(){
  showTab('classView');
  document.getElementById('classView').style.display='block';
  populateClassSelects();
}
function renderClassAttendance(){
  const classId = document.getElementById('classViewSelect').value;
  const area = document.getElementById('classAttendanceArea'); area.innerHTML='';
  if (!classId) return;
  const c = byId(state.classes,classId);
  // build table: columns: Ime | opravicene | neopravičene | odprte | eye icon
  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>Učenec</th><th>Opravičene</th><th>Neopravičene</th><th>Odprte</th><th></th></tr></thead>`;
  const tbody = document.createElement('tbody');
  // calculate counts by scanning state.attendance across all dates
  const allDatesKeys = Object.keys(state.attendance).filter(k=>k.endsWith('|'+classId));
  const dates = allDatesKeys.map(k=>k.split('|')[0]);
  c.studentIds.forEach(sid=>{
    let oprav=0, neoprav=0, odprt=0;
    dates.forEach(date=>{
      const rec = state.attendance[`${date}|${classId}`];
      if (!rec) return;
      Object.keys(rec).forEach(hr=>{
        const hrrec = rec[hr];
        if (!hrrec || !hrrec.absences) return;
        if (hrrec.absences[sid]){
          // for simplification - treat all absences as 'odprta' (open) unless teacher later marks)
          odprt++;
        }
      });
    });
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${byId(state.students,sid)?.name||sid}</td><td><strong style="color:green">${oprav}</strong></td>
      <td><strong style="color:red">${neoprav}</strong></td><td><strong>${odprt}</strong></td>
      <td><button class="btn" onclick="openStudentAttendanceDialog('${classId}','${sid}')">👁️</button></td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  area.appendChild(table);
}

/* Detailed student attendance modal */
function openStudentAttendanceDialog(classId, studentId){
  // list all attendance entries for the student
  const rows = [];
  Object.keys(state.attendance).forEach(k=>{
    const parts = k.split('|');
    const date = parts[0]; const cid = parts[1];
    if (cid !== classId) return;
    const rec = state.attendance[k];
    Object.keys(rec).forEach(hr=>{
      const hrrec = rec[hr];
      if (hrrec && hrrec.absences && hrrec.absences[studentId]){
        rows.push({date, hour: Number(hr)+1, teacherId: hrrec.teacherId, topic: hrrec.topic});
      }
    });
  });
  showModal('', false);
  const dialog = document.getElementById('modalDialog'); dialog.innerHTML = `<h3>Odsotnosti za učenec</h3>`;
  if (!rows.length){ dialog.innerHTML += '<p>Ni odsotnosti.</p><div style="margin-top:8px"><button class="btn" onclick="closeModal()">Zapri</button></div>'; return; }
  const table = document.createElement('table'); table.style.width='100%';
  table.innerHTML = `<thead><tr><th>Datum</th><th>Ura</th><th>Učitelj</th><th>Snov</th><th>Akcija</th></tr></thead>`;
  const tbody = document.createElement('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const tname = byId(state.teachers,r.teacherId)?.name || '';
    tr.innerHTML = `<td>${r.date}</td><td>${r.hour}</td><td>${tname}</td><td>${r.topic||''}</td>
      <td><button class="btn" onclick="toggleExcuse('${r.date}','${classId}','${r.hour-1}','${studentId}')">Opraviči/prekliči</button></td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  dialog.appendChild(table);
  dialog.innerHTML += '<div style="margin-top:8px"><button class="btn" onclick="closeModal()">Zapri</button></div>';
}

/* Toggle excuse - here we just remove absence as "opravičeno toggled simplicity" */
function toggleExcuse(date, classId, hourIdx, studentId){
  const key = `${date}|${classId}`;
  const rec = state.attendance[key];
  if (!rec || !rec[hourIdx] || !rec[hourIdx].absences) return alert('Ni podatka');
  const was = rec[hourIdx].absences[studentId];
  if (was){ delete rec[hourIdx].absences[studentId]; alert('Odsotnost odstranjena (lahko šteje kot opravičena v realnem sistemu).'); }
  else { rec[hourIdx].absences[studentId]=true; alert('Odsotnost dodana'); }
  state.attendance[key] = rec;
  saveState();
  closeModal();
}

/* ----- Modal helpers ----- */
function showModal(html, allowClose=true){
  const modal = document.getElementById('modal'); const dialog = document.getElementById('modalDialog');
  if (html) dialog.innerHTML = html; // if empty, caller will build DOM
  modal.style.display='flex';
  if (allowClose){
    modal.onclick = function(e){ if (e.target === modal) closeModal(); };
  } else {
    modal.onclick = null;
  }
}
function closeModal(){ const modal = document.getElementById('modal'); modal.style.display='none'; document.getElementById('modalDialog').innerHTML=''; }

/* ----- small helpers ----- */
function exportData(type){
  let data='';
  if (type==='students') data = JSON.stringify(state.students,null,2);
  if (type==='teachers') data = JSON.stringify(state.teachers,null,2);
  if (type==='classes') data = JSON.stringify(state.classes,null,2);
  const w = window.open(); w.document.write('<pre>'+escapeHtml(data)+'</pre>');
}
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

/* ----- On load populate some UI pieces ----- */
window.addEventListener('load', ()=>{
  ensureAdmin();
  populateScheduleSelectors();
  populateClassSelects();
  // default: show login
  document.getElementById('loginView').style.display='block';
});

/* Quick helpers used inline in generated buttons (must be global) */
window.openStudentModal = openStudentModal;
window.deleteStudent = deleteStudent;
window.editStudent = editStudent;
window.openTeacherModal = openTeacherModal;
window.deleteTeacher = deleteTeacher;
window.editTeacher = editTeacher;
window.openClassModal = openClassModal;
window.deleteClass = deleteClass;
window.openGradebook = openGradebook;
window.openClassView = openClassView;
window.openHome = ()=>{ showTab('homeView'); document.getElementById('homeView').style.display='block'; };

/* Because some functions used in generated HTML needed but were constructed earlier, ensure they exist */
window.toggleAbs = function(attKey, hourIdx, sid){
  // not used (kept for generated code safety)
  console.log('toggleAbs',attKey,hourIdx,sid);
};

/* End of script */
</script>

</body>
</html>