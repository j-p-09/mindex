<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINDEX v2.0 - Evidenčni sistem</title>
    <style>
        /* --- GLOBALNE SPREMENLJIVKE & RETRO STIL --- */
        :root {
            --win-bg: #c0c0c0;
            --win-dark: #808080;
            --win-light: #ffffff;
            --win-black: #000000;
            --win-blue: #000080;
            --win-teal: #008080;
            --font-main: 'Tahoma', 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--win-teal);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- OKVIR APLIKACIJE --- */
        #app-container {
            flex: 1;
            margin: 10px;
            background-color: var(--win-bg);
            border: 2px solid;
            border-color: var(--win-light) var(--win-black) var(--win-black) var(--win-light);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
            max-width: 1400px;
            margin: 10px auto;
            width: calc(100% - 20px);
            position: relative;
        }

        /* --- ZGORNJA VRSTICA --- */
        .title-bar {
            background: linear-gradient(90deg, var(--win-blue), #1084d0);
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- LOGIN ZASLON (Specifičen dizajn) --- */
        #login-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--win-bg);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .login-box {
            width: 500px;
            border: 2px solid var(--win-dark);
            padding: 2px;
            background: var(--win-bg);
        }
        
        .login-header {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Times New Roman', serif;
            letter-spacing: 2px;
        }

        .login-split {
            display: flex;
            gap: 10px;
        }

        .login-sidebar {
            width: 120px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-right: 1px solid var(--win-dark);
            padding-right: 10px;
            align-items: center;
        }
        .login-sidebar img { width: 50px; opacity: 0.5; filter: grayscale(100%); }

        .login-form-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-block {
            background: #e0e0e0;
            border: 1px inset white;
            padding: 5px;
            font-size: 12px;
        }

        .auto-text { font-weight: bold; color: #404040; }

        .login-inputs {
            background: #d0d0d0;
            border: 1px solid var(--win-dark);
            padding: 15px;
        }
        
        .last-login-box {
            background: #e0e0e0;
            padding: 5px;
            border: 1px inset white;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- GLAVNA APLIKACIJA --- */
        #main-interface {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* --- STRANSKI MENI --- */
        .sidebar {
            width: 120px;
            background: var(--win-bg);
            border-right: 2px solid var(--win-dark);
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            width: 100%;
            padding: 5px;
            text-align: center;
        }
        .nav-btn:hover { background: #d0d0d0; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080; }
        .nav-btn img { width: 64px; height: 64px; object-fit: contain; margin-bottom: 5px; }
        .nav-btn span { font-size: 11px; font-weight: bold; }
        
        .nav-btn.active {
            background: #e0e0e0;
            box-shadow: inset 1px 1px 2px #000;
        }

        .session-info {
            margin-top: auto;
            border-top: 2px groove var(--win-light);
            width: 100%;
            padding-top: 10px;
            text-align: center;
            font-size: 11px;
        }

        /* --- VSEBINSKI DEL --- */
        .content-pane {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: white;
            border: 2px inset var(--win-dark);
            margin: 5px;
            position: relative;
        }

        .page { display: none; }
        .page.active { display: block; }

        /* --- ELEMENTI VMESNIKA --- */
        button.retro-btn {
            background: var(--win-bg);
            border: 2px solid var(--win-light);
            border-right-color: var(--win-black);
            border-bottom-color: var(--win-black);
            padding: 3px 10px;
            cursor: pointer;
            font-weight: bold;
        }
        button.retro-btn:active {
            border: 2px solid var(--win-black);
            border-right-color: var(--win-light);
            border-bottom-color: var(--win-light);
        }

        input, select, textarea {
            border: 2px inset var(--win-light);
            border-left-color: var(--win-dark);
            border-top-color: var(--win-dark);
            background: white;
            padding: 3px;
        }

        /* --- DATE SLIDER (TRAK) --- */
        .date-slider {
            background: #808080;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 15px;
            color: white;
            font-weight: bold;
            margin-bottom: 15px;
            box-shadow: inset 2px 2px 5px #000;
        }
        .arrow-btn {
            font-size: 24px;
            cursor: pointer;
            user-select: none;
        }
        .arrow-btn:hover { color: #ddd; }
        .date-display {
            font-size: 18px;
            cursor: pointer;
            border-bottom: 1px dotted white;
        }
        .date-hint {
            position: absolute;
            font-size: 10px;
            color: #404040;
            margin-top: -35px;
            background: white;
            border: 1px solid black;
            padding: 2px;
        }

        /* --- TABELE --- */
        table.retro-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid var(--win-black);
            margin-bottom: 10px;
        }
        table.retro-table th { background: var(--win-bg); border: 1px solid var(--win-black); padding: 5px; }
        table.retro-table td { border: 1px solid var(--win-dark); padding: 5px; }
        table.retro-table tr:hover td { background-color: #ffffcc; }
        .selected-row { background-color: #ffff99 !important; }

        /* --- URNIK CELL --- */
        .sched-cell {
            height: 80px; text-align: center; vertical-align: middle; cursor: pointer;
            background: #e0e0e0; font-weight: bold; width: 11%;
        }
        .sched-cell:hover { background: #fffacd; }
        .crossed-out {
            background: repeating-linear-gradient(45deg, #ccc, #ccc 10px, #bbb 10px, #bbb 20px);
            color: #777;
        }

        /* --- OPRAVIČEVANJE GRID --- */
        .abs-grid-cell { text-align: center; padding: 2px !important; }
        .btn-abs {
            width: 25px; height: 25px; border: 1px solid black; font-weight: bold;
            display: inline-flex; align-items: center; justify-content: center; cursor: pointer; margin: 1px;
            background: #eee;
        }
        .btn-abs:hover { opacity: 0.8; }
        .abs-green { background: #90EE90; } /* O */
        .abs-red { background: #FFB6C1; }   /* N */
        .abs-none { background: #fff; }     /* X / Default */
        
        .has-note { background-color: #ffff00 !important; cursor: help; } /* Rumeno ozadje imena */

        /* --- MODALS --- */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 10000;
        }
        .modal-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--win-bg); border: 2px solid var(--win-light);
            border-right-color: var(--win-black); border-bottom-color: var(--win-black);
            box-shadow: 5px 5px 15px #000; padding: 3px; min-width: 300px;
        }
        .modal-header {
            background: var(--win-blue); color: white; padding: 3px 5px; font-weight: bold;
            display: flex; justify-content: space-between;
        }
        .modal-body { padding: 15px; }
        
        /* Ime v oknu za vpis ure */
        .student-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; padding: 2px; background: white; border: 1px solid #ccc; }
        .icon-edit { cursor: pointer; font-size: 14px; margin-left: 5px; }

        /* Profil ikona */
        .user-icon-area { position: relative; cursor: pointer; }
        .user-x-badge {
            position: absolute; bottom: 0; right: 0; background: red; color: white;
            font-size: 10px; padding: 0 3px; font-weight: bold; border: 1px solid white;
        }

    </style>
</head>
<body>

<div id="app-container">
    <div class="title-bar">
        <span>MINDEX v2.0</span>
        <div id="top-user-info" style="display:none; align-items: center; gap: 10px;">
            <span id="top-user-name">Ime Priimek</span>
            <div class="user-icon-area" onclick="app.logout()">
                <img src="profil_ikona_barvno.png" onerror="this.src='https://via.placeholder.com/32?text=U'" style="height:24px; border:1px solid white;">
                <div class="user-x-badge">X</div>
            </div>
        </div>
    </div>

    <div id="login-overlay">
        <div class="login-box">
            <div class="login-header">MINDEX</div>
            <div class="login-split">
                <div class="login-sidebar">
                    <img src="dnevnik_ikona_barvno.png" onerror="this.style.display='none'">
                    <img src="mrezni_plan_ikona_barvno.png" onerror="this.style.display='none'">
                    <img src="redovalnica_ikona_barvno.png" onerror="this.style.display='none'">
                    <img src="profil_ikona_barvno.png" onerror="this.style.display='none'">
                </div>
                <div class="login-form-area">
                    <div class="info-block">
                        Podatki:<br>
                        Številka licence: <span class="auto-text" id="lbl-license">...</span><br>
                        IP naslov naprave: <span class="auto-text" id="lbl-ip">...</span>
                    </div>
                    
                    <div class="login-inputs">
                        Prijava v sistem:<br><br>
                        <input type="text" id="inp-user" placeholder="Uporabniško ime" style="width: 90%"><br><br>
                        <input type="password" id="inp-pass" placeholder="Geslo" style="width: 90%"><br><br>
                        <button class="retro-btn" onclick="app.login()">POTRDI</button>
                    </div>

                    <div class="last-login-box">
                        <div>
                            Zadnja prijava kot:<br>
                            Uporabnik: <span class="auto-text" id="lbl-last-user">-</span><br>
                            Datum in čas: <span class="auto-text" id="lbl-last-time">-</span>
                        </div>
                        <button class="retro-btn" onclick="app.useLastUser()">Uporabi</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="main-interface" style="display:none;">
        <div class="sidebar" id="sidebar-nav">
            </div>
        <div class="content-pane" id="main-content">
            </div>
    </div>
</div>

<div id="modal-hour" class="modal">
    <div class="modal-box" style="width: 500px;">
        <div class="modal-header"><span>Vpis ure</span> <button onclick="app.closeModal('modal-hour')">X</button></div>
        <div class="modal-body">
            <div style="background:#eee; padding:5px; margin-bottom:10px; border:1px solid gray;" id="mh-info"></div>
            
            <div style="display:flex; justify-content: space-between;">
                <strong>Odsotni dijaki:</strong>
                <button class="retro-btn" onclick="app.openStudentPicker()">+ Dodaj</button>
            </div>
            <div id="mh-absent-list" style="border:2px inset white; height:100px; overflow-y:scroll; background:white; margin: 5px 0;"></div>
            
            <strong>Vsebina ure:</strong><br>
            <textarea id="mh-content" rows="4" style="width:98%"></textarea><br><br>
            <div style="text-align:right;">
                <button class="retro-btn" onclick="app.saveHour()">SHRANI</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-picker" class="modal">
    <div class="modal-box" style="width: 300px;">
        <div class="modal-header"><span>Izberi dijaka</span> <button onclick="app.closeModal('modal-picker')">X</button></div>
        <div class="modal-body">
            <input type="text" id="picker-search" placeholder="Išči..." style="width:95%" onkeyup="app.filterPicker()"><br><br>
            <div id="picker-list" style="height:200px; overflow-y:auto; border:1px solid gray; background:white;"></div>
        </div>
    </div>
</div>

<div id="modal-note" class="modal">
    <div class="modal-box" style="width: 300px;">
        <div class="modal-header"><span>Opomba odsotnosti</span> <button onclick="app.closeModal('modal-note')">X</button></div>
        <div class="modal-body">
            <p id="mn-student-name"></p>
            <textarea id="mn-text" rows="5" style="width:98%"></textarea><br><br>
            <button class="retro-btn" onclick="app.saveAbsenceNote()">Shrani opombo</button>
        </div>
    </div>
</div>

<div id="modal-mass" class="modal">
    <div class="modal-box" style="width: 400px;">
        <div class="modal-header"><span>Vpis ocen</span> <button onclick="app.closeModal('modal-mass')">X</button></div>
        <div class="modal-body" id="mass-body"></div>
    </div>
</div>

<div id="modal-alert" class="modal">
    <div class="modal-box" style="width:300px; text-align:center;">
        <div class="modal-header"><span>Obvestilo</span></div>
        <div class="modal-body">
            <p id="alert-msg"></p>
            <button class="retro-btn" onclick="app.closeModal('modal-alert')">V redu</button>
        </div>
    </div>
</div>

<script>
/**
 * MINDEX v2.0 - Centralna logika
 */
const DB_KEY = 'MINDEX_DB_FINAL';
const LAST_USER_KEY = 'MINDEX_LAST_USER';

const app = {
    db: null,
    user: null,
    sessionTimer: null,
    sessionSeconds: 0,
    
    // Za navigacijo in stanja
    currentState: {
        page: 'home',
        date: new Date(), // Trenutno izbran datum na traku
        classId: null,    // Za filtre
        viewMode: 'summary' // Za opravičevanje (summary/detailed)
    },

    // Modal tmp data
    tempModalData: {},

    init: function() {
        // Generiraj naključne podatke za login zaslon
        document.getElementById('lbl-ip').innerText = `192.168.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`;
        document.getElementById('lbl-license').innerText = `LIC-${Math.floor(100000 + Math.random() * 900000)}`;
        
        // Naloži zadnjega uporabnika
        const last = JSON.parse(localStorage.getItem(LAST_USER_KEY));
        if(last) {
            document.getElementById('lbl-last-user').innerText = last.username;
            document.getElementById('lbl-last-time').innerText = last.time;
        }

        // Naloži bazo
        const saved = localStorage.getItem(DB_KEY);
        if(saved) {
            this.db = JSON.parse(saved);
        } else {
            // Privzeta baza
            this.db = {
                users: [
                    {id: 'u1', username: 'ADMIN', password: 'ADMIN', role: 'admin', name: 'Administrator', sessionTime: 30}
                ],
                classes: [],
                students: [], // {id, name, classId, user, pass}
                subjects: [], // {id, name, classIds: []}
                schedule: {}, // { "YYYY-MM-DD_teacherId": {1: classId, ...} }
                hourLogs: [], // {id, date, hour, classId, teacherId, content}
                absences: [], // {id, studentId, date, hour, status: 'pending'|'excused'|'unexcused', note: ''}
                grades: [],   // {id, studentId, subjectId, period, value, type}
                plan: []      // {id, classId, subjectId, date, month}
            };
            this.saveDB();
        }
    },

    saveDB: function() {
        localStorage.setItem(DB_KEY, JSON.stringify(this.db));
    },

    // --- PRIJAVA & SEJA ---
    useLastUser: function() {
        const u = document.getElementById('lbl-last-user').innerText;
        if(u !== '-') {
            document.getElementById('inp-user').value = u;
            document.getElementById('inp-pass').focus();
        }
    },

    login: function() {
        const u = document.getElementById('inp-user').value;
        const p = document.getElementById('inp-pass').value;
        
        // Admin ali učitelj
        let found = this.db.users.find(x => x.username === u && x.password === p);
        
        // Ali pa učenec (generirano)
        if(!found) {
            found = this.db.students.find(x => x.user === u && x.pass === p);
            if(found) found.role = 'student'; // Dodamo začasno vlogo
        }

        if(found) {
            this.user = found;
            // Shrani za "zadnjo prijavo"
            localStorage.setItem(LAST_USER_KEY, JSON.stringify({
                username: found.role === 'student' ? found.user : found.username,
                time: new Date().toLocaleString('sl-SI')
            }));

            // UI premik
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-interface').style.display = 'flex';
            document.getElementById('top-user-info').style.display = 'flex';
            document.getElementById('top-user-name').innerText = found.name;

            // Nastavi timer
            const timeoutMinutes = found.sessionTime || 30; // Default 30 min
            this.sessionSeconds = timeoutMinutes * 60;
            this.startSessionTimer();

            // Pripravi meni in domačo stran
            this.renderSidebar();
            this.navigate('home');
        } else {
            alert("Napačni podatki!");
        }
    },

    logout: function() {
        clearInterval(this.sessionTimer);
        location.reload();
    },

    startSessionTimer: function() {
        const div = document.createElement('div');
        div.id = 'session-display';
        div.className = 'session-info';
        document.getElementById('sidebar-nav').appendChild(div);

        this.sessionTimer = setInterval(() => {
            this.sessionSeconds--;
            if(this.sessionSeconds <= 0) {
                this.logout();
            } else {
                const m = Math.floor(this.sessionSeconds / 60);
                const s = this.sessionSeconds % 60;
                document.getElementById('session-display').innerText = `Seja poteče čez:\n${m}:${s < 10 ? '0'+s : s}`;
            }
        }, 1000);
    },

    // --- NAVIGACIJA ---
    renderSidebar: function() {
        const nav = document.getElementById('sidebar-nav');
        nav.innerHTML = ''; // Reset
        
        const createBtn = (id, label, icon, action) => {
            const btn = document.createElement('button');
            btn.className = 'nav-btn';
            btn.innerHTML = `<img src="${icon}" onerror="this.src='https://via.placeholder.com/64?text=${label.substring(0,3)}'"><span>${label}</span>`;
            btn.onclick = () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                action();
            };
            if(id === 'home') btn.classList.add('active'); // Default active
            nav.appendChild(btn);
        };

        // Gumbi glede na vlogo
        if(this.user.role === 'admin') {
            createBtn('home', 'DOMOV', 'domov_ikona_barvno.png', () => this.navigate('home'));
            createBtn('adm_users', 'UČITELJI', 'profil_gumb_barvno.png', () => this.navigate('admin-teachers'));
            createBtn('adm_classes', 'RAZREDI', 'dnevnik_gumb_barvno.png', () => this.navigate('admin-classes'));
            createBtn('profile', 'PROFIL', 'profil_ikona_barvno.png', () => this.navigate('profile'));
        } else if (this.user.role === 'student') {
            createBtn('home', 'DOMOV', 'domov_ikona_barvno.png', () => this.navigate('home'));
            createBtn('grades', 'OCENE', 'redovalnica_gumb_barvno.png', () => this.navigate('student-grades'));
            createBtn('plan', 'PLAN', 'mrezni_plan_gub_barvno.png', () => this.navigate('plan'));
        } else {
            // Učitelj
            createBtn('home', 'DNEVNIK', 'dnevnik_gumb_barvno.png', () => this.navigate('home')); // Domača stran je Dnevnik
            createBtn('plan', 'PLAN', 'mrezni_plan_gub_barvno.png', () => this.navigate('plan'));
            createBtn('grades', 'REDOVALNICA', 'redovalnica_gumb_barvno.png', () => this.navigate('grades'));
            createBtn('abs', 'ODSOTNOST', 'odsotnost_gumb_barvno.png', () => this.navigate('attendance'));
            createBtn('profile', 'PROFIL', 'profil_ikona_barvno.png', () => this.navigate('profile'));
        }
        
        // Session container append
        const sess = document.createElement('div');
        sess.id = 'session-display';
        sess.className = 'session-info';
        nav.appendChild(sess);
    },

    navigate: function(pageId) {
        this.currentState.page = pageId;
        const container = document.getElementById('main-content');
        container.innerHTML = ''; // Clear

        // DOMOV (HOME)
        if(pageId === 'home') {
            if(this.user.role === 'admin') {
                container.innerHTML = `<h3>Admin Panel</h3><p>Izberite funkcijo na levi.</p>`;
            } else if (this.user.role === 'student') {
                 container.innerHTML = `<h3>Pozdravljen, ${this.user.name}</h3><p>Preveri ocene ali plan.</p>`;
            } else {
                // Učitelj: Dnevnik + Date Slider
                this.renderDateSlider(container, () => this.renderSchedule(container));
                this.renderSchedule(container);
            }
        }
        // OSTALE STRANI
        else if (pageId === 'grades') this.renderGrades(container);
        else if (pageId === 'plan') this.renderPlan(container);
        else if (pageId === 'attendance') this.renderAttendance(container);
        else if (pageId === 'profile') this.renderProfile(container);
        else if (pageId === 'admin-teachers') this.renderAdminTeachers(container);
        else if (pageId === 'admin-classes') this.renderAdminClasses(container);
        else if (pageId === 'student-grades') this.renderStudentGrades(container);
    },

    // --- COMPONENT: DATE SLIDER ---
    renderDateSlider: function(parent, callback) {
        const wrapper = document.createElement('div');
        wrapper.className = 'date-slider';
        
        const prev = document.createElement('div');
        prev.className = 'arrow-btn';
        prev.innerHTML = '&#8592;'; // Left Arrow
        prev.title = "En dan nazaj";
        prev.onclick = () => {
            this.currentState.date.setDate(this.currentState.date.getDate() - 1);
            updateDisplay();
            if(callback) callback();
        };

        const display = document.createElement('div');
        display.className = 'date-display';
        display.title = "Klikni za izbiro datuma";
        
        // Hidden date input for picker
        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.style.display = 'none';
        dateInput.onchange = (e) => {
            if(e.target.valueAsDate) {
                this.currentState.date = e.target.valueAsDate;
                updateDisplay();
                if(callback) callback();
            }
        };
        display.onclick = () => dateInput.showPicker();

        const next = document.createElement('div');
        next.className = 'arrow-btn';
        next.innerHTML = '&#8594;';
        next.title = "En dan naprej";
        next.onclick = () => {
            this.currentState.date.setDate(this.currentState.date.getDate() + 1);
            updateDisplay();
            if(callback) callback();
        };

        const updateDisplay = () => {
            const d = this.currentState.date;
            const days = ['Nedelja', 'Ponedeljek', 'Torek', 'Sreda', 'Četrtek', 'Petek', 'Sobota'];
            const str = `${days[d.getDay()]}, ${d.getDate()}. ${d.getMonth()+1}. ${d.getFullYear()}`;
            display.innerText = str;
        };

        wrapper.appendChild(prev);
        wrapper.appendChild(display);
        wrapper.appendChild(dateInput);
        wrapper.appendChild(next);
        parent.appendChild(wrapper);
        updateDisplay();
    },

    // --- VIEW: URNIK (DNEVNIK) ---
    renderSchedule: function(container) {
        // Obstoječa vsebina se pobriše, razen sliderja, če je bil appendan prej
        // Tu bomo dodali tabelo pod slider
        let tableArea = document.getElementById('schedule-area');
        if(!tableArea) {
            tableArea = document.createElement('div');
            tableArea.id = 'schedule-area';
            container.appendChild(tableArea);
        }
        tableArea.innerHTML = '';

        const dateKey = this.getDateKey(this.currentState.date);
        const mySchedule = this.db.schedule[`${dateKey}_${this.user.id}`] || {};
        
        const tbl = document.createElement('table');
        tbl.className = 'retro-table';
        tbl.style.marginTop = '20px';
        
        // Header 1-9
        let head = '<tr>';
        for(let i=1; i<=9; i++) head += `<th>${i}. ura</th>`;
        head += '</tr>';
        
        // Body row
        let row = '<tr>';
        for(let i=1; i<=9; i++) {
            const clsId = mySchedule[i];
            if(clsId) {
                const cls = this.db.classes.find(c => c.id === clsId);
                row += `<td class="sched-cell" onclick="app.openHourModal(${i}, '${clsId}')">${cls ? cls.name : '?'}</td>`;
            } else {
                row += `<td class="sched-cell crossed-out">P</td>`;
            }
        }
        row += '</tr>';
        
        tbl.innerHTML = head + row;
        tableArea.appendChild(tbl);
        
        // Dodaj še gumb za urejanje urnika (če učitelj želi sam spremeniti)
        const btnEdit = document.createElement('button');
        btnEdit.innerText = "Uredi moj urnik za ta dan";
        btnEdit.className = "retro-btn";
        btnEdit.style.marginTop = "10px";
        btnEdit.onclick = () => this.editScheduleMode();
        tableArea.appendChild(btnEdit);
    },

    editScheduleMode: function() {
        const dateKey = this.getDateKey(this.currentState.date);
        const sched = this.db.schedule[`${dateKey}_${this.user.id}`] || {};
        
        let html = `<h3>Urejanje urnika: ${dateKey}</h3><table>`;
        for(let i=1; i<=9; i++) {
            const clsOptions = this.db.classes.map(c => `<option value="${c.id}" ${sched[i]===c.id?'selected':''}>${c.name}</option>`).join('');
            html += `<tr><td>${i}. ura</td><td><select id="es-${i}"><option value="">Prosto</option>${clsOptions}</select></td></tr>`;
        }
        html += `</table><br><button class="retro-btn" onclick="app.saveScheduleChanges()">Shrani</button>`;
        document.getElementById('schedule-area').innerHTML = html;
    },

    saveScheduleChanges: function() {
        const dateKey = this.getDateKey(this.currentState.date);
        const newSched = {};
        for(let i=1; i<=9; i++) {
            const val = document.getElementById(`es-${i}`).value;
            if(val) newSched[i] = val;
        }
        this.db.schedule[`${dateKey}_${this.user.id}`] = newSched;
        this.saveDB();
        this.renderSchedule(document.getElementById('main-content')); // Refresh
    },

    // --- MODAL: VPIS URE ---
    openHourModal: function(hour, classId) {
        this.tempModalData = { hour, classId, date: this.getDateKey(this.currentState.date) };
        const cls = this.db.classes.find(c => c.id === classId);
        
        document.getElementById('mh-info').innerText = `${this.tempModalData.date} | ${hour}. ura | ${cls.name}`;
        
        // Load Logs
        const log = this.db.hourLogs.find(l => l.date === this.tempModalData.date && l.hour === hour && l.classId === classId);
        document.getElementById('mh-content').value = log ? log.content : '';
        
        this.renderAbsentList();
        document.getElementById('modal-hour').style.display = 'block';
    },

    renderAbsentList: function() {
        const list = document.getElementById('mh-absent-list');
        list.innerHTML = '';
        const { date, hour, classId } = this.tempModalData;
        
        // Najdi odsotne za to uro
        const absents = this.db.absences.filter(a => a.date === date && a.hour === hour && a.studentId && this.getStudentClass(a.studentId) === classId);
        
        absents.forEach(a => {
            const st = this.db.students.find(s => s.id === a.studentId);
            if(!st) return;
            
            const div = document.createElement('div');
            div.className = 'student-item';
            
            // Ime (rdeče bold) + ikona svinčnik
            div.innerHTML = `<span style="color:red; font-weight:bold;">${st.name}</span>
                             <div>
                                <span class="icon-edit" onclick="app.editAbsenceNote('${a.id}', '${st.name}')">✏️</span>
                                <button onclick="app.removeAbsence('${a.id}')" style="margin-left:5px;">X</button>
                             </div>`;
            list.appendChild(div);
        });
    },

    openStudentPicker: function() {
        this.renderPickerList();
        document.getElementById('modal-picker').style.display = 'block';
    },

    filterPicker: function() {
        const term = document.getElementById('picker-search').value.toLowerCase();
        this.renderPickerList(term);
    },

    renderPickerList: function(filter = '') {
        const { classId, date, hour } = this.tempModalData;
        const container = document.getElementById('picker-list');
        container.innerHTML = '';
        
        // Učenci razreda
        this.db.students.filter(s => s.classId === classId).forEach(s => {
            if(filter && !s.name.toLowerCase().includes(filter)) return;
            
            // Preveri če je že odsoten
            const isAbs = this.db.absences.some(a => a.date === date && a.hour === hour && a.studentId === s.id);
            if(isAbs) return;

            const div = document.createElement('div');
            div.style.padding = '5px';
            div.style.borderBottom = '1px solid #eee';
            div.style.cursor = 'pointer';
            div.innerText = s.name;
            div.onclick = () => {
                this.addAbsence(s.id);
                this.closeModal('modal-picker');
            };
            container.appendChild(div);
        });
    },

    addAbsence: function(sid) {
        const { date, hour } = this.tempModalData;
        this.db.absences.push({
            id: Date.now() + Math.random(),
            studentId: sid, date, hour, status: 'pending', note: ''
        });
        this.saveDB();
        this.renderAbsentList();
    },

    removeAbsence: function(aid) {
        this.db.absences = this.db.absences.filter(a => a.id !== aid);
        this.saveDB();
        this.renderAbsentList();
    },

    editAbsenceNote: function(aid, sname) {
        this.tempModalData.currentAbsId = aid;
        const abs = this.db.absences.find(a => a.id === aid);
        document.getElementById('mn-student-name').innerText = `Opomba za: ${sname}`;
        document.getElementById('mn-text').value = abs.note || '';
        document.getElementById('modal-note').style.display = 'block';
    },

    saveAbsenceNote: function() {
        const aid = this.tempModalData.currentAbsId;
        const txt = document.getElementById('mn-text').value;
        const abs = this.db.absences.find(a => a.id === aid);
        if(abs) abs.note = txt;
        this.saveDB();
        this.closeModal('modal-note');
    },

    saveHour: function() {
        const { date, hour, classId } = this.tempModalData;
        const content = document.getElementById('mh-content').value;
        
        // Update ali Insert Log
        const idx = this.db.hourLogs.findIndex(l => l.date === date && l.hour === hour && l.classId === classId);
        if(idx >= 0) {
            this.db.hourLogs[idx].content = content;
            this.db.hourLogs[idx].teacherId = this.user.id;
        } else {
            this.db.hourLogs.push({id: Date.now(), date, hour, classId, teacherId: this.user.id, content});
        }
        this.saveDB();
        this.closeModal('modal-hour');
    },

    // --- VIEW: OPRAVIČEVANJE (ATTENDANCE) ---
    renderAttendance: function(container) {
        this.renderDateSlider(container, () => this.refreshAttendanceTable());
        
        const controls = document.createElement('div');
        controls.innerHTML = `
            Razred: <select id="att-class-sel" onchange="app.currentState.classId=this.value; app.refreshAttendanceTable()"></select>
            Pogled: <select id="att-view-sel" onchange="app.currentState.viewMode=this.value; app.refreshAttendanceTable()">
                <option value="summary">Splošno</option>
                <option value="detailed">Podrobno</option>
            </select>
        `;
        container.appendChild(controls);
        
        const content = document.createElement('div');
        content.id = 'att-content';
        container.appendChild(content);

        // Populate Select
        const sel = document.getElementById('att-class-sel');
        sel.innerHTML = '<option value="">- Izberi -</option>';
        this.db.classes.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
    },

    refreshAttendanceTable: function() {
        const cid = this.currentState.classId;
        if(!cid) return;
        const div = document.getElementById('att-content');
        div.innerHTML = '';

        if(this.currentState.viewMode === 'summary') {
            this.renderAttSummary(div, cid);
        } else {
            this.renderAttDetailed(div, cid);
        }
    },

    renderAttSummary: function(div, cid) {
        let html = `<br><table class="retro-table"><tr><th>Učenec</th><th>Opravičene</th><th>Neopravičene</th><th>Čaka</th></tr>`;
        this.db.students.filter(s => s.classId === cid).forEach(s => {
            const abs = this.db.absences.filter(a => a.studentId === s.id);
            const exc = abs.filter(a => a.status === 'excused').length;
            const unexc = abs.filter(a => a.status === 'unexcused').length;
            const pend = abs.filter(a => a.status === 'pending').length;
            html += `<tr><td>${s.name}</td><td>${exc}</td><td>${unexc}</td><td>${pend}</td></tr>`;
        });
        div.innerHTML = html + "</table>";
    },

    renderAttDetailed: function(div, cid) {
        const dateKey = this.getDateKey(this.currentState.date);
        let html = `<br><h3>${dateKey}</h3><table class="retro-table">
            <tr><th style="width:200px;">Ime in priimek</th>`;
        for(let i=1; i<=9; i++) html += `<th>${i}.</th>`;
        html += `</tr>`;

        this.db.students.filter(s => s.classId === cid).forEach(s => {
            // Preveri če obstaja opomba kjerkoli ta dan
            const hasNote = this.db.absences.some(a => a.studentId === s.id && a.date === dateKey && a.note);
            const nameClass = hasNote ? 'has-note' : '';
            const nameClick = hasNote ? `onclick="alert('Opomba: ' + app.getNotesForDay('${s.id}', '${dateKey}'))"` : '';

            html += `<tr><td class="${nameClass}" ${nameClick}>${s.name}</td>`;
            for(let i=1; i<=9; i++) {
                html += `<td class="abs-grid-cell">${this.renderONX(s.id, dateKey, i)}</td>`;
            }
            html += `</tr>`;
        });
        div.innerHTML = html + "</table><p style='font-size:11px'>* Dvojni klik na ONX gumb uveljavi izbiro za cel dan.</p>";
    },

    renderONX: function(sid, date, hour) {
        const abs = this.db.absences.find(a => a.studentId === sid && a.date === date && a.hour === hour);
        let active = abs ? (abs.status === 'excused' ? 'O' : (abs.status === 'unexcused' ? 'N' : 'P')) : null;
        
        // Colors
        const cO = active === 'O' ? 'abs-green' : 'abs-none';
        const cN = active === 'N' ? 'abs-red' : 'abs-none';
        const cX = 'abs-none'; // X always clears

        return `
            <div class="btn-abs ${cO}" onclick="app.setAbsStatus('${sid}','${date}',${hour},'excused')" ondblclick="app.setAbsDay('${sid}','${date}','excused')">O</div>
            <div class="btn-abs ${cN}" onclick="app.setAbsStatus('${sid}','${date}',${hour},'unexcused')" ondblclick="app.setAbsDay('${sid}','${date}','unexcused')">N</div>
            <div class="btn-abs ${cX}" onclick="app.setAbsStatus('${sid}','${date}',${hour},'delete')" ondblclick="app.setAbsDay('${sid}','${date}','delete')">X</div>
        `;
    },

    setAbsStatus: function(sid, date, hour, action) {
        const idx = this.db.absences.findIndex(a => a.studentId === sid && a.date === date && a.hour === hour);
        if(action === 'delete') {
            if(idx >= 0) this.db.absences.splice(idx, 1);
        } else {
            if(idx >= 0) this.db.absences[idx].status = action;
            else this.db.absences.push({id: Date.now()+Math.random(), studentId: sid, date, hour, status: action, note: ''});
        }
        this.saveDB();
        this.refreshAttendanceTable();
    },

    setAbsDay: function(sid, date, action) {
        // Apply to all 1-9 hours
        for(let i=1; i<=9; i++) {
            // Samo če je že odsotnost zabeležena (logika: učitelj označi "X" ali "O" za cel dan manjkajočega)
            // Če želimo, da dvojni klik doda odsotnost tudi če je ni bilo, odstrani 'idx >= 0' check spodaj za add.
            // Navodilo pravi: "se vse ure za tisti dan za tistega dijaka (vse ure odsotnosti) obravnavajo"
            const idx = this.db.absences.findIndex(a => a.studentId === sid && a.date === date && a.hour === i);
            if(idx >= 0) {
                 this.setAbsStatus(sid, date, i, action);
            }
        }
    },

    getNotesForDay: function(sid, date) {
        return this.db.absences.filter(a => a.studentId === sid && a.date === date && a.note).map(a => `${a.hour}.ura: ${a.note}`).join('\n');
    },

    // --- VIEW: REDOVALNICA (GRADES) ---
    renderGrades: function(container) {
        container.innerHTML = `<h3>Redovalnica</h3>
        Razred: <select id="gr-cls" onchange="app.renderGradeTable()"><option value="">Izberi</option>${this.db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`)}</select>
        <div id="grade-table-cont"></div>`;
    },

    renderGradeTable: function() {
        const cid = document.getElementById('gr-cls').value;
        if(!cid) return;
        const div = document.getElementById('grade-table-cont');
        // Poenostavljeno: Učitelj vidi vse predmete za ta razred? Ali mora izbrati predmet?
        // Dodajmo izbiro predmeta.
        const subs = this.db.subjects.filter(s => s.classIds.includes(cid));
        if(subs.length === 0) { div.innerHTML = "Ni predmetov za ta razred."; return; }

        let html = `<br>Predmet: <select id="gr-sub" onchange="app.renderGradeGrid('${cid}')">
            <option value="">Izberi</option>${subs.map(s => `<option value="${s.id}">${s.name}</option>`)}
        </select><div id="gr-grid"></div>`;
        div.innerHTML = html;
    },

    renderGradeGrid: function(cid) {
        const sid = document.getElementById('gr-sub').value;
        if(!sid) return;
        const students = this.db.students.filter(s => s.classId === cid);
        
        let html = `<table class="retro-table"><tr><th>Učenec</th><th>1. Obd</th><th>2. Obd</th><th>Končna</th></tr>`;
        students.forEach(st => {
            html += `<tr><td>${st.name}</td>
                <td onclick="app.addGrade('${st.id}','${sid}',1)">${this.getGradesHtml(st.id, sid, 1)}</td>
                <td onclick="app.addGrade('${st.id}','${sid}',2)">${this.getGradesHtml(st.id, sid, 2)}</td>
                <td onclick="app.addGrade('${st.id}','${sid}',0)">${this.getGradesHtml(st.id, sid, 0)}</td></tr>`;
        });
        document.getElementById('gr-grid').innerHTML = html + "</table><p>Klikni na celico za vpis ocene.</p>";
    },

    getGradesHtml: function(stid, subid, p) {
        return this.db.grades.filter(g => g.studentId === stid && g.subjectId === subid && g.period === p)
            .map(g => `<span style="color:${g.type==='oral'?'black':(g.type==='product'?'blue':'red')}; font-weight:bold; margin-right:3px;">${g.value}</span>`)
            .join(' ');
    },

    addGrade: function(stid, subid, p) {
        const val = prompt("Vpiši oceno (1-5):");
        if(val) {
            const typeMap = {'P': 'written', 'U': 'oral', 'I': 'product'};
            const typeKey = prompt("Tip? P (Pisno), U (Ustno), I (Izdelek)").toUpperCase();
            const type = typeMap[typeKey] || 'oral';
            this.db.grades.push({id: Date.now(), studentId: stid, subjectId: subid, period: p, value: val, type});
            this.saveDB();
            this.renderGradeGrid(this.db.students.find(s=>s.id===stid).classId);
        }
    },

    // --- VIEW: ADMIN ---
    renderAdminTeachers: function(c) {
        c.innerHTML = `<h3>Učitelji</h3>
        Ime: <input id="nT-name"> User: <input id="nT-u"> Pass: <input id="nT-p"> Timeout(min): <input id="nT-t" value="30" style="width:30px">
        <button class="retro-btn" onclick="app.addTeacher()">Dodaj</button><hr>
        <ul id="t-list"></ul>`;
        this.refreshTeacherList();
    },
    addTeacher: function() {
        const n = document.getElementById('nT-name').value;
        const u = document.getElementById('nT-u').value;
        const p = document.getElementById('nT-p').value;
        const t = document.getElementById('nT-t').value;
        if(n && u && p) {
            this.db.users.push({id: Date.now(), name: n, username: u, password: p, role: 'teacher', sessionTime: parseInt(t)});
            this.saveDB(); this.refreshTeacherList();
        }
    },
    refreshTeacherList: function() {
        const ul = document.getElementById('t-list');
        ul.innerHTML = this.db.users.filter(u => u.role === 'teacher').map(u => `<li>${u.name} (${u.username}) <button onclick="app.delUser('${u.id}')">X</button></li>`).join('');
    },
    delUser: function(id) {
        this.db.users = this.db.users.filter(u => u.id != id);
        this.saveDB(); this.refreshTeacherList();
    },

    renderAdminClasses: function(c) {
        c.innerHTML = `<h3>Razredi</h3>
        Ime: <input id="nC-name" placeholder="1.A">
        <textarea id="nC-st" placeholder="Imena učencev (nova vrstica)"></textarea>
        <button class="retro-btn" onclick="app.addClass()">Ustvari</button><hr>
        <div id="c-list"></div>`;
        this.refreshClassList();
    },
    addClass: function() {
        const n = document.getElementById('nC-name').value;
        const stRaw = document.getElementById('nC-st').value;
        if(n) {
            const cid = 'c'+Date.now();
            this.db.classes.push({id: cid, name: n});
            stRaw.split('\n').forEach(line => {
                if(line.trim()) {
                    // Generiraj user/pass: ime priimek -> imepriimek (lowercase, csz)
                    const cleanName = line.trim();
                    let u = cleanName.toLowerCase().replace(/\s/g, '').replace(/č/g,'c').replace(/š/g,'s').replace(/ž/g,'z');
                    this.db.students.push({id: 's'+Math.random(), name: cleanName, classId: cid, user: u, pass: u});
                }
            });
            this.saveDB(); this.refreshClassList();
        }
    },
    refreshClassList: function() {
        document.getElementById('c-list').innerHTML = this.db.classes.map(c => `<b>${c.name}</b> (${this.db.students.filter(s=>s.classId===c.id).length} dijakov)<br>`).join('');
    },

    // --- VIEW: PROFIL ---
    renderProfile: function(c) {
        c.innerHTML = `<h3>Profil: ${this.user.name}</h3>
        <p>Uporabniško ime: <b>${this.user.username || this.user.user}</b></p>
        <p>Vloga: ${this.user.role}</p>
        <p>Spremeni geslo: <input type="password" id="new-pass"> <button class="retro-btn" onclick="app.changePass()">Spremeni</button></p>`;
    },
    changePass: function() {
        const np = document.getElementById('new-pass').value;
        if(np) {
            this.user.password = np; // za trenutno sejo
            this.user.pass = np; // za studenta
            // Save to DB
            if(this.user.role === 'student') {
                const s = this.db.students.find(x=>x.id===this.user.id);
                if(s) s.pass = np;
            } else {
                const u = this.db.users.find(x=>x.id===this.user.id);
                if(u) u.password = np;
            }
            this.saveDB(); alert("Geslo spremenjeno.");
        }
    },

    // --- UTILS ---
    getDateKey: function(dateObj) {
        const y = dateObj.getFullYear();
        const m = String(dateObj.getMonth() + 1).padStart(2, '0');
        const d = String(dateObj.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    },
    getStudentClass: function(sid) {
        const s = this.db.students.find(x => x.id === sid);
        return s ? s.classId : null;
    },
    closeModal: function(id) { document.getElementById(id).style.display = 'none'; }
};

// Zaženemo aplikacijo
app.init();

</script>
</body>
</html>
